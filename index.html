<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="./lib/ww/assets/school-messenger-logo.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; font-src 'self' data: https:; connect-src 'self' https:;">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=(), payment=()">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <meta name="theme-color" content="#24265c">
  
  <title>TFG's School Messenger</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="./lib/reg/register.css?v=1.1">
  <link rel="stylesheet" href="./lib/ww/styles.css?v=1.1">
  <link rel="stylesheet" href="./lib/ww/input-styles.css?v=1.1">
  <link rel="stylesheet" href="./lib/ww/cosmicParticles.css?v=1.1">
  <link rel="stylesheet" href="./lib/interface/styles.css?v=1.1">
  <link rel="stylesheet" href="./lib/interface/User%20Profiles/userProfile.css?v=1.1">
  <link rel="stylesheet" href="./lib/interface/Settings%20Menu/settingsMenu.css?v=1.1">
  <link rel="stylesheet" href="./lib/interface/Global%20Alerts/globalAlerts.css?v=1.1">
  <link rel="stylesheet" href="./lib/interface/Home%20Screen/HomeScreen.css?v=1.1">
  <link rel="stylesheet" href="./lib/interface/Context%20Menu/contextMenu.css?v=1.1">
  <link rel="stylesheet" href="./lib/interface/Banned%20Screen/bannedScreen.css?v=1.1">
  <link rel="stylesheet" href="./lib/ww/performance-optimizations.css?v=1.1">
  <script>
  // Function to show pending requests popup
  async function showPendingRequestsPopup() {
    console.log('showPendingRequestsPopup called');
    const pendingOverlay = document.getElementById('pendingOverlay');
    const pendingRequestsList = document.getElementById('pendingRequestsList');
    const pendingDebug = document.getElementById('pendingDebug');
    
    if (!pendingOverlay || !pendingRequestsList) {
      console.error('Required elements not found');
      return;
    }

    // Show the overlay
    pendingOverlay.style.display = 'flex';
    pendingOverlay.style.zIndex = '2000';
    pendingOverlay.style.position = 'fixed';
    pendingOverlay.style.top = '0';
    pendingOverlay.style.left = '0';
    pendingOverlay.style.right = '0';
    pendingOverlay.style.bottom = '0';
    pendingOverlay.style.background = 'rgba(0, 0, 0, 0.8)';
    pendingOverlay.style.backdropFilter = 'blur(20px)';
    pendingOverlay.style.alignItems = 'center';
    pendingOverlay.style.justifyContent = 'center';
    pendingOverlay.style.opacity = '0';
    pendingOverlay.style.transition = 'opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
    
    // Style the modal container
    const modal = pendingOverlay.querySelector('.popup-container');
    if (modal) {
      modal.style.background = 'linear-gradient(135deg, rgba(15, 15, 40, 0.95) 0%, rgba(25, 25, 60, 0.95) 100%)';
      modal.style.border = '1px solid rgba(124, 191, 255, 0.3)';
      modal.style.borderRadius = '24px';
      modal.style.boxShadow = '0 20px 60px rgba(0, 0, 0, 0.5), 0 0 40px rgba(88, 101, 242, 0.2)';
      modal.style.maxWidth = '500px';
      modal.style.width = '90%';
      modal.style.maxHeight = '80vh';
      modal.style.overflow = 'hidden';
      modal.style.position = 'relative';
    }
    
    // Find the content container (the form element)
    const contentContainer = pendingOverlay.querySelector('.pending-requests-container');
    
    // Style the header
    const header = pendingOverlay.querySelector('.cosmic-modal-header') || document.createElement('div');
    if (!pendingOverlay.querySelector('.cosmic-modal-header')) {
      header.className = 'cosmic-modal-header';
      header.innerHTML = `
        <h2 style="margin: 0; color: #7cf; font-size: 1.5em; font-weight: 700; text-shadow: 0 0 20px rgba(124, 191, 255, 0.6); text-align: center;">Friend Requests</h2>
        <button class="cosmic-close-btn" style="position: absolute; top: 20px; right: 20px; background: rgba(240, 71, 71, 0.2); border: 1px solid rgba(240, 71, 71, 0.4); border-radius: 50%; width: 36px; height: 36px; color: #f04747; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onclick="this.closest('#pendingOverlay').style.display='none'">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      `;
      if (contentContainer) {
        contentContainer.insertBefore(header, pendingRequestsList);
      }
    }
    
    // Style the content area
    pendingRequestsList.style.padding = '20px';
    pendingRequestsList.style.maxHeight = '60vh';
    pendingRequestsList.style.overflowY = 'auto';
    pendingRequestsList.style.scrollbarWidth = 'thin';
    pendingRequestsList.style.scrollbarColor = 'rgba(124, 191, 255, 0.3) transparent';
    
    // Fade in
    setTimeout(() => {
      pendingOverlay.style.opacity = '1';
    }, 10);
    
    // Show loading state
    pendingRequestsList.innerHTML = '<div style="text-align: center; padding: 40px 20px; color: #a0a8ff; font-size: 1.1em;"><div style="display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(124, 191, 255, 0.3); border-radius: 50%; border-top-color: #7cf; animation: spin 1s ease-in-out infinite; margin-bottom: 16px;"></div><br>Loading friend requests...</div>';
    
    // Show debug info
    if (pendingDebug) {
      pendingDebug.style.display = 'block';
      pendingDebug.textContent = 'Initializing...';
    }

    try {
      // Get UUID from the current user data
      const myUUID = window.currentUserData?.uuid;
      if (!myUUID) {
        const errorMsg = 'User not logged in or UUID not found';
        console.error(errorMsg);
        pendingRequestsList.innerHTML = `<div class="error-message">${errorMsg}</div>`;
        if (pendingDebug) {
          pendingDebug.textContent += `\n${errorMsg}`;
        }
        return;
      }

      console.log('PENDING BUTTON - Fetching friend requests with UUID:', myUUID);
      
      // Check if endpoint is defined
      if (typeof pendingFR === 'undefined') {
        const errorMsg = 'API endpoint for pending friend requests is not defined';
        console.error(errorMsg);
        pendingRequestsList.innerHTML = `<div class="error-message">${errorMsg}</div>`;
        if (pendingDebug) {
          pendingDebug.textContent += `\n${errorMsg}`;
        }
        return;
      }

      const url = `${pendingFR}?uuid=${encodeURIComponent(myUUID)}`;
      console.log('PENDING BUTTON - Endpoint URL:', url);

      // Make the API request
      const response = await fetch(url);
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const result = await response.json();
      console.log('PENDING BUTTON - Friend requests response:', result);
      
      if (pendingDebug) {
        pendingDebug.textContent += `\nResponse: ${JSON.stringify(result, null, 2)}`;
      }

      // Extract pending requests from the response
      let requests = [];
      if (result && result.status === 'success' && Array.isArray(result.pendingRequests)) {
        requests = result.pendingRequests;
        console.log('PENDING BUTTON - Pending requests array:', requests);
      } else if (Array.isArray(result)) {
        // Fallback for array response
        requests = result;
        console.log('PENDING BUTTON - Received array response:', requests);
      } else if (result && typeof result === 'object') {
        // Fallback for object response
        requests = Object.values(result).filter(val => typeof val === 'string');
        console.log('PENDING BUTTON - Extracted usernames from object:', requests);
      }
      
      console.log('Processed pending requests:', requests);

      // Hide the debug info
      if (pendingDebug) {
        pendingDebug.style.display = 'none';
      }

      // Update the UI with the list of pending requests
      if (requests.length > 0) {
        pendingRequestsList.innerHTML = requests.map((username, index) => `
          <div class="cosmic-request-item" style="display: flex; align-items: center; padding: 16px; margin-bottom: 12px; background: linear-gradient(135deg, rgba(15, 15, 40, 0.8) 0%, rgba(25, 25, 60, 0.8) 100%); border: 1px solid rgba(124, 191, 255, 0.2); border-radius: 16px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3), 0 0 20px rgba(88, 101, 242, 0.1); backdrop-filter: blur(10px); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden;">
            <!-- Cosmic glow effect -->
            <div style="position: absolute; top: -20px; right: -20px; width: 60px; height: 60px; background: radial-gradient(circle, rgba(124, 191, 255, 0.2) 0%, transparent 70%); border-radius: 50%; pointer-events: none;"></div>
            
            <!-- Avatar with cosmic styling -->
            <div style="position: relative; margin-right: 16px;">
              <img src="https://i.pravatar.cc/150?img=${index + 1}" alt="${username}" style="width: 48px; height: 48px; border-radius: 50%; border: 2px solid rgba(124, 191, 255, 0.4); box-shadow: 0 0 15px rgba(124, 191, 255, 0.3), 0 4px 8px rgba(0, 0, 0, 0.2); object-fit: cover;">
              <div style="position: absolute; bottom: -2px; right: -2px; width: 14px; height: 14px; background: linear-gradient(135deg, #43b581, #57f287); border: 2px solid rgba(15, 15, 40, 0.9); border-radius: 50%; box-shadow: 0 0 8px rgba(67, 181, 129, 0.4);"></div>
            </div>
            
            <!-- Username with cosmic text -->
            <div style="flex: 1; color: #e5eaff; font-weight: 500; font-size: 1em; text-shadow: 0 0 10px rgba(124, 191, 255, 0.5);">
              ${username}
            </div>
            
            <!-- Action buttons with cosmic styling -->
            <div style="display: flex; gap: 8px;">
              <button class="cosmic-accept-btn" data-username="${username}" style="padding: 8px 16px; background: linear-gradient(135deg, #43b581 0%, #57f287 100%); color: white; border: none; border-radius: 12px; font-size: 0.9em; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(67, 181, 129, 0.4); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; gap: 6px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(67, 181, 129, 0.6)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(67, 181, 129, 0.4)'">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Accept
              </button>
              <button class="cosmic-decline-btn" data-username="${username}" style="padding: 8px 16px; background: linear-gradient(135deg, #f04747 0%, #ed4245 100%); color: white; border: none; border-radius: 12px; font-size: 0.9em; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(240, 71, 71, 0.4); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; gap: 6px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(240, 71, 71, 0.6)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(240, 71, 71, 0.4)'">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Decline
              </button>
            </div>
          </div>
        `).join('');

        // Add event listeners to the new buttons
        document.querySelectorAll('.cosmic-accept-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const username = this.getAttribute('data-username');
            console.log('Accepting friend request from:', username);
            if (window.acceptFriendRequest) {
              window.acceptFriendRequest(username);
            } else {
              console.error('acceptFriendRequest function not found');
            }
          });
        });

        document.querySelectorAll('.cosmic-decline-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const username = this.getAttribute('data-username');
            console.log('Declining friend request from:', username);
            if (window.declineFriendRequest) {
              window.declineFriendRequest(username);
            } else {
              console.error('declineFriendRequest function not found');
            }
          });
        });
      } else {
        pendingRequestsList.innerHTML = '<div style="text-align: center; padding: 60px 20px; color: #a0a8ff; font-size: 1.1em;"><div style="font-size: 3em; margin-bottom: 16px; opacity: 0.6;">🌌</div>No pending friend requests</div>';
      }
      
    } catch (error) {
      console.error('Error fetching pending requests:', error);
      const errorMessage = error.message || 'Failed to load friend requests';
      pendingRequestsList.innerHTML = `<div style="text-align: center; padding: 40px 20px; color: #f04747; font-size: 1.1em; background: rgba(240, 71, 71, 0.1); border: 1px solid rgba(240, 71, 71, 0.3); border-radius: 12px; margin: 20px;"><div style="font-size: 2em; margin-bottom: 16px;">⚠️</div>${errorMessage}</div>`;
      
      if (pendingDebug) {
        pendingDebug.textContent += `\nError: ${errorMessage}\n${error.stack || ''}`;
      }
    } finally {
      // Ensure the overlay is still visible even if there was an error
      if (pendingOverlay) {
        pendingOverlay.style.display = 'flex';
      }
    }
  }
  </script>
  
  <script>
  // Global function to update home button state
  function updateHomeButtonState() {
    const homeButton = document.getElementById('homeButton');
    if (!homeButton) return;
    
    // Check which view is currently active
    const chatHomeView = document.getElementById('chatHomeView');
    const chatUserInfo = document.getElementById('chatUserInfo');
    
    const isHomeView = chatHomeView && window.getComputedStyle(chatHomeView).display !== 'none';
    window.currentScreen = isHomeView ? 'home' : 'dm';
    
    // Update button state
    if (window.currentScreen === 'home') {
      homeButton.setAttribute('disabled', 'disabled');
      if (chatUserInfo) chatUserInfo.style.display = 'none';
      if (chatHomeView) chatHomeView.style.display = 'flex';
    } else {
      homeButton.removeAttribute('disabled');
      if (chatHomeView) chatHomeView.style.display = 'none';
      if (chatUserInfo) chatUserInfo.style.display = 'flex';
    }
  }



  // Initialize window.currentScreen if not already set
  window.currentScreen = window.currentScreen || 'home';

  // --- Cosmic Settings Topbar Close Button Logic ---
  function showTopbarCloseBtn(show) {
    const btn = document.getElementById('topbarCloseSettingsBtn');
    const wrap = document.querySelector('.close-btn-vertical-wrap');
    if (btn) btn.style.display = show ? 'block' : 'none';
    if (wrap) wrap.style.display = show ? 'flex' : 'none';
    if (btn) btn.style.pointerEvents = show ? 'auto' : 'none';
  }
  function isSettingsSidebarOpen() {
    return document.querySelector('.settings-sidebar-slidein') !== null;
  }
  function closeSettingsModal() {
    // Remove the sidebar modal and restore home screen if needed
    const sidebar = document.querySelector('.settings-sidebar-slidein');
    if (sidebar) sidebar.remove();
    showTopbarCloseBtn(false);
    // Optionally, restore home screen or other UI if needed
    const homeScreen = document.getElementById('homeScreen') || document.querySelector('.home-screen');
    if (homeScreen) homeScreen.style.display = '';
  }
  // Show/hide close button when sidebar opens/closes
  document.addEventListener('DOMContentLoaded', function() {
    const observer = new MutationObserver(() => {
      showTopbarCloseBtn(isSettingsSidebarOpen());
    });
    if (document.body) {
      observer.observe(document.body, { childList: true, subtree: true });
    } else {
      console.error('document.body not found for MutationObserver.');
    }
  });
  // Button click
  document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('topbarCloseSettingsBtn');
    if (btn) btn.onclick = closeSettingsModal;
  });
  // Escape key or vertical close button closes settings
  function escOrVerticalCloseHandler() {
    if (typeof window.hideSettingsSidebar === 'function') {
      window.hideSettingsSidebar();
    } else {
      closeSettingsModal();
    }
  }
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && isSettingsSidebarOpen()) {
      escOrVerticalCloseHandler();
    }
  });
  // Vertical close button
  document.addEventListener('DOMContentLoaded', function() {
    var verticalBtn = document.getElementById('topbarCloseSettingsBtn');
    if (verticalBtn) {
      verticalBtn.onclick = escOrVerticalCloseHandler;
    }
  });
  
  // Minimal showAlert stub: delegate to Cosmic when ready, otherwise queue
  window.__alertQueue = window.__alertQueue || [];
  window.showAlert = (message, typeOrOptions = 'info', maybeOptions = {}) => {
    let t = 'info';
    let opts = {};
    if (typeOrOptions && typeof typeOrOptions === 'object') {
      opts = typeOrOptions || {};
      t = typeof opts.type === 'string' ? opts.type : 'info';
    } else {
      t = typeof typeOrOptions === 'string' ? typeOrOptions : 'info';
      opts = maybeOptions || {};
    }
    if (typeof window.__cosmicShowAlert === 'function') {
      return window.__cosmicShowAlert(message, t, opts);
    }
    try { window.__alertQueue.push({ message, type: t, options: opts }); } catch (_) {}
    return Promise.resolve(true);
  };
    </script>
    <script>
    // Utility: Only focus username if neither field is already focused
    function focusUsernameIfNoInputActive() {
  const usernameInput = document.getElementById('username');
  const passwordInput = document.getElementById('password');
  if (
    document.activeElement !== usernameInput &&
    document.activeElement !== passwordInput
  ) {
    usernameInput && usernameInput.focus();
  }
  }

// Create a more reliable debug logger
    window.debugLog = function(message) {
      console.log(message);
      // Also display in a debug div if available
      try {
        const debugDiv = document.getElementById('debugOutput');
        if (debugDiv) {
          const msgEl = document.createElement('div');
          msgEl.textContent = new Date().toLocaleTimeString() + ': ' + message;
          debugDiv.appendChild(msgEl);
          debugDiv.scrollTop = debugDiv.scrollHeight;
        }
      } catch (e) {}
    };
    
    // This will run as soon as the page loads
    debugLog('PAGE LOADED - CONSOLE TEST');
    console.log('%cWARNING: Attempting to "hack" this application can and will get you blacklisted.', 'font-weight:bold;font-size:1.1em;color:#f04747', '\n\n');
    window.addEventListener('DOMContentLoaded', function() {
      debugLog('DOM CONTENT LOADED - CONSOLE TEST');
    });
  </script>
</head>
<body>

  <div id="globalAlert" style="display:none;">
    <span id="alertMessage"></span>
    <button id="dismissGlobalAlertBtn" aria-label="Dismiss alert" style="background:none;border:none;color:#fff;font-size:2rem;cursor:pointer;margin-left:16px;line-height:1;">&times;</button>
  </div>
  <script>
    document.getElementById('dismissGlobalAlertBtn').addEventListener('click', e => {
      e.preventDefault();
      hideGlobalAlert();
    });
  </script>
  <div class="nebula"></div>
  <div class="stars" id="stars"></div>
  <div class="planets" id="planets"></div>
  <div id="cosmicParticles" class="cosmic-particles"></div>
  <div class="company-logo">
    <img src="./lib/ww/assets/raw2.png" id="companyLogo" style="width: 60px; height: 60px;">
    <span class="cosmic-text" id="companyText" style="margin-left: 10px;">The Floor Guys Co.</span>
  </div>

  <!-- quick copy and paste for the branding text and stuff, if you see this comment, i most likely forgot to remove it-->
  <!-- companyText, companyLogo, infoPopupBtn -->
  
  <!-- Clean Info Button -->
  <button id="infoPopupBtn" aria-label="App Info" class="info-btn">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
      <path d="M12 16V12M12 8H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </button>
  
  <style>
    /* Clean, performant info card styles */
    .info-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 3100;
      width: 48px;
      height: 48px;
      background: #1e213a;
      border: 2px solid #5865f2;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s;
      color: #7cf;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .info-btn:hover {
      transform: translateY(-2px);
      border-color: #7cf;
      box-shadow: 0 6px 20px rgba(88, 101, 242, 0.4);
    }
    
    .info-btn:active {
      transform: translateY(0);
    }
    
    #infoPopupOverlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 3200;
      background: rgba(10, 12, 30, 0.95);
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s;
      padding: 20px;
    }
    
    #infoPopupOverlay[data-state="open"] {
      display: flex;
      opacity: 1;
    }
    
    #infoPopupModal {
      background: #1a1c3a;
      border: 2px solid #2a2d4a;
      border-radius: 20px;
      width: 100%;
      max-width: 1000px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      transform: translateY(20px);
      opacity: 0;
      transition: transform 0.3s, opacity 0.3s;
    }
    
    #infoPopupOverlay[data-state="open"] #infoPopupModal {
      transform: translateY(0);
      opacity: 1;
    }
    
    .info-header {
      background: #5865f2;
      padding: 24px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 2px solid #4752c4;
    }
    
    .info-header-content {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .info-icon {
      width: 48px;
      height: 48px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }
    
    .info-title h1 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
    }
    
    .info-title p {
      margin: 4px 0 0;
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.8);
    }
    
    .info-close {
      width: 36px;
      height: 36px;
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, transform 0.2s;
    }
    
    .info-close:hover {
      background: rgba(0, 0, 0, 0.3);
      transform: scale(1.05);
    }
    
    .info-content {
      padding: 32px;
      overflow-y: auto;
      max-height: calc(90vh - 100px);
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }
    
    .info-card {
      background: #23254a;
      border: 1px solid #2a2d4a;
      border-radius: 12px;
      padding: 20px;
      transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s;
    }
    
    .info-card:hover {
      transform: translateY(-2px);
      border-color: #5865f2;
      box-shadow: 0 8px 24px rgba(88, 101, 242, 0.2);
    }
    
    .info-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .info-card-icon {
      width: 40px;
      height: 40px;
      background: #5865f2;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      flex-shrink: 0;
    }
    
    .info-card h3 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: #e0e6ff;
    }
    
    .info-card p {
      margin: 0;
      font-size: 0.95rem;
      line-height: 1.6;
      color: #b0b6d0;
    }
    
    .info-card ul {
      margin: 8px 0 0;
      padding-left: 20px;
      color: #b0b6d0;
      font-size: 0.95rem;
      line-height: 1.8;
    }
    
    .contact-card {
      background: #23254a;
      border: 1px solid #2a2d4a;
      border-radius: 12px;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 16px;
      text-decoration: none;
      color: inherit;
      transition: transform 0.2s, border-color 0.2s, background 0.2s;
    }
    
    .contact-card:hover {
      transform: translateY(-2px);
      border-color: #5865f2;
      background: #2a2d50;
    }
    
    .contact-icon {
      width: 48px;
      height: 48px;
      background: #5865f2;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      flex-shrink: 0;
    }
    
    .contact-info h4 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
      color: #e0e6ff;
    }
    
    .contact-info p {
      margin: 4px 0 0;
      font-size: 0.9rem;
      color: #7cf;
    }
    
    .contact-arrow {
      margin-left: auto;
      color: #7cf;
      opacity: 0.6;
      transition: transform 0.2s, opacity 0.2s;
    }
    
    .contact-card:hover .contact-arrow {
      transform: translateX(4px);
      opacity: 1;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .info-header {
        padding: 20px 24px;
      }
      
      .info-content {
        padding: 24px;
      }
      
      .info-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .info-title h1 {
        font-size: 1.25rem;
      }
    }
    
    @media (max-width: 480px) {
      .info-btn {
        width: 44px;
        height: 44px;
      }
      
      .info-header {
        padding: 16px 20px;
      }
      
      .info-content {
        padding: 20px;
      }
      
      .info-icon {
        width: 40px;
        height: 40px;
      }
      
      .info-title h1 {
        font-size: 1.1rem;
      }
    }
  </style>

  <!-- Brand New Info Modal -->
  <div id="infoPopupOverlay" tabindex="-1" aria-modal="true" role="dialog" aria-hidden="true">
    <div id="infoPopupModal">
      <!-- Header -->
      <div class="info-header">
        <div class="info-header-content">
          <div class="info-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
              <path d="M12 16V12M12 8H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div class="info-title">
            <h1>School Messenger</h1>
            <p>Version 0.6 • Student Communication Platform</p>
          </div>
        </div>
        <button id="infoPopupClose" class="info-close" aria-label="Close">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <!-- Content -->
      <div class="info-content">
        <!-- Info Cards Grid -->
        <div class="info-grid">
          <div class="info-card">
            <div class="info-card-header">
              <div class="info-card-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                  <path d="M12 16V12M12 8H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </div>
              <h3>About</h3>
            </div>
            <p>A secure communication platform designed for students and classmates, prioritizing privacy, reliability, and ease of use.</p>
          </div>

          <div class="info-card">
            <div class="info-card-header">
              <div class="info-card-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </div>
              <h3>Quick Tips</h3>
            </div>
            <ul>
              <li>Use your account credentials to log in</li>
              <li>Ensure your device is whitelisted for access</li>
              <li>Contact support if you encounter any issues</li>
              <li>Keep your login details secure</li>
            </ul>
          </div>

          <div class="info-card">
            <div class="info-card-header">
              <div class="info-card-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
              <h3>Features</h3>
            </div>
            <ul>
              <li>Real-time messaging</li>
              <li>Friend system</li>
              <li>Global announcements</li>
              <li>Secure authentication</li>
            </ul>
          </div>
        </div>

        <!-- Contact Section -->
        <div style="margin-top: 32px;">
          <h2 style="font-size: 1.25rem; font-weight: 600; color: #e0e6ff; margin: 0 0 16px;">Get Support</h2>
          <div style="display: grid; gap: 12px;">
            <a href="mailto:raymonds@students.hcboe.net" class="contact-card">
              <div class="contact-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M4 4H20C21.1 4 22 4.9 22 6V18C22 19.1 21.1 20 20 20H4C2.9 20 2 19.1 2 18V6C2 4.9 2.9 4 4 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M22 6L12 13L2 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
              <div class="contact-info">
                <h4>Sam R.</h4>
                <p>raymonds@students.hcboe.net</p>
              </div>
              <div class="contact-arrow">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </div>
            </a>

            <a href="mailto:mcgahaj2@students.hcboe.net" class="contact-card">
              <div class="contact-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M4 4H20C21.1 4 22 4.9 22 6V18C22 19.1 21.1 20 20 20H4C2.9 20 2 19.1 2 18V6C2 4.9 2.9 4 4 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M22 6L12 13L2 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
              <div class="contact-info">
                <h4>James M.</h4>
                <p>mcgahaj2@students.hcboe.net</p>
              </div>
              <div class="contact-arrow">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </div>
            </a>

            <a href="https://discord.gg/tuC26HVjSn" target="_blank" rel="noopener noreferrer" class="contact-card">
              <div class="contact-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M21 11.5C21 16.75 16.75 21 11.5 21C6.25 21 2 16.75 2 11.5C2 6.25 6.25 2 11.5 2C16.75 2 21 6.25 21 11.5Z" stroke="currentColor" stroke-width="2"/>
                  <path d="M22 22L20 20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </div>
              <div class="contact-info">
                <h4>Discord Community</h4>
                <p>Join our tester server</p>
              </div>
              <div class="contact-arrow">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </div>
            </a>
          </div>
        </div>

        <!-- Footer -->
        <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid #2a2d4a; text-align: center;">
          <p style="margin: 0; color: #7a7d9a; font-size: 0.9rem;">
            Developed with ❤️ by <span class="cosmic-text">The Floor Guys Co.</span>
          </p>
          <p style="margin: 8px 0 0; color: #5a5d7a; font-size: 0.85rem;">© 2025 All Rights Reserved</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Wait for the DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Modern Info Popup logic with animations
      const infoBtn = document.getElementById('infoPopupBtn');
      const infoOverlay = document.getElementById('infoPopupOverlay');
      const infoModal = document.getElementById('infoPopupModal');
      const infoClose = document.getElementById('infoPopupClose');
      
      // Function to show the popup with animations
      function showInfoPopup() {
        if (!infoOverlay || !infoModal) return;

        // Remove aria-hidden from overlay and modal
        infoOverlay.removeAttribute('aria-hidden');
        infoModal.removeAttribute('aria-hidden');
        infoModal.setAttribute('aria-modal', 'true');

        // Show overlay
        infoOverlay.setAttribute('data-closing', 'false');
        infoOverlay.style.display = 'flex';
        infoOverlay.style.zIndex = '3200';
        void infoOverlay.offsetHeight;
        infoOverlay.style.pointerEvents = 'auto';
        infoOverlay.style.opacity = '1';

        // Animate in the modal
        infoModal.style.opacity = '1';
        infoModal.style.transform = 'translateY(0)';
        infoModal.setAttribute('data-state', 'open');

        // Focus the close button for accessibility
        var closeBtn = infoModal.querySelector('#infoPopupClose');
        if (closeBtn) closeBtn.focus();

        // Prevent background scrolling
        document.body.style.overflow = 'hidden';
      }

      // Function to hide the popup and restore accessibility state
      function hideInfoPopup() {
        if (!infoOverlay || !infoModal) return;
        // Prevent multiple hide attempts
        if (infoOverlay.getAttribute('data-closing') === 'true') return;
        infoOverlay.setAttribute('data-closing', 'true');
        
        // Disable pointer events during close animation
        infoOverlay.style.pointerEvents = 'none';
        
        // Animate out
        infoOverlay.style.opacity = '0';
        infoModal.style.opacity = '0';
        infoModal.style.transform = 'translateY(20px)';
        
        // Remove focus from close button before hiding from assistive tech
        var closeBtn = infoModal.querySelector('#infoPopupClose');
        if (closeBtn && document.activeElement === closeBtn) {
          closeBtn.blur();
        }
        // Remove aria-modal immediately, but delay aria-hidden until after animation
        infoModal.removeAttribute('aria-modal');
        
        // Wait for the transition to complete before hiding
        setTimeout(() => {
          if (infoOverlay.style.opacity === '0') {
            // Hide the overlay and reset styles
            infoOverlay.style.display = 'none';
            infoOverlay.style.zIndex = '-1';
            infoOverlay.setAttribute('aria-hidden', 'true');
            
            // Enable pointer events for next open
            infoOverlay.style.pointerEvents = 'auto';
            infoOverlay.setAttribute('data-closing', 'false');
            
            // Re-enable body scrolling
            document.body.style.overflow = '';
            
            // Remove the open state
            infoModal.removeAttribute('data-state');
            
            // Return focus to the button that opened the modal
            const infoBtn = document.getElementById('infoPopupBtn');
            if (infoBtn) infoBtn.focus();
          }
        }, 300); // Match the CSS transition duration
      }
      
      // Initialize the popup if all required elements exist
      if (infoBtn && infoOverlay && infoModal && infoClose) {
        // Show popup when clicking the info button
        infoBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          showInfoPopup();
        });
        
        // Close button click handler
        infoClose.addEventListener('click', (e) => {
          e.stopPropagation();
          hideInfoPopup();
        });
        
        // Close when clicking outside the modal
        infoOverlay.addEventListener('click', (e) => {
          if (e.target === infoOverlay) {
            hideInfoPopup();
          }
        });
        
        // Close with Escape key
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && infoOverlay.style.display === 'flex') {
            hideInfoPopup();
          }
        });
        
        // Enhanced close button with smooth transitions and better hover effects
        if (infoClose) {
          infoClose.style.transition = 'all 0.3s cubic-bezier(0.2, 0.8, 0.4, 1)';
          infoClose.style.width = '36px';
          infoClose.style.height = '36px';
          infoClose.style.display = 'flex';
          infoClose.style.alignItems = 'center';
          infoClose.style.justifyContent = 'center';
          infoClose.style.borderRadius = '50%';
          infoClose.style.background = 'rgba(0, 0, 0, 0.15)';
          infoClose.style.border = '1px solid rgba(255, 255, 255, 0.1)';
          
          infoClose.addEventListener('mouseenter', () => {
            infoClose.style.background = 'rgba(255, 71, 87, 0.2)';
            infoClose.style.transform = 'rotate(90deg) scale(1.1)';
            infoClose.style.borderColor = 'rgba(255, 71, 87, 0.3)';
            infoClose.style.boxShadow = '0 0 0 4px rgba(255, 71, 87, 0.1)';
          });
          
          infoClose.addEventListener('mouseleave', () => {
            infoClose.style.background = 'rgba(0, 0, 0, 0.15)';
            infoClose.style.transform = 'rotate(0deg) scale(1)';
            infoClose.style.borderColor = 'rgba(255, 255, 255, 0.1)';
            infoClose.style.boxShadow = 'none';
          });
          
          // Add a subtle pulse animation on first hover
          let hasHovered = false;
          const firstHover = () => {
            if (!hasHovered) {
              hasHovered = true;
              setTimeout(() => {
                infoClose.style.transform = 'scale(1.2)';
                setTimeout(() => {
                  infoClose.style.transform = 'scale(1)';
                }, 150);
              }, 300);
            }
          };
          infoClose.addEventListener('mouseenter', firstHover, { once: true });
        }
        
        // Make links more interactive
        const infoLinks = infoModal.querySelectorAll('a');
        infoLinks.forEach(link => {
          link.addEventListener('mouseenter', () => {
            link.style.transform = 'translateX(4px)';
          });
          
          link.addEventListener('mouseleave', () => {
            link.style.transform = 'translateX(0)';
          });
        });
        
        // Make sure the popup is hidden by default
        infoOverlay.style.display = 'none';
        
        // Only manage info popup visibility based on login form state
        function monitorLoginFormDisplay() {
          const loginForm = document.getElementById('loginForm');
          if (!loginForm) return;
          
          // Initial check
          if (loginForm.style.display === 'none') {
            hideInfoPopup();
          } else {
            infoOverlay.style.display = 'flex';
          }
          
          // Set up observer for future changes
          const observer = new MutationObserver(() => {
            if (loginForm.style.display === 'none') {
              hideInfoPopup();
            } else {
              infoOverlay.style.display = 'flex';
            }
          });
          observer.observe(loginForm, { 
            attributes: true, 
            attributeFilter: ['style'],
            childList: false,
            subtree: false
          });
          
          // Clean up observer when the page is unloaded
          window.addEventListener('beforeunload', () => {
            observer.disconnect();
          });
        }
        
        // Start monitoring login form
        monitorLoginFormDisplay();
      }
    });
  </script>

  <!-- Contact Form Overlay -->
  <div id="contactOverlay" class="contact-overlay">
    <div class="contact-content">
      <div class="contact-header">
        <h3>Contact Support</h3>
        <button class="close-button" onclick="hideContact()" aria-label="Close contact form">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <form id="contactForm" onsubmit="event.preventDefault(); sendContactEmail();">
        <div class="input-group">
          <label for="contactSubject">Subject</label>
          <input 
            type="text" 
            id="contactSubject" 
            placeholder="How can we help?"
            required
            aria-required="true"
          >
        </div>
        
        <div class="input-group">
          <label for="contactMessage">Message</label>
          <textarea 
            id="contactMessage" 
            placeholder="Please describe your issue or question in detail..."
            required
            aria-required="true"
            rows="5"
          ></textarea>
        </div>
        
        <div class="contact-actions">
          <button type="submit" class="btn-primary">
            <i class="fas fa-paper-plane"></i> Send Message
          </button>
          <button type="button" class="btn-secondary" onclick="hideContact()">
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>
      </form>
      
      <div class="contact-footer">
        <p>We'll get back to you as soon as possible.</p>
      </div>
    </div>
  </div>
  <!-- Forgot Password Overlay -->
  <div id="forgotPasswordOverlay" class="forgot-password-overlay">
    <div class="forgot-password-container forgot-password-modal">
      <div class="forgot-password-header">
        <i class="fas fa-key"></i>
        <h2>Reset Your Password</h2>
        <p class="forgot-password-subtitle">Enter your email to receive a password reset link</p>
      </div>
      
      <form id="forgotPasswordForm" class="forgot-password-form" onsubmit="event.preventDefault(); handleForgotPassword();">
        <div class="form-group">
          <div class="input-with-icon">
            <i class="fas fa-envelope"></i>
            <input type="email" id="forgotEmail" placeholder="Enter your email" required>
          </div>
        </div>
        
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-paper-plane"></i> Send Reset Link
          </button>
          <button type="button" class="btn btn-secondary" onclick="hideForgotPassword()">
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>
      </form>
      
      <div class="forgot-password-footer">
        <p>Remember your password? <a href="#" onclick="event.preventDefault(); hideForgotPassword();">Back to Login</a></p>
        <p>Need help? <a href="#" onclick="event.preventDefault(); hideForgotPassword(); showContact();">Contact Support</a></p>
      </div>
    </div>
  </div>
<div id="passwordContainer">
  <!-- Login Form -->
  <div id="loginForm">
    <form onsubmit="event.preventDefault(); event.stopPropagation(); if (window.handleLoginWithLogin) { window.handleLoginWithLogin(); } else { console.error('Login function not loaded'); } return false;">
      <div class="password-box">
        <div class="app-logo">
          <img src="./lib/ww/assets/school-messenger-logo.png" alt="School Messenger Logo" style="width: 160px !important; height: 160px !important; max-width: 160px !important; max-height: 160px !important; object-fit: contain !important;">
          <h2 id="appTitle" style="font-size: 1.6em !important; margin-bottom: 30px;">School Messenger</h2>
        </div>
        
        <!-- Username Input -->
        <div class="input-group">
          <input type="text" id="username" placeholder=" " required autocomplete="username">
          <label for="username">USERNAME</label>
          <div class="error-message"></div>
        </div>
        
        <!-- Password Input -->
        <div class="input-group">
          <input type="password" id="password" placeholder=" " required autocomplete="current-password">
          <label for="password">PASSWORD</label>
          <div class="error-message"></div>
        </div>
        
        <div class="forgot-password-container" id="forgotPasswordContainer">
          <a href="#" class="forgot-password" onclick="event.preventDefault(); showForgotPassword(); return false;">
            <i class="fas fa-key" style="margin-right: 6px; font-size: 0.8em;"></i>
            <span>Forgot your password?</span>
          </a>
        </div>
        
        <button type="submit" id="loginButton" style="width: 100%; padding: 14px; background: #5865f2; color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; margin-top: 10px; transition: all 0.2s ease; box-shadow: 0 4px 12px -4px rgba(88, 101, 242, 0.3);">
          Log In
        </button>
        
        <div class="register" style="text-align: center; margin-top: 20px; color: #a0a8ff; font-size: 0.9em;">
          Need an account? 
          <a href="#" onclick="event.preventDefault(); showRegister(); return false;" style="color: #7cdfff; text-decoration: none; font-weight: 600; transition: color 0.2s ease;">
            Register
          </a>
        </div>
      </div>
    </form>
  </div>
  
  <!-- Register Form -->
  <form id="registerForm" style="display: none;" onsubmit="event.preventDefault(); event.stopPropagation(); if (window.handleRegisterWithLoading) { window.handleRegisterWithLoading(); } else { console.error('Register function not loaded'); } return false;">
    <div class="password-box">
      <div class="app-logo">
        <img src="./lib/ww/assets/school-messenger-logo.png" alt="School Messenger Logo" style="width: 160px !important; height: 160px !important; max-width: 160px !important; max-height: 160px !important; object-fit: contain !important;">
        <h2 id="appTitle" style="font-size: 1.6em !important; margin-bottom: 20px;">Create Account</h2>
      </div>
      
      <!-- Username Input -->
      <div class="input-group">
        <input type="text" id="registerUsername" placeholder=" " required autocomplete="username">
        <label for="registerUsername">USERNAME</label>
        <div class="error-message" id="usernameError"></div>
      </div>
      
      <!-- Email Input -->
      <div class="input-group">
        <input type="email" id="registerGmail" placeholder=" " required autocomplete="email">
        <label for="registerGmail">EMAIL</label>
        <div class="gmail-icon"></div>
        <div class="error-message" id="emailError"></div>
      </div>
      
      <!-- Password Input -->
      <div class="input-group">
        <input type="password" id="registerPassword" placeholder=" " required autocomplete="new-password">
        <label for="registerPassword">PASSWORD</label>
        <div class="error-message" id="passwordError"></div>
      </div>
      
      <!-- Confirm Password Input -->
      <div class="input-group">
        <input type="password" id="confirmPassword" placeholder=" " required autocomplete="new-password">
        <label for="confirmPassword">CONFIRM PASSWORD</label>
        <div class="error-message" id="confirmPasswordError"></div>
      </div>
      
      <button type="button" onclick="handleRegisterWithLoading()" style="width: 100%; padding: 14px; background: #5865f2; color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; margin-top: 10px; transition: all 0.2s ease; box-shadow: 0 4px 12px -4px rgba(88, 101, 242, 0.3);">
        Create Account
      </button>
      
      <div class="register" style="text-align: center; margin-top: 20px; color: #a0a8ff; font-size: 0.9em;">
        Already have an account? 
        <a href="#" onclick="event.preventDefault(); showLogin(); return false;" style="color: #7cdfff; text-decoration: none; font-weight: 600; transition: color 0.2s ease;">
          Log In
        </a>
      </div>
      <!-- Verification Form (initially hidden) -->
      <div id="verificationForm" style="display: none; width: 100%;">
        <h3 style="color: #fff; margin-bottom: 25px; text-align: center; width: 100%;">Enter Verification Code</h3>
        <p style="color: #a0a8ff; text-align: center; margin-bottom: 25px; font-size: 0.9em;">
          We've sent a 6-digit code to your email. Please enter it below.
        </p>
        
        <div class="verification-code" style="display: flex; justify-content: center; gap: 10px; margin-bottom: 25px;">
          <input type="text" maxlength="1" class="verification-input" id="code1" inputmode="numeric" pattern="[0-9]*" autocomplete="one-time-code" style="
            width: 45px;
            height: 60px;
            border: 2px solid #4a4a6a;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            text-align: center;
            font-size: 24px;
            -webkit-appearance: none;
            -moz-appearance: textfield;
            appearance: textfield;
            outline: none;
            transition: all 0.2s ease;
          ">
          <input type="text" maxlength="1" class="verification-input" id="code2" inputmode="numeric" pattern="[0-9]*" autocomplete="one-time-code" style="
            width: 45px;
            height: 60px;
            border: 2px solid #4a4a6a;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            text-align: center;
            font-size: 24px;
            -webkit-appearance: none;
            -moz-appearance: textfield;
            appearance: textfield;
            outline: none;
            transition: all 0.2s ease;
          ">
          <input type="text" maxlength="1" class="verification-input" id="code3" inputmode="numeric" pattern="[0-9]*" autocomplete="one-time-code" style="
            width: 45px;
            height: 60px;
            border: 2px solid #4a4a6a;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            text-align: center;
            font-size: 24px;
            -webkit-appearance: none;
            -moz-appearance: textfield;
            appearance: textfield;
            outline: none;
            transition: all 0.2s ease;
          ">
          <span style="color: #a0a8ff; font-size: 24px; line-height: 60px; margin: 0 2px;">-</span>
          <input type="text" maxlength="1" class="verification-input" id="code4" inputmode="numeric" pattern="[0-9]*" autocomplete="one-time-code" style="
            width: 45px;
            height: 60px;
            border: 2px solid #4a4a6a;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            text-align: center;
            font-size: 24px;
            -webkit-appearance: none;
            -moz-appearance: textfield;
            appearance: textfield;
            outline: none;
            transition: all 0.2s ease;
          ">
          <input type="text" maxlength="1" class="verification-input" id="code5" inputmode="numeric" pattern="[0-9]*" autocomplete="one-time-code" style="
            width: 45px;
            height: 60px;
            border: 2px solid #4a4a6a;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            text-align: center;
            font-size: 24px;
            -webkit-appearance: none;
            -moz-appearance: textfield;
            appearance: textfield;
            outline: none;
            transition: all 0.2s ease;
          ">
          <input type="text" maxlength="1" class="verification-input" id="code6" inputmode="numeric" pattern="[0-9]*" autocomplete="one-time-code" style="
            width: 45px;
            height: 60px;
            border: 2px solid #4a4a6a;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            text-align: center;
            font-size: 24px;
            -webkit-appearance: none;
            -moz-appearance: textfield;
            appearance: textfield;
            outline: none;
            transition: all 0.2s ease;
          ">
        </div>
        
        <div class="verification-buttons" style="display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 20px; width: 100%;">
          <button type="button" onclick="return goBackToRegister(event)" style="
            background: transparent;
            color: #a0a8ff;
            border: 1px solid #4a4a6a;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s ease;
            width: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
          ">
            Back
          </button>
          <button type="button" onclick="submitVerificationCode()" style="
            background: #5865f2;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px -4px rgba(88, 101, 242, 0.3);
          ">
            Verify Account
          </button>
        </div>
        
        <p id="verificationMessage" style="
          color: #ff6b6b;
          text-align: center;
          margin-top: 20px;
          font-size: 0.9em;
          min-height: 20px;
        "></p>
        
        <p style="color: #a0a8ff; text-align: center; margin-top: 25px; font-size: 0.85em;">
          Didn't receive a code? 
          <a href="#" onclick="event.preventDefault(); resendVerificationCode();" style="color: #7cdfff; text-decoration: none; font-weight: 500;">
            Resend Code
          </a>
        </p>
      </div>
      <div id="message"></div>
    </div>
    </form>
  </div>

  <!-- Messaging Area -->
  <div id="settingsModalOverlay" style="display:none !important;"></div>
  <div id="messagingContainer" style="display: none;">
    <div class="messaging-wrapper">
      <div class="sidebar">
        <div class="sidebar-nav">
          <div class="nav-top-buttons">

            <div class="search-bar">
              <div class="search-bar-container">
                <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M21 21L16.65 16.65M19 11C19 15.4183 15.4183 19 11 19C6.58172 19 3 15.4183 3 11C3 6.58172 6.58172 3 11 3C15.4183 3 19 6.58172 19 11Z" stroke="#72767d" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <input type="text" id="dmSearchInput" placeholder="Find a conversation" autocomplete="off">
              </div>
            </div>
          </div>

  <div id="navButtons" class="nav-buttons">
    <button id="homeButton" class="home-button nav-btn active" title="Home">
  <svg class="nav-icon" width="32" height="32" viewBox="0 0 40 40" fill="none" aria-label="Home" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <radialGradient id="homeGlow3" cx="50%" cy="60%" r="70%">
        <stop offset="0%" stop-color="#7cf" stop-opacity="0.85"/>
        <stop offset="100%" stop-color="#10153c" stop-opacity="0.18"/>
      </radialGradient>
      <linearGradient id="roofGradient2" x1="0" y1="0" x2="40" y2="0" gradientUnits="userSpaceOnUse">
        <stop stop-color="#7cf" stop-opacity="0.7"/>
        <stop offset="1" stop-color="#5865f2" stop-opacity="0.6"/>
      </linearGradient>
    </defs>
    <ellipse cx="20" cy="33.5" rx="13" ry="4.5" fill="url(#homeGlow3)" opacity="0.85"/>
    <rect x="10" y="22" width="20" height="12" rx="3.5" fill="#10153c" stroke="#7cf" stroke-width="1.7"/>
    <rect x="17.2" y="29" width="5.6" height="5.5" rx="1.4" fill="#7cf" fill-opacity="0.7"/>
    <polygon points="7,22 20,8 33,22" fill="url(#roofGradient2)" stroke="#7cf" stroke-width="2.1"/>
    <rect x="19" y="22.7" width="2.2" height="7.2" rx="0.8" fill="#7cf" fill-opacity="0.18"/>
  </svg>
  <span class="nav-label">Home</span>
</button>

    <button id="homeAddFriendBtn" class="nav-btn" title="Friends">
  <svg class="nav-icon" width="32" height="32" viewBox="0 0 40 40" fill="none" aria-label="Friends" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <radialGradient id="friendsGlow2" cx="50%" cy="65%" r="70%">
        <stop offset="0%" stop-color="#7cf" stop-opacity="0.7"/>
        <stop offset="100%" stop-color="#5865f2" stop-opacity="0.13"/>
      </radialGradient>
    </defs>
    <ellipse cx="20" cy="34" rx="13" ry="4.5" fill="url(#friendsGlow2)" opacity="0.85"/>
    <circle cx="15.5" cy="19" r="6" fill="rgba(255,255,255,0.06)" stroke="#7cf" stroke-width="1.6"/>
    <ellipse cx="15.5" cy="27" rx="6.3" ry="2.7" fill="rgba(255,255,255,0.06)" stroke="#7cf" stroke-width="1"/>
    <circle cx="25" cy="15.5" r="4.3" fill="rgba(255,255,255,0.06)" stroke="#7cf" stroke-width="1.2"/>
    <ellipse cx="25" cy="21.7" rx="4.8" ry="1.9" fill="rgba(255,255,255,0.06)" stroke="#7cf" stroke-width="0.9"/>
    <path d="M18.5 15 Q20 12 24 15" stroke="#7cf" stroke-width="1.1" fill="none"/>
    <ellipse cx="15.5" cy="19" rx="7.5" ry="2.5" fill="#7cf" fill-opacity="0.13"/>
    <ellipse cx="25" cy="15.5" rx="5.5" ry="1.5" fill="#7cf" fill-opacity="0.09"/>
  </svg>
  <span id="pendingCount" class="badge" style="display:none;"></span>
  <span class="nav-label">Friends</span>
</button>
  </div>
          <div class="nav-section">
            <h3>Direct Messages</h3>
            <ul class="dm-list">
  <!-- Direct message contacts will appear here when added -->
</ul>
<style>
  .dm-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .dm-user {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.15s;
  }
  .dm-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 2px solid #36393f;
    object-fit: cover;
  }
  .dm-name {
    flex: 1;
    font-weight: 500;
    color: #e0e6f3;
    font-size: 1rem;
    letter-spacing: 0.01em;
  }
  .user-badge {
    margin-left: 4px;
    font-size: 18px;
    vertical-align: middle;
  }
  .dm-user .avatar-status-wrapper {
    display: flex;
    align-items: center;
    position: relative;
    min-width: 38px;
    min-height: 38px;
  }
  .chat-user-info {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 12px 20px;
    border-radius: 8px 8px 0 0;
    margin-bottom: 0;
  }
  .chat-user-info .user-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: 2px solid #36393f;
    object-fit: cover;
  }
  .chat-user-info .user-details {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .chat-user-info .username {
    font-size: 1.1rem;
    color: #fff;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .chat-user-info .status-dot {
    margin-right: 2px;
  }
  .chat-user-info .user-badge {
    font-size: 20px;
  }
</style>
          </div>
        </div>
        <div class="sidebar-footer">
          <div class="sidebar-footer-inner">
            <div class="sidebar-footer-clickable">
              <img class="user-avatar" src="https://i.pravatar.cc/150?img=4" alt="Your Avatar">
              <div class="user-details">
                <span class="username" id="sidebarProfileUsername">YourUsername</span>
                <span class="status online">Online</span>
              </div>
            </div>
            <!-- (Removed duplicate close button markup from sidebar/footer area. Only keeping the one in chat-topbar.) -->
<!-- Settings button remains here, but NOT the close button markup. -->
<button class="icon-button settings-button" title="User Settings" id="openUserSettingsBtn">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="#B9BBBE" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M19.4 15C19.2669 15.3016 19.2272 15.6362 19.286 15.9606C19.3448 16.285 19.4995 16.5843 19.73 16.82L19.79 16.88C19.976 17.0657 20.1235 17.2863 20.2241 17.5291C20.3248 17.7719 20.3766 18.0322 20.3766 18.295C20.3766 18.5578 20.3248 18.8181 20.2241 19.0609C20.1235 19.3037 19.976 19.5243 19.79 19.71C19.6043 19.896 19.3837 20.0435 19.1409 20.1441C18.8981 20.2448 18.6378 20.2966 18.375 20.2966C18.1122 20.2966 17.8519 20.2448 17.6091 20.1441C17.3663 20.0435 17.1457 19.896 16.96 19.71L16.9 19.65C16.6643 19.4195 16.365 19.2648 16.0406 19.206C15.7162 19.1472 15.3816 19.1869 15.08 19.32C14.7842 19.4468 14.532 19.6572 14.3543 19.9255C14.1766 20.1938 14.0813 20.5082 14.08 20.83V21C14.08 21.5304 13.8693 22.0391 13.4942 22.4142C13.1191 22.7893 12.6104 23 12.08 23C11.5496 23 11.0409 22.7893 10.6658 22.4142C10.2907 22.0391 10.08 21.5304 10.08 21V20.91C10.0723 20.579 9.96512 20.258 9.77251 19.9887C9.5799 19.7194 9.31074 19.5143 9 19.4C8.69838 19.2669 8.36381 19.2272 8.03941 19.286C7.71502 19.3448 7.41568 19.4995 7.18 19.73L7.12 19.79C6.93425 19.976 6.71368 20.1235 6.47088 20.2241C6.22808 20.3248 5.96783 20.3766 5.705 20.3766C5.44217 20.3766 5.18192 20.3248 4.93912 20.2241C4.69632 20.1235 4.47575 19.976 4.29 19.79C4.10405 19.6043 3.95653 19.3837 3.85588 19.1409C3.75523 18.8981 3.70343 18.6378 3.70343 18.375C3.70343 18.1122 3.75523 17.8519 3.85588 17.6091C3.95653 17.3663 4.10405 17.1457 4.29 16.96L4.35 16.9C4.58054 16.6643 4.73519 16.365 4.794 16.0406C4.85282 15.7162 4.81312 15.3816 4.68 15.08C4.55324 14.7842 4.34276 14.532 4.07447 14.3543C3.80618 14.1766 3.49179 14.0813 3.17 14.08H3C2.46957 14.08 1.96086 13.8693 1.58579 13.4942C1.21071 13.1191 1 12.6104 1 12.08C1 11.5496 1.21071 11.0409 1.58579 10.6658C1.96086 10.2907 2.46957 10.08 3 10.08H3.09C3.42099 10.0723 3.742 9.96512 4.0113 9.77251C4.28059 9.5799 4.48572 9.31074 4.6 9C4.73312 8.69838 4.77282 8.36381 4.714 8.03941C4.65519 7.71502 4.50054 7.41568 4.27 7.18L4.21 7.12C4.02405 6.93425 3.87653 6.71368 3.77588 6.47088C3.67523 6.22808 3.62343 5.96783 3.62343 5.705C3.62343 5.44217 3.67523 5.18192 3.77588 4.93912C3.87653 4.69632 4.02405 4.47575 4.21 4.29C4.39575 4.10405 4.61632 3.95653 4.85912 3.85588C5.10192 3.75523 5.36217 3.70343 5.625 3.70343C5.88783 3.70343 6.14808 3.75523 6.39088 3.85588C6.63368 3.95653 6.85425 4.10405 7.04 4.29L7.1 4.35C7.33568 4.58054 7.63502 4.73519 7.95941 4.794C8.28381 4.85282 8.61838 4.81312 8.92 4.68H9C9.29577 4.55324 9.54802 4.34276 9.72569 4.07447C9.90337 3.80618 9.99872 3.49179 10 3.17V3C10 2.46957 10.2107 1.96086 10.5858 1.58579C10.9609 1.21071 11.4696 1 12 1C12.5304 1 13.0391 1.21071 13.4142 1.58579C13.7893 1.96086 14 2.46957 14 3V3.09C14.0013 3.41179 14.0966 3.72618 14.2743 3.99447C14.452 4.26276 14.7042 4.47324 15 4.6C15.3016 4.73312 15.6362 4.77282 15.9606 4.714C16.285 4.65519 16.5843 4.50054 16.82 4.27L16.88 4.21C17.0657 4.02405 17.2863 3.87653 17.5291 3.77588C17.7719 3.67523 18.0322 3.62343 18.295 3.62343C18.5578 3.62343 18.8181 3.67523 19.0609 3.77588C19.3037 3.87653 19.52405 4.02405 19.71 4.21C19.896 4.39575 20.0435 4.61632 20.1441 4.85912C20.2448 5.10192 20.2966 5.36217 20.2966 5.625C20.2966 5.88783 20.2448 6.14808 20.1441 6.39088C20.0435 6.63368 19.896 6.85425 19.71 7.04L19.65 7.1C19.4195 7.33568 19.2648 7.63502 19.206 7.95941C19.1472 8.28381 19.1869 8.61838 19.32 8.92V9C19.4468 9.29577 19.6572 9.54802 19.9255 9.72569C20.1938 9.90337 20.5082 9.99872 20.83 10H21C21.5304 10 22.0391 10.2107 22.4142 10.5858C22.7893 10.9609 23 11.4696 23 12C23 12.5304 22.7893 13.0391 22.4142 13.4142C22.0391 13.7893 21.5304 14 21 14H20.91C20.5882 20.91 20.2738 14.0966 20.0055 14.2743C19.7372 14.452 19.5268 14.7042 19.4 15Z" stroke="#B9BBBE" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</button>
          </div>
        </div>
      </div>
      
      <div class="chat-container" id="chatContainer">
        <div class="chat-topbar">
  <div class="close-btn-vertical-wrap">
  <button id="topbarCloseSettingsBtn" class="cosmic-close-btn topbar-close-btn" title="Close Settings (Esc)" aria-label="Close Settings" onclick="closeSettingsModal()">
    <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="16" cy="16" r="14" stroke="#bfc4d1" stroke-width="2.2" fill="none"/>
      <line x1="10" y1="10" x2="22" y2="22" stroke="#bfc4d1" stroke-width="2.2" stroke-linecap="round"/>
      <line x1="22" y1="10" x2="10" y2="22" stroke="#bfc4d1" stroke-width="2.2" stroke-linecap="round"/>
    </svg>
  </button>
  <div class="esc-label-vertical">ESC</div>
</div>
          <!-- User info view (shown when in a conversation) -->
          <div class="chat-user-info" id="chatUserInfo">
            <span class="avatar-status-wrapper">
  <img class="user-avatar" id="chatAvatar" src="https://i.pravatar.cc/150?img=3" alt="User Avatar">
</span>
            <span class="username" id="chatUsername">OtherUser</span>
            <span class="user-badge cosmic" id="chatUserBadge"></span>
          </div>
          
          <!-- Home view (shown when not in a conversation) -->
<div class="chat-home-view" id="chatHomeView" style="display: none; pointer-events:auto;">
  <img class="home-logo" src="./lib/ww/assets/school-messenger-logo.png" alt="School Messenger Logo" style="width: 150px; height: 75px; z-index: 999999; margin-top: 40px;">
  <div class="home-title" data-text="School Messenger">School Messenger</div>
  <div class="home-description">
    Welcome to School Messenger, your all-in-one platform for secure, real-time communication.<br>
    Connect with friends and classmates in a beautiful, modern interface.<br>
    Start a conversation, manage your contacts, and enjoy a seamless messaging experience.<br>
  </div>
</div>
        </div>
        <div class="chat-messages" id="chatMessages">
          <!-- Messages will appear here -->
        </div>
        <div class="chat-input-bar">
          <textarea id="chatInput" placeholder="Message @your mom"></textarea>
          <button class="send-button" id="sendButton">Send</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Cosmic Alert Component -->
  <div class="alert-overlay" id="test-alert-overlay">
    <div class="alert">
      <div.prod="alert-header">
        <h3 class="alert-title">Test Alert</h3>
        <button class="alert-close">
          <svg viewBox="0 0 24 24"><path d="M18.4 4L12 10.4 5.6 4 4 5.6 10.4 12 4 18.4 5.6 20 12 13.6 18.4 20 20 18.4 13.6 12 20 5.6 18.4 4z"></path></svg>
        </button>
      </div>
      <div class="alert-content">
        <p class="alert-message"></p>
      </div>
      <div class="alert-actions">
        <button class="alert-button">OK</button>
      </div>
    </div>
  </div>

  

  <!-- Pending Requests View -->
  <div class="overlay" id="pendingOverlay" style="display: none; position: fixed; inset: 0; z-index: 99999; background: rgba(10,12,40,0.92); backdrop-filter: blur(2px); align-items: center; justify-content: center; overflow-y: auto; cursor: pointer;">
    <div class="popup-container">
      <div class="popup-form pending-requests-container">
        <div class="pending-requests-list" id="pendingRequestsList">
  <!-- Example friend request card (will be dynamically generated by JS) -->
  <!--
  <div class="pending-request">
    <img class="request-avatar" src="https://i.pravatar.cc/150?img=7" alt="User Avatar">
    <div class="request-details">
      <span class="username">RequestingUser</span>
      <span class="request-time">2 minutes ago</span>
    </div>
    <div class="request-actions">
      <button class="accept-button">Accept</button>
      <button class="decline-button">Decline</button>
    </div>
  </div>
  -->
</div>
<style>
  .pending-requests-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-height: 60vh;
    overflow-y: auto;
    padding: 15px 10px;
    margin: 10px -10px 0;
    scrollbar-width: thin;
    scrollbar-color: rgba(88, 101, 242, 0.3) transparent;
  }
  
  .pending-requests-list::-webkit-scrollbar {
    width: 6px;
  }
  
  .pending-requests-list::-webkit-scrollbar-track {
    background: transparent;
  }
  
  .pending-requests-list::-webkit-scrollbar-thumb {
    background-color: rgba(88, 101, 242, 0.3);
    border-radius: 3px;
  }
  .pending-request {
    display: flex;
    align-items: center;
    gap: 16px;
    background: rgba(30, 31, 41, 0.8);
    border: 1px solid rgba(88, 101, 242, 0.15);
    border-radius: 10px;
    padding: 14px 18px;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
    min-width: 0;
    backdrop-filter: blur(4px);
  }
  
  .pending-request:hover {
    background: rgba(35, 36, 48, 0.9);
    border-color: rgba(88, 101, 242, 0.4);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(88, 101, 242, 0.15);
  }
  .request-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #3a3b5a;
    background: #2a2b40;
    transition: all 0.25s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  }
  
  .pending-request:hover .request-avatar {
    transform: scale(1.05);
    border-color: #5865f2;
    box-shadow: 0 0 0 2px rgba(88, 101, 242, 0.3);
  }
  .request-details {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 3px;
    min-width: 0; /* Allows text truncation */
    overflow: hidden;
  }
  
  .username {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 200px; /* Adjust based on your needs */
  }
  .request-details .username {
    font-size: 1.07em;
    font-weight: 600;
    color: #e0e0ff;
    letter-spacing: 0.05em;
  }
  .request-details .request-time {
    font-size: 0.85em;
    color: rgba(224,224,255,0.7);
    margin-top: 1px;
  }
  .request-actions {
    display: flex;
    gap: 10px;
    flex-shrink: 0;
    margin-left: auto;
  }
  
  .accept-button, .decline-button {
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 0.9em;
    font-weight: 600;
    font-family: 'Orbitron', sans-serif;
    cursor: pointer;
    border: none;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 90px;
    height: 36px;
    position: relative;
    overflow: hidden;
  }
  .accept-button {
    background: linear-gradient(135deg, #5865f2 0%, #4752c4 100%);
    color: #fff;
    box-shadow: 0 2px 10px rgba(88, 101, 242, 0.3);
  }
  
  .accept-button:hover {
    background: linear-gradient(135deg, #6774f2 0%, #5865f2 100%);
    box-shadow: 0 4px 15px rgba(88, 101, 242, 0.4);
    transform: translateY(-2px);
  }
  
  .accept-button:active {
    transform: translateY(0);
    box-shadow: 0 2px 5px rgba(88, 101, 242, 0.3);
  }
  .decline-button {
    background: rgba(60, 60, 80, 0.6);
    color: #e0e0ff;
    border: 1px solid rgba(88, 101, 242, 0.2);
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }
  
  .decline-button:hover {
    background: rgba(80, 80, 100, 0.7);
    color: #fff;
    border-color: #5865f2;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
  }
  
  .decline-button:active {
    transform: translateY(0);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }
  .pending-requests-list .loading-message {
    text-align: center;
    color: #a0a8ff;
    font-size: 1.02em;
    margin: 30px 0;
  }
  .pending-requests-list .empty-state {
    text-align: center;
    color: #72767d;
    font-size: 1.01em;
    margin: 30px 0;
  }
</style>
      </div>
    </div>
  </div>
  
  <script>
  // Global function to open self profile
  function openSelfProfile() {
    window.profileOpenTriggered = true;
    const userData = window.currentUserData || {};
    // Check if showUserProfile exists before calling
    if (typeof showUserProfile === 'function') {
      showUserProfile({
        username: userData.username || 'YourUsername',
        avatarUrl: document.querySelector('.sidebar-footer-inner .user-avatar')?.src || '',
        badge: undefined, // or fetch if needed
        email: userData.email || '',
        bio: userData.bio || ''
      });
    } else {
      console.warn('showUserProfile function not found');
    }
  }
  
  // Attach user profile open to settings button only (never automatically)
  document.addEventListener('DOMContentLoaded', function() {
  // Attach profile open to only the clickable area (PFP, name, status)
  const sidebarFooterClickable = document.querySelector('.sidebar-footer-clickable');
  if (sidebarFooterClickable) {
    sidebarFooterClickable.style.cursor = 'pointer';
    sidebarFooterClickable.addEventListener('click', openSelfProfile);
    // Add context menu to the clickable area only
    if (window.attachCustomContextMenu) {
      attachCustomContextMenu(sidebarFooterClickable, [
        { label: 'View Profile', icon: '👤', onClick: openSelfProfile },
        { label: 'Settings', icon: '⚙️', onClick: () => alert('Open settings (not implemented)') },
        { label: 'Logout', icon: '🚪', onClick: handleLogout }
      ]);
    }
  }
  // Remove any handler from just the username span if present
  const sidebarProfileUsername = document.getElementById('sidebarProfileUsername');
  if (sidebarProfileUsername) {
    sidebarProfileUsername.replaceWith(sidebarProfileUsername.cloneNode(true));
  }
});

// IMPORTANT: Ensure authentication state is synchronized across files
// This syncs our window.currentUserData with log.js's currentUserData
function syncAuthState() {
  try {
    if (window.currentUserData && typeof currentUserData !== 'undefined') {
      currentUserData.uuid = window.currentUserData.uuid;
      currentUserData.username = window.currentUserData.username;
      currentUserData.isLoggedIn = window.currentUserData.isLoggedIn;
      return true;
    } else if (typeof currentUserData !== 'undefined') {
      window.currentUserData = {
        uuid: currentUserData.uuid,
        username: currentUserData.username,
        isLoggedIn: currentUserData.isLoggedIn
      };
      return true;
    }
  } catch (e) {
    console.error("Error syncing auth state:", e);
  }
  return false;
}

// Ensure shared authentication state is available globally
  if (typeof window.currentUserData === 'undefined') {
    window.currentUserData = {
      uuid: null,
      username: null,
      isLoggedIn: false,
      isBanned: false,
      bannedInfo: null
    };
  } else {
    // Check for banned status on page load
    if (window.currentUserData && window.currentUserData.isBanned && window.BannedScreen) {
      // Show the banned screen if user is banned with all necessary info
      const banInfo = {
        username: window.currentUserData.username,
        reason: window.currentUserData.bannedInfo?.reason || 'No reason provided',
        banLength: window.currentUserData.bannedInfo?.banLength,
        banDate: window.currentUserData.bannedInfo?.banDate || new Date().toISOString()
      };
      window.BannedScreen.show(banInfo);
      
      // Update the stored bannedInfo with the enhanced data
      window.currentUserData.bannedInfo = banInfo;
    }
  }
  
  // User authentication helper functions (backup if log.js functions aren't available)
  if (typeof getCurrentUserUUID !== 'function') {
    function getCurrentUserUUID() {
      return window.currentUserData.uuid;
    }
  }
  
  if (typeof getCurrentUsername !== 'function') {
    function getCurrentUsername() {
      return window.currentUserData.username;
    }
  }
  
  if (typeof isUserLoggedIn !== 'function') {
    function isUserLoggedIn() {
      return window.currentUserData.isLoggedIn;
    }
  }
  
  // Info overlay functions
  function showInfo() {
    document.getElementById('infoOverlay').style.display = 'flex';
  }
  function hideInfo() {
    document.getElementById('infoOverlay').style.display = 'none';
  }
  // Contact overlay functions
  function showContact() {
    const overlay = document.getElementById('contactOverlay');
    const content = overlay.querySelector('.contact-content');
    
    // Reset form
    document.getElementById('contactSubject').value = '';
    document.getElementById('contactMessage').value = '';
    
    // Show the overlay first
    overlay.style.display = 'flex';
    
    // Trigger reflow
    void overlay.offsetHeight;
    
    // Add visible class to trigger animations
    overlay.classList.add('visible');
    
    // Focus on subject input after a short delay
    setTimeout(() => {
      document.getElementById('contactSubject').focus();
    }, 50);
    
    // Close on ESC key
    const handleEsc = (e) => {
      if (e.key === 'Escape') {
        hideContact();
      }
    };
    
    // Close on overlay click (outside content)
    const handleOverlayClick = (e) => {
      if (e.target === overlay) {
        hideContact();
      }
    };
    
    // Add event listeners
    document.addEventListener('keydown', handleEsc);
    overlay.addEventListener('click', handleOverlayClick);
    
    // Store references to remove later
    overlay._escHandler = handleEsc;
    overlay._overlayHandler = handleOverlayClick;
  }
  
  function hideContact() {
    const overlay = document.getElementById('contactOverlay');
    
    // Remove visible class to trigger animations
    overlay.classList.remove('visible');
    
    // Remove event listeners
    if (overlay._escHandler) {
      document.removeEventListener('keydown', overlay._escHandler);
      overlay._escHandler = null;
    }
    
    if (overlay._overlayHandler) {
      overlay.removeEventListener('click', overlay._overlayHandler);
      overlay._overlayHandler = null;
    }
    
    // Hide after animation completes
    setTimeout(() => {
      overlay.style.display = 'none';
    }, 300);
  }
  function sendContactEmail() {
    const subject = document.getElementById('contactSubject').value.trim();
    const message = document.getElementById('contactMessage').value.trim();
    if (!subject || !message) {
      showAlert('Please enter both a subject and a message.', 'error');
      return;
    }
    const mailtoLink = `mailto:mcgahaj2@students.hcboe.net?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(message)}`;
    window.location.href = mailtoLink;
    hideContact();
  }
  // Forgot Password overlay functions
  function showForgotPassword() {
    const overlay = document.getElementById('forgotPasswordOverlay');
    const container = overlay.querySelector('.forgot-password-container');
    
    // Reset form
    const form = document.getElementById('forgotPasswordForm');
    if (form) form.reset();
    
    // Show with animation
    overlay.style.display = 'flex';
    setTimeout(() => {
      overlay.style.opacity = '1';
      container.style.transform = 'translateY(0)';
      container.style.opacity = '1';
      
      // Focus on email input
      const emailInput = document.getElementById('forgotEmail');
      if (emailInput) emailInput.focus();
    }, 10);
  }
  
  function hideForgotPassword() {
    const overlay = document.getElementById('forgotPasswordOverlay');
    const container = overlay.querySelector('.forgot-password-container');
    
    // Animate out
    overlay.style.opacity = '0';
    container.style.transform = 'translateY(20px)';
    container.style.opacity = '0';
    
    // Hide after animation completes
    setTimeout(() => {
      overlay.style.display = 'none';
    }, 300);
  }
  
  // Handle Forgot Password form submission
  function handleForgotPassword() {
    const email = document.getElementById('forgotEmail').value.trim();
    const submitBtn = document.querySelector('#forgotPasswordForm .btn-primary');
    const originalBtnText = submitBtn.innerHTML;
    
    // Basic email validation
    if (!email) {
      showAlert('Please enter your email address.', 'error');
      return;
    }
    
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      showAlert('Please enter a valid email address.', 'error');
      return;
    }
    
    // Show loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
    
    // Simulate API call (replace with actual API call)
    setTimeout(() => {
      // This is where you would typically make an API call to your backend
      // For now, we'll simulate a successful response
      const success = true; // Simulate success
      
      if (success) {
        // Show success message
        showAlert(
          'If an account exists with this email, you will receive a password reset link shortly.\n\nPlease check your inbox and follow the instructions in the email.', 
          'success',
          {
            title: 'Reset Link Sent',
            buttons: ['OK'],
            onConfirm: () => {
              hideForgotPassword();
              // Optional: Auto-close the alert after 5 seconds
              setTimeout(() => {
                const alert = document.querySelector('.alert-overlay');
                if (alert) alert.style.display = 'none';
              }, 5000);
            }
          }
        );
        
        // Reset form
        document.getElementById('forgotPasswordForm').reset();
      } else {
        // Show error message if the API call fails
        showAlert(
          'Failed to send reset link. Please try again later or contact support if the issue persists.',
          'error'
        );
      }
      
      // Reset button state
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalBtnText;
    }, 1500); // Simulate network delay
  }
  
  // Login and messaging functions
  function showLogin() {
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const verificationForm = document.getElementById('verificationForm');
    
    // First hide all forms
    if (loginForm) loginForm.style.display = 'block';
    if (registerForm) registerForm.style.display = 'none';
    if (verificationForm) verificationForm.style.display = 'none';
    
    // Use setTimeout to ensure the form is visible before setting focus
    setTimeout(() => {
      const usernameInput = document.getElementById('username');
      if (usernameInput) {
        usernameInput.focus();
        // Select any existing text for easier editing
        usernameInput.select();
      }
    }, 10);
    
    return false;
  }
  
  function showRegister() {
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const verificationForm = document.getElementById('verificationForm');
    
    // First hide all forms
    if (loginForm) loginForm.style.display = 'none';
    if (registerForm) registerForm.style.display = 'block';
    if (verificationForm) verificationForm.style.display = 'none';
    
    // Use setTimeout to ensure the form is visible before setting focus
    setTimeout(() => {
      const registerUsername = document.getElementById('registerUsername');
      if (registerUsername) {
        registerUsername.focus();
        // Select any existing text for easier editing
        registerUsername.select();
      }
    }, 10);
    
    return false;
  }
  
  // Initialize form visibility on page load
  document.addEventListener('DOMContentLoaded', function() {
    // Show login form by default and ensure focus is set
    setTimeout(() => {
      showLogin();
    }, 100); // Slight delay to ensure all elements are ready
    
    // Add enter key support for login form
    document.getElementById('password').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        handleLoginWithLogin();
      }
    });
  });
  
  // Function to display direct messages in the sidebar
  async function displayDirectMessages(filterText = '') {
    if (!filterText || !filterText.trim()) console.log('============ DISPLAYING DIRECT MESSAGES ============');
    const dmList = document.querySelector('.dm-list');
    if (!dmList) {
      console.error('DM List element not found in the DOM');
      return;
    }

    // Clear list immediately; do not wait on permissions
    dmList.innerHTML = '';
    if (!filterText || !filterText.trim()) console.log('Cleared existing DM entries');

    // Build list; permissions fetched in background per user
    if (window.currentUserData && window.currentUserData.dmUsernames && window.currentUserData.dmUsernames.length > 0) {
      // Apply filtering if filterText is provided
      let filteredUsernames = window.currentUserData.dmUsernames;
      if (filterText && typeof filterText === 'string') {
        const lowerFilter = filterText.toLowerCase();
        filteredUsernames = filteredUsernames.filter(username => username.toLowerCase().includes(lowerFilter));
      }
      if (filteredUsernames.length === 0) {
        dmList.innerHTML = '<li style="padding: 14px; color: #aaa; text-align: center;">No conversations found.</li>';
        return;
      }
      // Remove duplicate usernames (just in case)
      const seen = new Set();
      filteredUsernames = filteredUsernames.filter(u => {
        const lower = u.toLowerCase();
        if (seen.has(lower)) return false;
        seen.add(lower);
        return true;
      });
    for (let i = 0; i < filteredUsernames.length; ++i) {
      const username = filteredUsernames[i];
      const listItem = document.createElement('li');
      listItem.className = 'dm-user';
      listItem.dataset.username = username;
      const avatarIndex = Math.abs(username.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % 10);
      // Use cached permission if available; do NOT block UI if missing
      const cachedPermission = window.userPermissionsCache && window.userPermissionsCache[username];
      listItem.dataset.permission = cachedPermission || '';
      let badgeHTML = '';
      if (cachedPermission === 'MOD') badgeHTML = '<span class="user-badge" title="Moderator">🛡️</span>';
      else if (cachedPermission === 'OWNER') badgeHTML = '<span class="user-badge" title="Owner">👑</span>';
      else if (cachedPermission === 'TESTER') badgeHTML = '<span class="user-badge" title="Tester">🛠️</span>';
      else if (cachedPermission === 'BOT') badgeHTML = '<span class="user-badge" title="Bot">🤖</span>';
      listItem.innerHTML = `
        <img class="dm-avatar" src="https://i.pravatar.cc/150?img=${avatarIndex}" alt="${username}'s Avatar">
        <span class="dm-name">${username}</span>
        ${badgeHTML}
      `;
      listItem.addEventListener('click', function() {
        document.querySelectorAll('.dm-user').forEach(el => el.classList.remove('active'));
        this.classList.add('active');
        openConversation(username, avatarIndex);
        window.currentScreen = 'dm';
        if (typeof updateHomeButtonState === 'function') updateHomeButtonState();
      });
      attachCustomContextMenu(listItem, [
        { label: 'View Profile', icon: '👤', onClick: () => { window.profileOpenTriggered = true; showUserProfileWrapper(username, avatarIndex); } },
        { label: 'Message', icon: '💬', onClick: () => openConversation(username, avatarIndex) },
        { 
          label: 'Copy Username', 
          icon: '📋', 
          onClick: () => { 
            navigator.clipboard.writeText(username);
            showAlert(`Username '${username}' copied to clipboard`, 'success');
          } 
        },
        { 
          label: 'Block', 
          icon: '🚫', 
          onClick: () => {
            showAlert(
              `Are you sure you want to block ${username}?`,
              'warning',
              {
                buttons: ['Cancel', 'Block'],
                onConfirm: () => {
                  // Block user logic would go here
                  showAlert(`${username} has been blocked`, 'success');
                }
              }
            );
          } 
        },
        { 
          label: 'Remove Friend', 
          icon: '❌', 
          onClick: () => {
            showAlert(
              `Remove ${username} from your friends?`,
              'warning',
              {
                buttons: ['Cancel', 'Remove'],
                onConfirm: () => {
                  // Remove friend logic would go here
                  showAlert(`${username} has been removed from your friends`, 'success');
                }
              }
            );
          } 
        }
      ]);
      dmList.appendChild(listItem);

      // If permission not cached, fetch concurrently in background and update badge
      if (!cachedPermission && typeof prefetchPermission === 'function') {
        prefetchPermission(username).then(perm => {
          window.userPermissionsCache = window.userPermissionsCache || {};
          window.userPermissionsCache[username] = perm;
          if (!document.body.contains(listItem)) return;
          listItem.dataset.permission = perm || '';
          // Remove existing badge if any
          const existing = listItem.querySelector('.user-badge');
          if (existing) existing.remove();
          // Add new badge if applicable
          let newBadge;
          if (perm === 'MOD') { newBadge = document.createElement('span'); newBadge.className = 'user-badge'; newBadge.title = 'Moderator'; newBadge.textContent = '🛡️'; }
          else if (perm === 'OWNER') { newBadge = document.createElement('span'); newBadge.className = 'user-badge'; newBadge.title = 'Owner'; newBadge.textContent = '👑'; }
          else if (perm === 'TESTER') { newBadge = document.createElement('span'); newBadge.className = 'user-badge'; newBadge.title = 'Tester'; newBadge.textContent = '🛠️'; }
          else if (perm === 'BOT') { newBadge = document.createElement('span'); newBadge.className = 'user-badge'; newBadge.title = 'Bot'; newBadge.textContent = '🤖'; }
          if (newBadge) listItem.appendChild(newBadge);
        }).catch(() => {/* ignore permission fetch errors */});
      }
    }
  } else {
    console.log('No direct messages to display');
    // Clear any existing content and add the no conversations message
    dmList.innerHTML = '';
    const noMessagesItem = document.createElement('li');
    noMessagesItem.style.padding = '14px';
    noMessagesItem.style.color = '#aaa';
    noMessagesItem.style.textAlign = 'center';
    noMessagesItem.style.fontSize = '0.9em';
    noMessagesItem.textContent = 'No conversations found.';
    dmList.appendChild(noMessagesItem);
    
    // Force a reflow to ensure the message is displayed
    void dmList.offsetHeight;
  }
  
  // Home button functionality moved to reinitializeSidebar
}

// Function to refresh the current DM view
window.refreshCurrentDMView = function() {
  const activeDM = document.querySelector('.dm-user.active');
  if (activeDM) {
    const username = activeDM.dataset.username || activeDM.textContent.trim();
    const avatarIndex = activeDM.querySelector('.dm-avatar')?.src?.match(/img=(\d+)/)?.[1] || 0;
    
    // Clear active state from all DMs
    document.querySelectorAll('.dm-user').forEach(el => el.classList.remove('active'));
    
    // Reopen the conversation
    if (username) {
      // Small delay to ensure DOM is ready
      setTimeout(() => {
        openConversation(username, avatarIndex);
        // Force a re-render of the active state
        const dmElement = Array.from(document.querySelectorAll('.dm-user'))
          .find(el => (el.dataset.username || el.textContent.trim()) === username);
        if (dmElement) {
          dmElement.classList.add('active');
        }
      }, 50);
    }
  }
};

function showUserProfileWrapper(username, avatarIndex) {
      console.log(`Showing profile for "${username}"`);
      const avatarUrl = `https://i.pravatar.cc/150?img=${avatarIndex}`;
      // Open modal instantly with spinner for badge and bio
      window.profileOpenTriggered = true;
      showUserProfile({
        username,
        avatarUrl,
        badge: undefined, // spinner until loaded
        email: '',
        bio: '' // bio will be fetched asynchronously
      });
      // Fetch permissions and bio for each user
      (async () => {
        let permission = window.userPermissionsCache[username];
        if (!permission) {
          permission = await fetchUserPermission(username);
          window.userPermissionsCache[username] = permission;
        }
        // Only update badge if profile modal is still open and for the same user
        if (document.getElementById('userProfileModal')) {
          window.refreshUserProfileBadge && window.refreshUserProfileBadge(username, permission);
        }
      })();
    }

function showHomeView() {
  try {
    // Close Friends view first if present
    const friendsHeader = document.getElementById('friendsHeader');
    const friendsContentArea = document.getElementById('friendsContentArea');
    if ((friendsHeader || friendsContentArea) && typeof hideFriendsView === 'function') {
      hideFriendsView();
    }
  } catch (_) {}

  try {
    // Close Settings view if its UI is present
    const settingsHeader = document.getElementById('settingsHeader');
    const settingsArea = document.getElementById('settingsContentArea');
    if ((settingsHeader || settingsArea) && typeof hideSettingsSidebar === 'function') {
      try { delete window.lastActiveDM; } catch (_) {}
      hideSettingsSidebar();
      // i like to call this the "Hope and Pray" method of UI restoration
    }
  } catch (_) {}

  try {
    // Close overlays/modals that might block UI
    const pendingOverlay = document.getElementById('pendingOverlay');
    if (pendingOverlay) pendingOverlay.style.display = 'none';
    const addFriendOverlay = document.getElementById('addFriendOverlay');
    if (addFriendOverlay) addFriendOverlay.style.display = 'none';
    const userProfileModal = document.getElementById('userProfileModal');
    if (userProfileModal) userProfileModal.remove();
  } catch (_) {}
  // Hide conversation user info
  const chatUserInfo = document.getElementById('chatUserInfo');
  if (chatUserInfo) chatUserInfo.style.display = 'none';
  
  // Show and reset home view
  const chatHomeView = document.getElementById('chatHomeView');
  if (chatHomeView) {
    // Make sure home view is visible
    chatHomeView.style.display = 'flex';
    chatHomeView.style.opacity = '1';
    chatHomeView.style.pointerEvents = 'auto';
    
    // Reset any animations or transitions
    chatHomeView.classList.remove('home-leave');
    
    // Make sure all child elements are visible
    const homeElements = chatHomeView.querySelectorAll('*');
    homeElements.forEach(el => {
      if (el.style.display === 'none') {
        el.style.display = ''; // Reset to default
      }
    });
  }
  
  // Clear and reset chat messages
  const chatMessages = document.getElementById('chatMessages');
  if (chatMessages) {
    chatMessages.innerHTML = '';
    chatMessages.style.display = 'flex';
  }
  
  // Reset chat input
  const chatInput = document.getElementById('chatInput');
  if (chatInput) {
    chatInput.placeholder = 'Message unavailable in home view';
    chatInput.disabled = true;
    chatInput.style.display = 'block';
  }
  
  // Show friend-related buttons (let title/description animate via CSS)
  const friendButtons = document.querySelectorAll('.friend-button, .add-friend-button, .home-cta');
  friendButtons.forEach(btn => {
    if (btn) {
      btn.style.display = 'flex';
    }
  });
  
  // Remove active state from DMs
  document.querySelectorAll('.dm-user.active').forEach(el => el.classList.remove('active'));
  
  // Update UI elements
  const sendBtn = document.getElementById('sendButton');
  if (sendBtn) sendBtn.style.display = 'none';
  
  // Update screen state
  window.currentScreen = 'home';
  updateHomeButtonState();
  
  // Force a reflow to ensure styles are applied
  if (chatHomeView) {
    void chatHomeView.offsetHeight;
  }
  
  console.log('Home view shown with all elements');
}

async function fetchUserPermission(username) {
  try {
    // Add cache-busting timestamp
    const cacheBuster = `t=${Date.now()}`;
    const url = `${permissionCheck}?username=${encodeURIComponent(username)}&${cacheBuster}`;
    console.log(`Fetching permission for username "${username}" from: ${url}`);
    const response = await fetch(url, { mode: 'cors' });
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`HTTP error: ${response.status} ${response.statusText} - ${errorText}`);
    }
    const data = await response.json();
    console.log(`Permission response for "${username}":`, data);
    const permission = data.status === 'success' ? (data.permission || 'DEFAULT') : 'DEFAULT';
    return permission;
  } catch (error) {
    console.error(`Error fetching permission for "${username}": ${error.message}`);
    return 'DEFAULT';
  }
}

// Permission cache
window.userPermissionsCache = window.userPermissionsCache || {};
window.userPermissionsInflight = window.userPermissionsInflight || {};

// Prefetch a user's permission with de-duplication of concurrent requests
function prefetchPermission(username) {
  username = String(username || '');
  if (!username) return Promise.resolve('DEFAULT');
  const cache = window.userPermissionsCache;
  const inflight = window.userPermissionsInflight;
  if (cache[username]) return Promise.resolve(cache[username]);
  if (inflight[username]) return inflight[username];
  inflight[username] = fetchUserPermission(username)
    .then(perm => {
      cache[username] = perm;
      delete inflight[username];
      return perm;
    })
    .catch(() => {
      delete inflight[username];
      return 'DEFAULT';
    });
  return inflight[username];
}

// Start permission checks for all users after login (non-blocking, concurrent with limit)
function startPermissionChecks(usernames, concurrency = 6) {
  if (!Array.isArray(usernames) || usernames.length === 0) return;
  const queue = usernames.filter(Boolean).map(u => String(u));
  let running = 0;
  const next = () => {
    while (running < concurrency && queue.length) {
      const u = queue.shift();
      if (!u) continue;
      if (window.userPermissionsCache[u]) { continue; }
      running++;
      prefetchPermission(u)
        .then(() => {})
        .catch(() => {})
        .finally(() => { running--; next(); });
    }
  };
  next();
}

// Call this after login with your DM/friend list
// Example: startPermissionChecks(['user1','user2','user3']);

// Function to open a conversation with a specific user
async function openConversation(username, avatarIndex) {
  // Show user info instantly
  const chatUserInfo = document.getElementById('chatUserInfo');
  const chatUsername = document.getElementById('chatUsername');
  const chatUserBadge = document.getElementById('chatUserBadge');
  const userAvatar = chatUserInfo ? chatUserInfo.querySelector('.user-avatar') : null;
  if (chatUserInfo) chatUserInfo.style.display = 'flex';
  if (chatUsername) chatUsername.textContent = username;
  if (chatUserBadge) chatUserBadge.innerHTML = '';
  if (userAvatar) userAvatar.src = `https://i.pravatar.cc/150?img=${avatarIndex}`;

  // Simulate status (online/offline) and update avatar outline
  const chatAvatar = document.getElementById('chatAvatar');
  let status = 'online'; // TODO: replace with real status fetch if available
  if (chatAvatar) {
    chatAvatar.classList.remove('status-online', 'status-offline', 'status-away');
    if (status === 'online') chatAvatar.classList.add('status-online');
    else if (status === 'offline') chatAvatar.classList.add('status-offline');
    else if (status === 'away') chatAvatar.classList.add('status-away');
  }

  // Update screen state
  window.currentScreen = 'dm';
  updateHomeButtonState();
  
  // Use cached permission if available
  var permission = window.userPermissionsCache[username];
  var badgeHTML = '';
  if (permission) {
    if (permission === 'OWNER') badgeHTML = '<span class="role-badge cosmic owner">OWNER</span>';
    else if (permission === 'MOD') badgeHTML = '<span class="role-badge cosmic mod">MODERATOR</span>';
    else if (permission === 'TESTER') badgeHTML = '<span class="role-badge cosmic tester">TESTER</span>';
    else badgeHTML = '';
    if (chatUserBadge) chatUserBadge.innerHTML = badgeHTML;
  } else {
    // Fetch and cache if not present
    fetchUserPermission(username).then(perm => {
      window.userPermissionsCache[username] = perm;
      var badgeHTML = '';
      if (perm === 'OWNER') badgeHTML = '<span class="role-badge cosmic owner">OWNER</span>';
      else if (perm === 'MOD') badgeHTML = '<span class="role-badge cosmic mod">MODERATOR</span>';
      else if (perm === 'TESTER') badgeHTML = '<span class="role-badge cosmic tester">TESTER</span>';
      else badgeHTML = '';
      if (chatUserBadge) chatUserBadge.innerHTML = badgeHTML;
    });
  }

  // Remove duplicate permission declaration and badge logic below
  // (Lines 972-995 removed)


  console.log(`Opening conversation with ${username}`);
  
  // Only declare these variables once
  const chatHomeView = document.getElementById('chatHomeView');
  const chatMessages = document.getElementById('chatMessages');
  const chatInput = document.getElementById('chatInput');
  
  if (chatUserInfo) chatUserInfo.style.display = 'flex';
  if (chatHomeView) chatHomeView.style.display = 'none';
  
  if (chatMessages) chatMessages.innerHTML = '';
  
  if (chatInput) {
    chatInput.placeholder = `Message @${username}`;
    chatInput.disabled = false;
    // Show send button in DM/conversation view
    var sendBtn = document.getElementById('sendButton');
    if (sendBtn) sendBtn.style.display = '';
  }
  
  // Animate DM enter for header/footer/send button
  try { playDMOpenAnimations(); } catch (_) {}
  
  console.log(`Conversation with ${username} opened`);
}

// Smooth DM-enter animations for header (topbar), footer (input bar) and send button
function playDMOpenAnimations() {
  const header = document.querySelector('.chat-topbar');
  const footer = document.querySelector('.chat-input-bar');
  const sendBtn = document.getElementById('sendButton');

  const reapply = (el, cls) => {
    if (!el) return;
    el.classList.remove(cls);
    void el.offsetWidth; // restart animation
    el.classList.add(cls);
    el.addEventListener('animationend', () => el.classList.remove(cls), { once: true });
  };

  reapply(header, 'dm-enter-header');
  reapply(footer, 'dm-enter-footer');
  reapply(sendBtn, 'dm-enter-send');
}

// Search bar functionality for DMs
(function() {
  document.addEventListener('DOMContentLoaded', function() {
    var searchInput = document.getElementById('dmSearchInput');
    if (searchInput) {
      searchInput.addEventListener('input', function() {
        const filter = searchInput.value || '';
        displayDirectMessages(filter);
      });
    }
  });
})();
// Make sure the button is properly connected to our function
document.addEventListener('DOMContentLoaded', function() {
  const loginButton = document.querySelector('button#loginButton');
  console.log('Login button found:', loginButton ? 'YES' : 'NO');
  
  if (loginButton) {
    // Add click event listener with proper scoping
    loginButton.addEventListener('click', function(e) {
      e.preventDefault();
      if (window.handleLoginWithLogin) {
        window.handleLoginWithLogin();
      } else {
        console.error('Login function not loaded');
        // Fallback to form submission if function isn't available
        const form = document.getElementById('loginForm');
        if (form) form.submit();
      }
    });
    console.log('Login button event listener attached');
  } else {
    console.error("Login button not found! Check the button's id attribute.");
  }

// Add Enter key functionality to login fields
document.addEventListener('DOMContentLoaded', function() {
  const usernameInput = document.getElementById('username');
  const passwordInput = document.getElementById('password');

  if (usernameInput && passwordInput) {
    // Only handle Enter for password submit, not username field
    // Password field: submit form on Enter
    passwordInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        if (window.handleLoginWithLogin) {
          window.handleLoginWithLogin();
        } else {
          console.error('Login function not loaded');
          // Fallback to form submission if function isn't available
          const form = document.getElementById('loginForm');
          if (form) form.submit();
        }
      }
    });
  }
});
});

async function handleLogin() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      if (!username || !password) {
        showAlert('Please enter username and password', 'error');
        return;
      }

      try {
        const formData = new URLSearchParams();
        formData.append('username', username);
        formData.append('password', password); // Adjust based on your GAS params

        const response = await fetch(signinGasUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: formData,
          mode: 'cors',
          credentials: 'omit'
        });

        if (!response.ok) {
          throw new Error(`Login failed: ${response.status}`);
        }

        const data = await response.json();
        if (data.status !== 'success') {
          throw new Error(data.message || 'Login failed');
        }

        // Set real user data from sign-in response
        window.currentUserData = {
          username: data.username, // Unencrypted username
          email: data.email,
          uuid: data.uuid // Unencrypted UUID
        };
        console.log('Logged in user:', window.currentUserData);

        // Show profile section
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('profile-section').style.display = 'block';
      } catch (error) {
        console.error('Login error:', error);
        showAlert('Login failed: ' + error.message, 'error');
      }
    }

    function handleLogout() {
  localStorage.setItem('justLoggedOut', '1');
  location.reload();
}
function showRegister() {
clearVerifyTimeout();
document.getElementById('loginForm').style.display = 'none';
document.getElementById('registerForm').style.display = 'block';
document.getElementById('verificationForm').style.display = 'none';
document.getElementById('appTitle').textContent = 'Register';
document.getElementById('registerUsername').focus();
resetPasswordStyles();
document.getElementById('message').textContent = ''; // Clear message
}
function showLogin() {
clearVerifyTimeout();
document.getElementById('registerForm').style.display = 'none';
document.getElementById('verificationForm').style.display = 'none';
document.getElementById('loginForm').style.display = 'block';
document.getElementById('appTitle').textContent = 'School Messenger';
document.getElementById('username').focus();
document.getElementById('registerUsername').value = '';
document.getElementById('registerGmail').value = '';
document.getElementById('registerPassword').value = '';
document.getElementById('confirmPassword').value = '';
const codeInputs = document.querySelectorAll('.code-input');
codeInputs.forEach(input => input.value = '');
const usernameInput = document.getElementById('registerUsername');
const usernameIcon = document.getElementById('usernameIcon');
const gmailInput = document.getElementById('registerGmail');
const gmailIcon = document.getElementById('GmailIcon');
const messageDiv = document.getElementById('message');
usernameInput.classList.remove('username-taken', 'username-available');
usernameIcon.classList.remove('username-taken-icon', 'username-available-icon');
gmailInput.classList.remove('gmail-taken', 'gmail-available', 'gmail-invalid');
gmailIcon.classList.remove('gmail-taken-icon', 'gmail-available-icon', 'gmail-invalid-icon');
messageDiv.textContent = '';
resetPasswordStyles();
}
let verifyTimeout = null;

function showVerification() {
  try {
    // Hide all auth forms first
    const forms = ['registerForm', 'loginForm'];
    forms.forEach(formId => {
      const form = document.getElementById(formId);
      if (form) form.style.display = 'none';
    });
    
    // Show verification form
    const verificationForm = document.getElementById('verificationForm');
    if (verificationForm) {
      verificationForm.style.display = 'block';
      verificationForm.offsetHeight; // Trigger reflow
      
      // Focus first input field
      const firstInput = verificationForm.querySelector('input[type="text"]');
      if (firstInput) firstInput.focus();
    }
    
    // Update title
    const appTitle = document.getElementById('appTitle');
    if (appTitle) appTitle.textContent = 'Verification';
    
  } catch (error) {
    console.error('Error in showVerification:', error);
    // Fallback to showing login form if something goes wrong
    showLogin();
  }
}

function clearVerifyTimeout() {
  if (verifyTimeout) {
    clearTimeout(verifyTimeout);
    verifyTimeout = null;
  }
}
// Test authentication functionality
document.addEventListener('DOMContentLoaded', function() {
  const testAuthButton = document.getElementById('testAuthButton');
  if (!testAuthButton) return;

  testAuthButton.addEventListener('click', async function() {
    try {
      alert("Testing authentication API - check console for results");
      console.log("==== DIRECT API TEST STARTING ====");

      // Get the username for testing
      const unameInput = document.getElementById('username');
      const testUsername = (unameInput && unameInput.value ? unameInput.value.trim() : '') || 'testuser';
      console.log("Testing with username:", testUsername);

      // Show we have access to the endpoint URL
      console.log("ProhibitedCheck URL:", prohibitedCheck);

      // Directly call the prohibitedCheck endpoint
      console.log("Attempting direct fetch to prohibitedCheck...");
      const response = await fetch(prohibitedCheck + "?username=" + encodeURIComponent(testUsername));
      console.log("Response received:", response);

      const text = await response.text();
      if (response.ok) {
        try {
          const data = JSON.parse(text);
          console.log("Parsed response:", data);
          alert("API test successful! Check console for detailed results");
        } catch (parseError) {
          console.error("JSON parse error:", parseError);
          alert("Error parsing JSON response: " + parseError.message);
        }
      } else {
        console.error("HTTP error:", response.status, response.statusText);
        alert("HTTP error: " + response.status);
      }
    } catch (error) {
      console.error("Test button error:", error);
      alert("Error in test: " + error.message);
    }
  });
});

// Chat functionality
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    if (usernameInput && passwordInput) {
      // Username field: move to password on Enter
      usernameInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          passwordInput.focus();
        }
      });
      
      // Password field: Enter key handler is already set up in the main event listener section
    }
  function showRegister() {
    clearVerifyTimeout();
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'block';
    document.getElementById('verificationForm').style.display = 'none';
    document.getElementById('appTitle').textContent = 'Register';
    document.getElementById('registerUsername').focus();
    resetPasswordStyles();
    document.getElementById('message').textContent = ''; // Clear message
  }
  function showLogin() {
    clearVerifyTimeout();
    document.getElementById('registerForm').style.display = 'none';
    document.getElementById('verificationForm').style.display = 'none';
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('appTitle').textContent = 'School Messenger';
    document.getElementById('username').focus();
    document.getElementById('registerUsername').value = '';
    document.getElementById('registerGmail').value = '';
    document.getElementById('registerPassword').value = '';
    document.getElementById('confirmPassword').value = '';
    const codeInputs = document.querySelectorAll('.code-input');
    codeInputs.forEach(input => input.value = '');
    const usernameInput = document.getElementById('registerUsername');
    const usernameIcon = document.getElementById('usernameIcon');
    const gmailInput = document.getElementById('registerGmail');
    const gmailIcon = document.getElementById('GmailIcon');
    const messageDiv = document.getElementById('message');
    usernameInput.classList.remove('username-taken', 'username-available');
    usernameIcon.classList.remove('username-taken-icon', 'username-available-icon');
    gmailInput.classList.remove('gmail-taken', 'gmail-available', 'gmail-invalid');
    gmailIcon.classList.remove('gmail-taken-icon', 'gmail-available-icon', 'gmail-invalid-icon');
    messageDiv.textContent = '';
    resetPasswordStyles();
  }
  function clearVerifyTimeout() {
    if (verifyTimeout) {
      clearTimeout(verifyTimeout);
      verifyTimeout = null;
    }
  }
  document.addEventListener('DOMContentLoaded', function() {
    const testAuthButton = document.getElementById('testAuthButton');
    if (testAuthButton) {
      testAuthButton.addEventListener('click', async function() {
        try {
          alert("Testing authentication API - check console for results");
          console.log("==== DIRECT API TEST STARTING ====");
          
          // Get the username for testing
          const testUsername = document.getElementById('username').value.trim() || 'testuser';
          console.log("Testing with username:", testUsername);
          
          // Show we have access to the endpoint URL
          console.log("ProhibitedCheck URL:", prohibitedCheck);
          
          // Directly call the prohibitedCheck endpoint
          try {
            console.log("Attempting direct fetch to prohibitedCheck...");
            const response = await fetch(prohibitedCheck + "?username=" + encodeURIComponent(testUsername));
            console.log("Response received:", response);

            if (response.ok) {
              const text = await response.text();
              console.log("Raw response text:", text);

              try {
                const data = JSON.parse(text);
                console.log("Parsed response:", data);
                alert("API test successful! Check console for detailed results");
              } catch (parseError) {
                console.error("JSON parse error:", parseError);
                alert("Error parsing JSON response: " + parseError.message);
              }
            } else {
              console.error("HTTP error:", response.status, response.statusText);
              alert("HTTP error: " + response.status);
            }
          } catch (fetchError) {
            console.error("Fetch error:", fetchError);
            alert("Network error: " + fetchError.message);
          }
        } catch (error) {
          console.error("Test button error:", error);
          alert("Error in test: " + error.message);
        }
      });
    }
  });
  
  // Handle pending requests overlay close functionality
  function setupPendingOverlayClose() {
    const closePendingBtn = document.getElementById('closePending');
    const pendingOverlay = document.getElementById('pendingOverlay');
    
    if (!closePendingBtn || !pendingOverlay) return;
    
    // Remove any existing event listeners to prevent duplicates
    const newCloseBtn = closePendingBtn.cloneNode(true);
    closePendingBtn.parentNode.replaceChild(newCloseBtn, closePendingBtn);
    
    // Add new click handler for close button
    newCloseBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      closePendingOverlay();
    });
    
    // Add click handler for overlay background
    pendingOverlay.addEventListener('click', function(e) {
      if (e.target === pendingOverlay) {
        e.preventDefault();
        e.stopPropagation();
        closePendingOverlay();
      }
    });
    
    // Add escape key handler
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && pendingOverlay.style.display === 'flex') {
        e.preventDefault();
        closePendingOverlay();
      }
    });
  }
  
  // Function to close the pending overlay and clean up
  function closePendingOverlay() {
    const pendingOverlay = document.getElementById('pendingOverlay');
    if (!pendingOverlay) return;
    
    pendingOverlay.style.display = 'none';
    
    // Remove active state from the button that opened the overlay
    const pendingBtn = document.querySelector('.nav-btn[onclick*="showPendingRequestsPopup"]');
    if (pendingBtn) {
      pendingBtn.classList.remove('active');
    }
    
    // Remove focus from the button for better keyboard navigation
    if (document.activeElement) {
      document.activeElement.blur();
    }
  }
  
  // Set up the close handlers when the DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupPendingOverlayClose);
  } else {
    setupPendingOverlayClose();
  }
  
  // Function to send a message
  function sendMessage() {
    const messageText = chatInput.value.trim();
    if (!messageText) return;
    
    // Get the current conversation partner's username
    const activeConversation = document.getElementById('chatUserInfo');
    if (!activeConversation || activeConversation.style.display === 'none') {
      // If we're in home view, don't send the message
      return;
    }
    
    // Get the current user's username and the recipient's username
    const currentUsername = window.currentUserData?.username || 'YourUsername';
    const recipientUsername = activeConversation.querySelector('.username')?.textContent;
    
    // Format timestamp
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes().toString().padStart(2, '0');
    const ampm = hours >= 12 ? 'PM' : 'AM';
    const formattedHours = (hours % 12) || 12;
    const timestamp = `${formattedHours}:${minutes} ${ampm}`;
    
    // Check if the last message was from the same user
    const lastMessage = chatMessages.lastElementChild;
    const isSameUser = lastMessage && 
                      lastMessage.querySelector('.message-username')?.textContent === currentUsername;
    
    // Get current user's avatar (could be stored in user data)
    const userAvatarIndex = 4; // Default avatar index
    
    let messageHTML;
    
    if (isSameUser) {
      // If the last message was from the same user, just add the text without avatar and username
      messageHTML = `
        <div class="message sent">
          <div class="message-content" style="margin-left: 56px;">
            <div class="message-text">${messageText}</div>
          </div>
        </div>
      `;
    } else {
      // If it's a new user or the first message, include avatar and username
      messageHTML = `
        <div class="message sent">
          <img class="message-avatar" src="https://i.pravatar.cc/150?img=${userAvatarIndex}" alt="Your Avatar">
          <div class="message-content">
            <div class="message-header">
              <span class="message-username">${currentUsername}</span>
              <span class="message-timestamp">${timestamp}</span>
            </div>
            <div class="message-text">${messageText}</div>
          </div>
        </div>
      `;
    }
    
    chatMessages.insertAdjacentHTML('beforeend', messageHTML);
    chatInput.value = '';
    chatMessages.scrollTop = chatMessages.scrollHeight;
    // (Auto-response removed: no bot replies after sending a message)

  }
  
  // Event listeners for sending messages
  sendButton.addEventListener('click', sendMessage);
  
  chatInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
  
  // Home button functionality
  const homeButton = document.getElementById('homeButton');
  const chatUserInfo = document.getElementById('chatUserInfo');
  const chatHomeView = document.getElementById('chatHomeView');
  
  homeButton.addEventListener('click', function() {
    // Use the centralized handler to fully reset state
    if (typeof showHomeView === 'function') {
      showHomeView();
    }
  });
  
  // Add Friend and Pending functionality
  const homeAddFriendBtn = document.getElementById('homeAddFriendBtn');
  const pendingBtn = document.getElementById('pendingBtn');
  const pendingOverlay = document.getElementById('pendingOverlay');
  const closePending = document.getElementById('closePending');
  
  // Add Friend popup helpers
  let _addFriend_prevFocus = null;
  let _addFriend_keyHandler = null;
  let _addFriend_clickHandler = null;

  function trapFocusInOverlay(overlay, e) {
    if (e.key !== 'Tab') return;
    const focusable = overlay.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    if (!focusable.length) return;
    const first = focusable[0];
    const last = focusable[focusable.length - 1];
    if (e.shiftKey) {
      if (document.activeElement === first) {
        last.focus();
        e.preventDefault();
      }
    } else {
      if (document.activeElement === last) {
        first.focus();
        e.preventDefault();
      }
    }
  }

  // Friends button handler (replaces Add Friend popup with integrated view)
  var homeAddFriendBtnEl = document.getElementById('homeAddFriendBtn');
  if (homeAddFriendBtnEl) {
    homeAddFriendBtnEl.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      if (typeof showFriendsView === 'function') {
        showFriendsView('all');
      }
    });
  }
  
  
  const regUsername = document.getElementById('registerUsername');
  const regGmail = document.getElementById('registerGmail');
  const regPassword = document.getElementById('registerPassword');
  const confirmPassword = document.getElementById('confirmPassword');
  regUsername.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      regGmail.focus();
    }
  });
  regGmail.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      regPassword.focus();
    }
  });
  regPassword.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      confirmPassword.focus();
    }
  });
  confirmPassword.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      handleRegisterWithLoading();
    }
  });
  const codeInputs = document.querySelectorAll('.code-input');
  codeInputs.forEach((input, index) => {
    input.addEventListener('input', function() {
      if (this.value.length === 1 && index < codeInputs.length - 1) {
        codeInputs[index + 1].focus();
      }
    });
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Backspace' && this.value.length === 0 && index > 0) {
        codeInputs[index - 1].focus();
      } else if (e.key === 'Enter' && index === codeInputs.length - 1) {
        e.preventDefault();
        handleVerificationWithLoading();
      }
    });
  });
  
  // Only add paste event listener if codeInputs exists and has elements
  if (codeInputs && codeInputs.length > 0) {
    codeInputs[0].addEventListener('paste', function(e) {
      e.preventDefault();
      const pastedData = (e.clipboardData || window.clipboardData).getData('text').trim();
      if (/^\d{6}$/.test(pastedData)) {
        const digits = pastedData.split('');
        codeInputs.forEach((input, index) => {
        input.value = digits[index] || '';
      });
      codeInputs[codeInputs.length - 1].focus();
    }
  });
}
  const contactSubject = document.getElementById('contactSubject');
  const contactMessage = document.getElementById('contactMessage');
  contactSubject.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      contactMessage.focus();
    }
  });
  contactMessage.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendContactEmail();
    }
  });
  
  // Toggle the pending requests overlay
  function togglePendingRequestsPopup() {
    const pendingOverlay = document.getElementById('pendingOverlay');
    const pendingBtn = document.querySelector('.nav-btn[onclick*="togglePendingRequestsPopup"]');
    
    if (!pendingOverlay) return;
    
    // Toggle the overlay
    const isVisible = window.getComputedStyle(pendingOverlay).display !== 'none';
    
    if (isVisible) {
      closePendingOverlay();
    } else {
      // Show the overlay and load requests
      pendingOverlay.style.display = 'flex';
      if (pendingBtn) {
        pendingBtn.classList.add('active');
      }
      // Load the requests
      showPendingRequestsPopup();
    }
  }
  
  // Make the function available globally
  window.togglePendingRequestsPopup = togglePendingRequestsPopup;
  
  // Function to update pending requests count badge
  function updatePendingCount(count) {
    const pendingCount = document.getElementById('pendingCount');
    if (!pendingCount) return;
    
    if (count && count > 0) {
      pendingCount.textContent = count;
      pendingCount.style.display = 'inline-block';
    } else {
      pendingCount.style.display = 'none';
    }
  }
  
// Show Pending Requests popup and load friend requests
async function showPendingRequestsPopup() {
  const pendingOverlay = document.getElementById('pendingOverlay');
  const pendingRequestsList = document.getElementById('pendingRequestsList');
  const pendingDebug = document.getElementById('pendingDebug');
  
  if (!pendingOverlay || !pendingRequestsList) {
    console.error('Required elements not found');
    return;
  }

  // Show the overlay
  pendingOverlay.style.display = 'flex';
  pendingOverlay.style.zIndex = '2000';
  
  // Show loading state
  pendingRequestsList.innerHTML = '<div class="loading-message">Loading friend requests...</div>';
  
  // Show debug info
  if (pendingDebug) {
    pendingDebug.style.display = 'block';
    pendingDebug.textContent = 'Initializing...';
  }

  try {
    // Get UUID from the current user data
    const myUUID = window.currentUserData?.uuid;
    if (!myUUID) {
      const errorMsg = 'User not logged in or UUID not found';
      console.error(errorMsg);
      pendingRequestsList.innerHTML = `<div class="error-message">${errorMsg}</div>`;
      if (pendingDebug) {
        pendingDebug.textContent += `\n${errorMsg}`;
      }
      return;
    }

    console.log('Fetching friend requests for UUID:', myUUID);
    
    // Check if endpoint is defined
    if (typeof pendingFR === 'undefined') {
      const errorMsg = 'API endpoint for pending friend requests is not defined';
      console.error(errorMsg);
      pendingRequestsList.innerHTML = `<div class="error-message">${errorMsg}</div>`;
      if (pendingDebug) {
        pendingDebug.textContent += `\n${errorMsg}`;
      }
      return;
    }

    const url = `${pendingFR}?uuid=${encodeURIComponent(myUUID)}`;
    console.log('API URL:', url);

    // Make the API request
    console.log(`PENDING BUTTON - Fetching friend requests with UUID: ${myUUID}`);
    console.log(`PENDING BUTTON - Endpoint URL: ${url}`);
    
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const result = await response.json();
    console.log('PENDING BUTTON - Friend requests response:', result);
    
    if (pendingDebug) {
      pendingDebug.textContent += `\nResponse: ${JSON.stringify(result, null, 2)}`;
    }

    // Extract pending requests from the response
    let requests = [];
    if (result && result.status === 'success' && Array.isArray(result.pendingRequests)) {
      requests = result.pendingRequests;
      console.log('PENDING BUTTON - Pending requests array:', requests);
    } else if (Array.isArray(result)) {
      // Fallback for array response
      requests = result;
      console.log('PENDING BUTTON - Received array response:', requests);
    } else if (result && typeof result === 'object') {
      // Fallback for object response
      requests = Object.values(result).filter(val => typeof val === 'string');
      console.log('PENDING BUTTON - Extracted usernames from object:', requests);
    }
    
    console.log('Processed pending requests:', requests);
    
    // Update the UI using the existing structure
    if (requests.length === 0) {
      pendingRequestsList.innerHTML = '<div class="empty-state">No pending friend requests</div>';
    } else {
      // Clear existing content
      pendingRequestsList.innerHTML = '';
      
      // Add each request to the list
      requests.forEach(username => {
        if (!username) return; // Skip invalid entries
        
        const requestHTML = `
          <div class="pending-request">
            <img class="request-avatar" src="https://i.pravatar.cc/150?img=${Math.floor(Math.random() * 10)}" alt="User Avatar">
            <div class="request-details">
              <span class="username">${username}</span>
              <span class="request-time">Just now</span>
            </div>
            <div class="request-actions">
              <button class="accept-button" data-username="${username}">Accept</button>
              <button class="decline-button" data-username="${username}">Decline</button>
            </div>
          </div>
        `;
        pendingRequestsList.insertAdjacentHTML('beforeend', requestHTML);
      });

      // Add event listeners for accept/decline buttons
      document.querySelectorAll('.accept-button').forEach(button => {
        button.addEventListener('click', (e) => {
          e.stopPropagation();
          const username = button.getAttribute('data-username');
          console.log('Accepting request from:', username);
          if (window.acceptFriendRequest) {
            window.acceptFriendRequest(username);
          } else {
            console.error('acceptFriendRequest function not found');
          }
        });
      });

      document.querySelectorAll('.decline-button').forEach(button => {
        button.addEventListener('click', (e) => {
          e.stopPropagation();
          const username = button.getAttribute('data-username');
          console.log('Declining request from:', username);
          if (window.declineFriendRequest) {
            window.declineFriendRequest(username);
          } else {
            console.error('declineFriendRequest function not found');
          }
        });
      });
    }
    
  } catch (error) {
    console.error('Error fetching pending requests:', error);
    const errorMessage = error.message || 'Failed to load friend requests';
    pendingRequestsList.innerHTML = `<div class="error-message">${errorMessage}</div>`;
    
    if (pendingDebug) {
      pendingDebug.textContent += `\nError: ${errorMessage}\n${error.stack || ''}`;
    }
  } finally {
    // Ensure the overlay is still visible even if there was an error
    if (pendingOverlay) {
      pendingOverlay.style.display = 'flex';
    }
  }
}
  
  // Functions to accept/decline friend requests
  async function acceptFriendRequest(username) {
    try {
      // Get UUID from the current user data (which was set during login)
      let myUUID;
      
      if (window.currentUserData && window.currentUserData.uuid) {
        // Use the UUID from the current session
        myUUID = window.currentUserData.uuid;
        console.log('Using UUID from current session for accepting friend request:', myUUID);
      } else {
        // If UUID is not available in session, show error
        showAlert('You must be logged in to accept friend requests. Please log in again.', 'error');
        return;
      }
      
      // Build the parameters for accepting the friend request
      const formData = new URLSearchParams();
      formData.append('myUUID', myUUID);
      formData.append('theirUsername', username);
      formData.append('action', 'accept');
      
      // Show loading state
      const button = document.querySelector(`.accept-button[data-username="${username}"]`);
      const originalText = button.textContent;
      button.textContent = 'Accepting...';
      button.disabled = true;
      
      // Send the accept request as POST
      const response = await fetch(Acc_DenF, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: formData,
        mode: 'cors',
        credentials: 'omit'
      });
      const result = await response.json();
      
      if (result.status === 'success') {
        // Remove this friend request from the UI
        const requestElement = button.closest('.pending-request');
        requestElement.innerHTML = `<div class="success-message">Friend request from ${username} accepted!</div>`;
        setTimeout(() => {
          requestElement.remove();
          
          // Update the pending count
          const pendingCount = document.querySelectorAll('.pending-request').length;
          updatePendingCount(pendingCount);
          
          // If no more requests, show empty state
          if (pendingCount === 0) {
            document.getElementById('pendingRequestsList').innerHTML = '<div class="empty-state">No current friend requests</div>';
          }
        }, 2000);
      } else {
        // Show error
        alert(`Error: ${result.message || 'Could not accept friend request'}`);
        button.textContent = originalText;
        button.disabled = false;
      }
    } catch (error) {
      console.error('Error accepting friend request:', error);
      alert(`Error: ${error.message}`);
    }
  }
  
  async function declineFriendRequest(username) {
    try {
      // Get UUID from the current user data (which was set during login)
      let myUUID;
      
      if (window.currentUserData && window.currentUserData.uuid) {
        // Use the UUID from the current session
        myUUID = window.currentUserData.uuid;
        console.log('Using UUID from current session for declining friend request:', myUUID);
      } else {
        // If UUID is not available in session, show error
        showAlert('You must be logged in to decline friend requests. Please log in again.', 'error');
        return;
      }
      
      // Build the parameters for declining the friend request
      const formData = new URLSearchParams();
      formData.append('myUUID', myUUID);
      formData.append('theirUsername', username);
      formData.append('action', 'deny');
      
      // Show loading state
      const button = document.querySelector(`.decline-button[data-username="${username}"]`);
      const originalText = button.textContent;
      button.textContent = 'Declining...';
      button.disabled = true;
      
      // Send the decline request as POST
      const response = await fetch(Acc_DenF, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: formData,
        mode: 'cors',
        credentials: 'omit'
      });
      const result = await response.json();
      
      if (result.status === 'success') {
        // Remove this friend request from the UI
        const requestElement = button.closest('.pending-request');
        requestElement.innerHTML = `<div class="info-message">Friend request from ${username} declined.</div>`;
        setTimeout(() => {
          requestElement.remove();
          
          // Update the pending count
          const pendingCount = document.querySelectorAll('.pending-request').length;
          updatePendingCount(pendingCount);
          
          // If no more requests, show empty state
          if (pendingCount === 0) {
            document.getElementById('pendingRequestsList').innerHTML = '<div class="empty-state">No current friend requests</div>';
          }
        }, 2000);
      } else {
        // Show error
        alert(`Error: ${result.message || 'Could not decline friend request'}`);
        button.textContent = originalText;
        button.disabled = false;
      }
    } catch (error) {
      console.error('Error in declineFriendRequest:', error);
      alert('An error occurred while processing your request');
      button.textContent = originalText;
      button.disabled = false;
    }
  }
  // Expose fetchUserPermission globally for use in displayDirectMessages
  if (typeof fetchUserPermission !== 'undefined') {
    window.fetchUserPermission = fetchUserPermission;
  } else if (typeof window.showUserProfile === 'function') {
    // Try to extract from showUserProfile closure
    try {
      const fnStr = window.showUserProfile.toString();
      if (fnStr.includes('fetchUserPermission')) {
        // Not ideal, but in case of closure, re-define a wrapper
        window.fetchUserPermission = async function(username) {
          return await window.showUserProfile({ username, exposePermission: true });
        };
        }
      } catch (e) {}
    }

    document.addEventListener('DOMContentLoaded', function() {
    

    // Helper: Section header
    function sectionHeader(label) {
      return { label, icon: '', disabled: true, isHeader: true };
    }

    // Robust context menu initialization
    function initializeContextMenus() {
      // Helper to prevent duplicate attachments
      function attachIfNotAttached(el, menuItems) {
        if (!el || typeof attachCustomContextMenu !== 'function') return;
        if (el.dataset && el.dataset.ctxAttached === 'true') return;
        try {
          attachCustomContextMenu(el, menuItems);
          if (el.dataset) el.dataset.ctxAttached = 'true';
        } catch (err) {
          console.warn('[ContextMenu] attach failed for', el, err);
        }
      }

      const tryInit = () => {
        if (typeof attachCustomContextMenu !== 'function') {
          setTimeout(tryInit, 100);
          return;
        }

        // Default (body) menu
        try {
          attachIfNotAttached(document.body, [
            { label: 'Refresh', icon: '🔄', onClick: () => location.reload() },
            { label: 'Test Alert', icon: 'ℹ️', onClick: () => showAlert('This is V1 of the alert system.', 'info') },
            { label: 'Disabled', icon: '🚫', disabled: true }
          ]);
        } catch (e) { console.warn('[ContextMenu] Body attach failed', e); }

        // DM Bar (sidebar-nav)
        try {
          const dmBar = document.querySelector('.sidebar-nav');
          if (dmBar) {
            attachIfNotAttached(dmBar, [
              sectionHeader('Direct Messages'),
              { label: 'Add Friend', icon: '➕', onClick: () => { if (typeof showFriendsView === 'function') showFriendsView('add'); } },
              { label: 'Mark All Read', icon: '✅', onClick: () => showAlert('All messages have been marked as read', 'success') }
            ]);
          }
        } catch (e) { console.warn('[ContextMenu] DM bar attach failed', e); }

        // Home Add Friend button
        try {
          const homeAddFriendBtnCM = document.getElementById('homeAddFriendBtn');
          if (homeAddFriendBtnCM) {
            const labelAddFriend = (typeof t === 'function') ? t('addFriend') : 'Add Friend';
            const labelPending = (typeof t === 'function') ? t('friendRequests') : 'Friend Requests';
            const afMenu = [
              { label: labelAddFriend, icon: '➕', shortcut: 'Enter', onClick: () => { if (typeof showFriendsView === 'function') showFriendsView('add'); } },
              { label: labelPending, icon: '📫', shortcut: 'P', onClick: () => { if (typeof showFriendsView === 'function') showFriendsView('pending'); } },
            ];
            attachIfNotAttached(homeAddFriendBtnCM, afMenu);
            // Keyboard open
            homeAddFriendBtnCM.addEventListener('keydown', function(ev) {
              if (ev.key === 'ContextMenu' || (ev.shiftKey && ev.key === 'F10')) {
                ev.preventDefault();
                const rect = homeAddFriendBtnCM.getBoundingClientRect();
                const x = Math.round(rect.left + rect.width / 2);
                const y = Math.round(rect.top + rect.height);
                if (typeof showCustomContextMenuAt === 'function') {
                  showCustomContextMenuAt(x, y, afMenu, homeAddFriendBtnCM);
                }
              }
              if (ev.key === 'Enter') { ev.preventDefault(); if (typeof showFriendsView === 'function') showFriendsView('add'); }
              if (ev.key.toLowerCase && ev.key.toLowerCase() === 'p') { ev.preventDefault(); if (typeof showFriendsView === 'function') showFriendsView('pending'); }
            });
          }
        } catch (e) { console.warn('[ContextMenu] Home Add Friend attach failed', e); }

        // Sidebar (empty area)
        try {
          const sidebar = document.querySelector('.sidebar');
          if (sidebar) {
            attachIfNotAttached(sidebar, [
              sectionHeader('Sidebar'),
              { label: 'Collapse Sidebar', icon: '⬅️', onClick: () => showAlert('Sidebar collapsed', 'info') },
              { label: 'Settings', icon: '⚙️', onClick: () => document.getElementById('openUserSettingsBtn').click() }
            ]);
          }
        } catch (e) { console.warn('[ContextMenu] Sidebar attach failed', e); }

        // Chat topbar
        try {
          const chatTopbar = document.querySelector('.chat-topbar');
          if (chatTopbar) {
            attachIfNotAttached(chatTopbar, [
              sectionHeader('Chat'),
              { label: 'Home', icon: '🏠', onClick: () => { if (typeof showHomeView === 'function') showHomeView(); } },
              { label: 'Settings', icon: '⚙️', onClick: () => document.getElementById('openUserSettingsBtn')?.click() },
            ]);
          }
        } catch (e) { console.warn('[ContextMenu] Chat topbar attach failed', e); }

        // Shared menu for chat-messages and chat-home-view
        try {
          const labelAddFriend = (typeof t === 'function') ? t('addFriend') : 'Add Friend';
          const labelPending = (typeof t === 'function') ? t('friendRequests') : 'Friend Requests';
          const sharedChatMenu = [
            sectionHeader('Chat'),
            { label: labelAddFriend, icon: '➕', onClick: () => { if (typeof showFriendsView === 'function') showFriendsView('add'); } },
            { label: labelPending, icon: '📫', onClick: () => { if (typeof showFriendsView === 'function') showFriendsView('pending'); } },
          ];
          const nodes = document.querySelectorAll('.chat-messages, .chat-home-view, #chatMessages, #chatHomeView');
          nodes.forEach(node => attachIfNotAttached(node, sharedChatMenu));
        } catch (e) { console.warn('[ContextMenu] Chat views attach failed', e); }

        // Chat container fallback
        try {
          const chatContainer = document.getElementById('chatContainer');
          if (chatContainer) {
            attachIfNotAttached(chatContainer, [
              sectionHeader('Chat'),
              { label: 'Add Friend', icon: '➕', onClick: () => { if (typeof showFriendsView === 'function') showFriendsView('add'); } },
              { label: 'Friend Requests', icon: '📫', onClick: () => { if (typeof showFriendsView === 'function') showFriendsView('pending'); } },
            ]);
          }
        } catch (e) { console.warn('[ContextMenu] Chat container attach failed', e); }

        // Sidebar footer
        try {
          const footerNodes = document.querySelectorAll('.sidebar-footer, .sidebar-footer-inner');
          footerNodes.forEach(node => {
            try {
              attachIfNotAttached(node, [
                sectionHeader('Profile'),
                { label: 'View Profile', icon: '👤', onClick: () => { if (typeof openSelfProfile === 'function') openSelfProfile(); } },
                { label: 'Settings', icon: '⚙️', onClick: () => document.getElementById('openUserSettingsBtn')?.click() },
                { label: 'Logout', icon: '🚪', onClick: () => { if (typeof handleLogout === 'function') handleLogout(); } },
              ]);
            } catch (err) { /* per-node failure */ }
          });
        } catch (e) { console.warn('[ContextMenu] Sidebar footer attach failed', e); }
      };
      tryInit();
    }

    // Initialize now and re-run after a short delay for late-loaded scripts
    initializeContextMenus();
    setTimeout(initializeContextMenus, 500);
    // Re-run when sidebar is rebuilt
    document.addEventListener('sidebarReinitialized', initializeContextMenus);

    // Observe for dynamic DOM changes that might replace targets
    (function setupContextMenuObserver() {
      try {
        const targets = ['.chat-messages', '.chat-home-view', '#chatMessages', '#chatHomeView', '.sidebar-nav', '.sidebar-footer', '.sidebar-footer-inner'];
        const observer = new MutationObserver(() => {
          // Re-run initialization to ensure menus are reattached
          initializeContextMenus();
        });
        observer.observe(document.body, { childList: true, subtree: true });
        // Also re-run after a short idle period in case of heavy DOM churn
        let rearm;
        document.addEventListener('click', () => {
          clearTimeout(rearm);
          rearm = setTimeout(initializeContextMenus, 250);
        });
      } catch (err) {
        console.warn('[ContextMenu] MutationObserver setup failed', err);
      }
    })();

      

      // Attach to each DM user (li.dm-user) when DMs are rendered
      function attachDMUserMenus() {
        document.querySelectorAll('li.dm-user').forEach(function(dmEl) {
          attachCustomContextMenu(dmEl, [
            sectionHeader('Direct Message'),
            { label: 'View Profile', icon: '👤', onClick: () => {
  window.profileOpenTriggered = true;
  // Open modal instantly with minimal info and spinner for badge
  showUserProfile({
    username: dmEl.dataset.username || dmEl.textContent,
    avatarUrl: dmEl.querySelector('img').src,
    badge: undefined, // let the modal fetch badge asynchronously
    bio: dmEl.dataset.bio || 'Loading...',
    email: dmEl.dataset.email || ''
  });
} },
            { label: 'Open Chat', icon: '💬', onClick: () => { 
                const username = dmEl.dataset.username || dmEl.textContent; 
                showAlert(`Opening chat with ${username}...`, 'info'); 
              } 
            },
            { label: 'Copy Username', icon: '📋', onClick: () => { 
                const username = dmEl.dataset.username || dmEl.textContent; 
                navigator.clipboard.writeText(username); 
                showAlert(`Username '${username}' copied to clipboard`, 'success'); 
              } 
            },
            { label: 'Block', icon: '🚫', onClick: () => { 
                const username = dmEl.dataset.username || dmEl.textContent;
                showAlert(`Are you sure you want to block ${username}?`, 'warning', {
                  buttons: ['Cancel', 'Block'],
                  onConfirm: () => showAlert(`${username} has been blocked`, 'success')
                });
              } 
            },
            { label: 'Remove Friend', icon: '❌', onClick: () => {
                const username = dmEl.dataset.username || dmEl.textContent;
                showAlert(`Remove ${username} from your friends?`, 'warning', {
                  buttons: ['Cancel', 'Remove'],
                  onConfirm: () => showAlert(`${username} has been removed from your friends`, 'success')
                });
              }
            }
          ]);
        });
      }

      // Attach on initial load and whenever DMs are re-rendered
      attachDMUserMenus();
      // If displayDirectMessages is called elsewhere, call attachDMUserMenus after it runs
      var origDisplayDirectMessages = window.displayDirectMessages;
      if (typeof origDisplayDirectMessages === 'function') {
        window.displayDirectMessages = function() {
          origDisplayDirectMessages.apply(this, arguments);
          attachDMUserMenus();
        };
      }

      // Sidebar footer avatar profile context menu
      var sidebarFooter = document.querySelector('.sidebar-footer-inner');
      if (sidebarFooter) {
        var userAvatar = sidebarFooter.querySelector('img.user-avatar');
        if (userAvatar) {
          attachCustomContextMenu(userAvatar, [
            { label: 'View Profile', icon: '👤', onClick: function() {
                window.profileOpenTriggered = true;
                const userData = window.currentUserData || {};
                showUserProfile({
                  username: userData.username || 'YourUsername',
                  avatarUrl: userAvatar.src,
                  badge: undefined,
                  email: userData.email || '',
                  bio: userData.bio || ''
                });
              }
            }
          ]);
        }
      }
    });
    
    // Legacy overlay alert (unused)
window.showAlertLegacyOverlay = (message, options = {}) => {
    // showAlert invoked
    const defaultOptions = {
      title: 'TFG Notification',
      type: 'info', // info, success, warning, error
      buttons: ['OK'],
      onConfirm: () => {},
      onCancel: () => {},
      timeout: 0 // milliseconds, 0 means no auto-close
    };
  
    const settings = { ...defaultOptions, ...options };
  // Delegate to Cosmic Alert if available; otherwise queue and return to avoid overlay errors
  try {
    const normalizedType = settings.type || 'info';
    if (typeof window.__cosmicShowAlert === 'function') {
      return window.__cosmicShowAlert(message, normalizedType, settings);
    }
    window.__alertQueue = window.__alertQueue || [];
    window.__alertQueue.push({ message, type: normalizedType, options: settings });
    return Promise.resolve(true);
  } catch (_) {}
  return Promise.resolve(true);
  
  // Stop legacy overlay logic
  return;
  
  // Get existing elements
  const overlay = document.getElementById('AlertOverlay');
  const alert = document.getElementById('Alert');
    
    if (!overlay) {
      console.error('AlertOverlay not found in the DOM');
      return;
    }
    if (!alert) {
      console.error('Alert element not found in the DOM');
      return;
    }
    
    const messageDiv = alert.querySelector('.alert-message');
    const closeButton = alert.querySelector('#AlertClose');
    const titleElement = alert.querySelector('.alert-title');
  
    // Update content
    titleElement.textContent = settings.title;
    messageDiv.textContent = message;
    
    // Reset and set alert type
    alert.className = 'alert';
    if (settings.type) {
      alert.classList.add(`alert--${settings.type}`);
    }
  
    // Show alert with high z-index
    overlay.style.display = 'flex';
    overlay.style.zIndex = '999999';
    console.log('Overlay display set to flex, zIndex set to 999999');
    
    // Force reflow
    void overlay.offsetWidth;
    
    // Add fade-in class
    overlay.classList.add('fade-in');
    overlay.setAttribute('aria-hidden', 'false');
    console.log('Added fade-in class and set aria-hidden to false');
    
    // Log computed styles for debugging
    const computedOverlay = window.getComputedStyle(overlay);
    console.log('Overlay computed styles:', {
      display: computedOverlay.display,
      visibility: computedOverlay.visibility,
      opacity: computedOverlay.opacity,
      zIndex: computedOverlay.zIndex
    });
  
    // Remove any existing event listeners to prevent duplicates
    const newCloseButton = closeButton.cloneNode(true);
    closeButton.parentNode.replaceChild(newCloseButton, closeButton);
    
    // Add close handlers
    newCloseButton.addEventListener('click', closeAlert);
    
    // Handle overlay click
    const handleOverlayClick = (e) => {
      if (e.target === overlay) {
        closeAlert();
      }
    };
    overlay.addEventListener('click', handleOverlayClick);
  
    // Auto-close if timeout is set
    if (settings.timeout > 0) {
      setTimeout(closeAlert, settings.timeout);
    }
    
    return new Promise((resolve) => {
      const resolvePromise = () => {
        const result = {
          action: settings.buttons.includes('OK') || settings.buttons.includes('Confirm') ? 'confirm' : 'cancel',
          message
        };
        resolve(result);
      };
      
      // Add event listeners for buttons
      const okButton = alert.querySelector('.alert-button');
      if (okButton) {
        okButton.addEventListener('click', () => {
          resolvePromise();
          closeAlert();
        });
      }
      
      // Return cleanup function
      return () => {
        overlay.removeEventListener('click', handleOverlayClick);
        newCloseButton.removeEventListener('click', closeAlert);
        if (okButton) {
          okButton.removeEventListener('click', resolvePromise);
        }
      };
    });
  };
    
    // Cosmic Alert element references and config
    var alertElement = null;
    var closeButton = null;
    var okButton = null;
    var messageElement = null;
    var titleElement = null;
    const alertTypes = {
      'info': { title: 'Information', color: '#7289da' },
      'success': { title: 'Success', color: '#43b581' },
      'warning': { title: 'Warning', color: '#faa61a' },
      'error': { title: 'Error', color: '#f04747' }
    };
  
    // Current resolve function for the Promise
    let currentResolve = null;
    
    // Handle keyboard events
    function handleKeyDown(e) {
      const alertElement = document.getElementById('cosmic-alert');
      if (!alertElement || !alertElement.classList.contains('show')) return;
      const okButton = alertElement.querySelector('.cosmic-alert-button');

      if (e.key === 'Escape') {
        e.preventDefault();
        hideAlert();
      } else if (e.key === 'Enter' && document.activeElement === okButton) {
        e.preventDefault();
        hideAlert();
      } else if (e.key === 'Tab') {
        // Trap focus within the alert
        const focusable = Array.from(alertElement.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'));
        if (focusable.length === 0) return;
        
        const firstFocusable = focusable[0];
        const lastFocusable = focusable[focusable.length - 1];
        
        if (e.shiftKey && document.activeElement === firstFocusable) {
          e.preventDefault();
          lastFocusable.focus();
        } else if (!e.shiftKey && document.activeElement === lastFocusable) {
          e.preventDefault();
          firstFocusable.focus();
        }
      }
    }
    
    // Show alert function with support for confirmation dialogs and auto-dismiss
    let lastShowTs = 0;
    function showAlert(message, type = 'info', options = {}) {
      // Ensure element refs are available
      if (!alertElement) {
        alertElement = document.getElementById('cosmic-alert');
        if (alertElement) {
          closeButton = alertElement.querySelector('.cosmic-alert-close');
          okButton = alertElement.querySelector('.cosmic-alert-button');
          messageElement = alertElement.querySelector('.cosmic-alert-message');
          titleElement = alertElement.querySelector('.cosmic-alert-title');
        }
      }
      if (!alertElement) {
        return Promise.resolve(false);
      }
      return new Promise((resolve) => {
        // Clear any existing timeouts
        if (window.alertTimeoutId) {
          clearTimeout(window.alertTimeoutId);
          window.alertTimeoutId = null;
        }
        
        // Store the resolve function
        currentResolve = resolve;
        
        // Set message
        if (messageElement) messageElement.textContent = message;
        
        // Debounce rapid calls (ignore if called again within 150ms)
        const nowTs = Date.now();
        if (nowTs - lastShowTs < 150) return resolve(true);
        lastShowTs = nowTs;

        // Set alert type and title
        const config = alertTypes[type] || alertTypes.info;
        
        // Update alert styling
        alertElement.className = 'cosmic-alert';
        alertElement.classList.add(type);
        alertElement.style.display = 'block';
        alertElement.style.visibility = 'visible';
        alertElement.style.opacity = '1';
        alertElement.style.pointerEvents = 'auto';
        if (titleElement) {
          titleElement.textContent = config.title;
          try { titleElement.style.setProperty('color', '#e5eaff', 'important'); } catch (_) {}
        }
        if (messageElement) {
          try { messageElement.style.setProperty('color', '#e0e6f3', 'important'); } catch (_) {}
        }

        // Enforce header/content colors per type to survive global overrides
        const contentDiv = alertElement.querySelector('.cosmic-alert-content');
        const headerDiv = alertElement.querySelector('.cosmic-alert-header');
        const timerBarEl = alertElement.querySelector('.cosmic-alert-timer');
        const gradientMap = {
          info: 'linear-gradient(90deg, rgba(88,101,242,0.3) 0%, rgba(114,137,218,0.15) 100%)',
          success: 'linear-gradient(90deg, rgba(67,181,129,0.3) 0%, rgba(67,181,129,0.15) 100%)',
          warning: 'linear-gradient(90deg, rgba(250,166,26,0.3) 0%, rgba(250,166,26,0.15) 100%)',
          error: 'linear-gradient(90deg, rgba(240,71,71,0.3) 0%, rgba(240,71,71,0.15) 100%)'
        };
        try {
          if (contentDiv) contentDiv.style.setProperty('border-color', config.color, 'important');
          if (headerDiv) headerDiv.style.setProperty('background', gradientMap[type] || gradientMap.info, 'important');
          if (timerBarEl) timerBarEl.style.setProperty('background', (type==='success'? 'linear-gradient(90deg, #43b581 0%, rgba(67,181,129,0.2) 100%)' : type==='warning'? 'linear-gradient(90deg, #faa61a 0%, rgba(250,166,26,0.2) 100%)' : type==='error' ? 'linear-gradient(90deg, #f04747 0%, rgba(240,71,71,0.2) 100%)' : 'linear-gradient(90deg, #7289da 0%, rgba(114,137,218,0.2) 100%)'), 'important');
        } catch (_) {}
        
        // Handle confirmation dialog
        const actionsDiv = alertElement.querySelector('.cosmic-alert-actions');
        
        if (options.buttons && Array.isArray(options.buttons) && options.buttons.length > 0) {
          // For confirmation dialogs with buttons
          actionsDiv.style.display = 'flex';
          actionsDiv.innerHTML = '';
          
          // Add cancel button
          if (options.buttons[0]) {
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'cosmic-alert-button';
            cancelBtn.textContent = options.buttons[0];
            cancelBtn.onclick = () => {
              hideAlert();
              resolve(false);
            };
            actionsDiv.appendChild(cancelBtn);
          }
          
          // Add confirm button
          if (options.buttons[1]) {
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'cosmic-alert-button confirm';
            confirmBtn.textContent = options.buttons[1];
            confirmBtn.onclick = () => {
              hideAlert();
              if (typeof options.onConfirm === 'function') {
                options.onConfirm();
              }
              resolve(true);
            };
            actionsDiv.appendChild(confirmBtn);
          }
        } else {
          // For auto-dismissing alerts
          actionsDiv.style.display = 'none';
          
          // Set up timer bar and get timeout duration
          const timerBar = alertElement.querySelector('.cosmic-alert-timer');
          // Use provided timeout or default based on type
          const timeoutDuration = options.timeout || (type === 'success' ? 3000 : 5000);
          
          // Reset timer bar
          if (timerBar) {
            // Reset any existing transitions
            timerBar.style.transition = 'none';
            timerBar.style.setProperty('--progress', '1');
            // Force reflow to ensure the reset is applied
            void timerBar.offsetWidth;
            // Start the animation
            timerBar.style.transition = `transform ${timeoutDuration}ms linear`;
            // Animate to collapsed state
            timerBar.style.setProperty('--progress', '0');
          }
          
          // Set timeout to auto-dismiss
          window.alertTimeoutId = setTimeout(() => {
            hideAlert();
            resolve(true);
          }, timeoutDuration);
          
          // Also dismiss on click anywhere on the alert
          const handleClick = () => {
            clearTimeout(window.alertTimeoutId);
            window.alertTimeoutId = null;
            const timerBar = alertElement.querySelector('.cosmic-alert-timer');
            if (timerBar) {
              // Stop any ongoing animation
              timerBar.style.transition = 'none';
              // Reset the timer bar to full width
              timerBar.style.setProperty('--progress', '1');
              // Force reflow to ensure the reset is applied
              void timerBar.offsetWidth;
            }
            alertElement.removeEventListener('click', handleClick);
            hideAlert();
            resolve(true);
          };
          
          // Remove any existing click listeners by using a one-time event
          const alertClickHandler = (e) => {
            if (e.target === alertElement) { // Only trigger for clicks on the alert itself, not its children
              handleClick();
            }
          };
          
          // Remove any existing click handler first
          alertElement.removeEventListener('click', alertClickHandler);
          // Add the new click handler
          alertElement.addEventListener('click', alertClickHandler);
        }
        
        // Trigger reflow
        void alertElement.offsetHeight;
        
        // Show the alert
        alertElement.classList.add('show');
        
        // Focus the first button for confirmation dialogs
        if (actionsDiv.style.display === 'flex') {
          const firstButton = actionsDiv.querySelector('button');
          if (firstButton) firstButton.focus();
        }
      });
    }
    
    // Hide alert function
    function hideAlert() {
      const alertElement = document.getElementById('cosmic-alert');
      if (!alertElement || !alertElement.classList.contains('show')) return;
      
      alertElement.classList.remove('show');
      
      // Call the stored resolve function
      if (currentResolve) {
        currentResolve();
        currentResolve = null;
      }
      
      // Reset after animation
      setTimeout(() => {
        alertElement.style.display = 'none';
        alertElement.className = 'cosmic-alert';
        alertElement.classList.add('info');
      }, 400);
    }
    
    // Initialize the alert system
    function initAlertSystem() {
      // Resolve elements now that DOM markup exists
      const alertElement = document.getElementById('cosmic-alert');
      if (!alertElement) return;
      const closeButton = alertElement.querySelector('.cosmic-alert-close');
      const okButton = alertElement.querySelector('.cosmic-alert-button');
      const messageElement = alertElement.querySelector('.cosmic-alert-message');
      const titleElement = alertElement.querySelector('.cosmic-alert-title');
      // Set initial state
      alertElement.style.display = 'none';
      
      // Add event listeners
      if (closeButton) closeButton.addEventListener('click', hideAlert);
      if (okButton) okButton.addEventListener('click', hideAlert);
      
      // Add keyboard event listener
      document.addEventListener('keydown', handleKeyDown);

      // Hooks and queued alerts: now DOM is ready, expose and flush
      window.__cosmicShowAlert = showAlert;
      window.__cosmicAlertReady = true;
      try {
        if (Array.isArray(window.__alertQueue) && window.__alertQueue.length) {
          const q = window.__alertQueue.splice(0);
          const pick = [...q].reverse().find(it => it && (it.message || (it.options && Array.isArray(it.options.buttons) && it.options.buttons.length > 0)));
          if (pick) showAlert(pick.message || '', pick.type || 'info', pick.options || {});
        }
      } catch (_) {}
      window.__alertQueue = [];
    }
    
    // Initialize the alert system when DOM is loaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initAlertSystem);
    } else {
      initAlertSystem();
    }
    
    // Expose showAlert to the window object
    window.showAlert = showAlert;

    // Backward-compatible wrapper so callers can use (message, type, options) or (message, options)
    (function makeShowAlertCompat(){
      const cosmicBaseShowAlert = showAlert;
      window.showAlert = function(message, typeOrOptions, maybeOptions) {
        let type = 'info';
        let options = {};
        if (typeof typeOrOptions === 'string') {
          type = typeOrOptions || 'info';
          options = maybeOptions || {};
        } else if (typeOrOptions && typeof typeOrOptions === 'object') {
          options = typeOrOptions;
          if (typeof options.type === 'string') type = options.type;
        }
        return cosmicBaseShowAlert(message, type, options);
      };
    })();

</script>
      
      <!-- Cosmic Alert -->
      <div id="cosmic-alert" class="cosmic-alert">
        <div class="cosmic-alert-content">
          <div class="cosmic-alert-header">
            <span class="cosmic-alert-title">Alert</span>
            <button class="cosmic-alert-close" aria-label="Close">
              <svg viewBox="0 0 24 24" width="18" height="18">
                <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
          <div class="cosmic-alert-body">
            <p class="cosmic-alert-message">This is a test message</p>
          </div>
          <div class="cosmic-alert-actions">
            <button class="cosmic-alert-button">OK</button>
          </div>
          <div class="cosmic-alert-timer"></div>
        </div>
      </div>

      <style>
        /* Cosmic Alert Styles */
        .cosmic-alert {
          position: fixed;
          top: 20px;
          left: 50%;
          transform: translateX(-50%) translateY(-100px);
          width: 90%;
          max-width: 500px;
          z-index: 2147483647;
          opacity: 0;
          visibility: hidden;
          transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
          pointer-events: none;
        }

        .cosmic-alert.show {
          transform: translateX(-50%) translateY(0);
          opacity: 1;
          visibility: visible;
          pointer-events: auto;
        }

        .cosmic-alert-content {
          position: relative;
          background: rgba(32, 34, 37, 0.95);
          border-radius: 12px;
          border: 1px solid #7289da;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 
                      0 0 0 1px rgba(114, 137, 218, 0.3),
                      0 0 15px rgba(114, 137, 218, 0.15);
          overflow: visible;
          backdrop-filter: blur(8px);
          -webkit-backdrop-filter: blur(8px);
          transform: translateZ(0);
          padding-bottom: 2px; /* Make room for the timer bar */
        }

        .cosmic-alert-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 14px 20px;
          background: linear-gradient(90deg, rgba(88, 101, 242, 0.3) 0%, rgba(114, 137, 218, 0.15) 100%);
          border-bottom: 1px solid rgba(114, 137, 218, 0.2);
        }

        .cosmic-alert-close {
          color: #bfc4d1;
          background: transparent;
          border: none;
          width: 28px; height: 28px;
          border-radius: 6px;
          transition: background 0.2s ease, color .2s ease;
        }

        .cosmic-alert-close:hover {
          color: #fff;
          background: rgba(255, 255, 255, 0.1);
        }

        .cosmic-alert-close:active {
          transform: scale(0.9);
        }
        /* Added: structure and theming */
        .cosmic-alert * { box-sizing: border-box; }
        .cosmic-alert-title { color: #e5eaff !important; font-weight: 700; font-size: 14px; }
        .cosmic-alert-body { padding: 14px 20px; background: rgba(0,0,0,0.15); }
        .cosmic-alert-message { margin: 0; color: #e0e6f3 !important; line-height: 1.5; }
        .cosmic-alert-content { color: #e0e6f3; }
        .cosmic-alert-header { color: #e5eaff !important; }
        .cosmic-alert-actions { display: none; gap: 10px; justify-content: flex-end; padding: 12px 16px 16px 16px; }
        .cosmic-alert-button { 
          appearance: none; border: 1px solid rgba(114,137,218,0.35); 
          background: rgba(114,137,218,0.1); color: #e5eaff; 
          border-radius: 8px; padding: 8px 14px; cursor: pointer; 
          transition: background .2s ease, transform .08s ease; 
        }
        .cosmic-alert-button:hover { background: rgba(114,137,218,0.2); }
        .cosmic-alert-button:active { transform: scale(0.98); }
        .cosmic-alert-button.confirm { background: #5865f2; border-color: #5865f2; color: #fff; }
        .cosmic-alert-button.confirm:hover { background: #4752c4; border-color: #4752c4; }
        .cosmic-alert-button:focus { outline: 2px solid rgba(114,137,218,0.5); outline-offset: 2px; }

        /* Timer bar */
        .cosmic-alert-timer {
          position: absolute; left: 0; right: 0; bottom: 0; height: 2px;
          background: linear-gradient(90deg, #7289da 0%, rgba(114,137,218,0.2) 100%);
          transform: scaleX(var(--progress, 1)); transform-origin: left;
          transition: transform linear;
        }

        /* Variants */
        .cosmic-alert.info .cosmic-alert-content { border-color: #7289da; }
        .cosmic-alert.info .cosmic-alert-header { background: linear-gradient(90deg, rgba(88,101,242,0.3) 0%, rgba(114,137,218,0.15) 100%); }
        .cosmic-alert.info .cosmic-alert-timer { background: linear-gradient(90deg, #7289da 0%, rgba(114,137,218,0.2) 100%); }

        .cosmic-alert.success .cosmic-alert-content { border-color: #43b581; }
        .cosmic-alert.success .cosmic-alert-header { background: linear-gradient(90deg, rgba(67,181,129,0.3) 0%, rgba(67,181,129,0.15) 100%); }
        .cosmic-alert.success .cosmic-alert-timer { background: linear-gradient(90deg, #43b581 0%, rgba(67,181,129,0.2) 100%); }

        .cosmic-alert.warning .cosmic-alert-content { border-color: #faa61a; }
        .cosmic-alert.warning .cosmic-alert-header { background: linear-gradient(90deg, rgba(250,166,26,0.3) 0%, rgba(250,166,26,0.15) 100%); }
        .cosmic-alert.warning .cosmic-alert-timer { background: linear-gradient(90deg, #faa61a 0%, rgba(250,166,26,0.2) 100%); }

        .cosmic-alert.error .cosmic-alert-content { border-color: #f04747; }
        .cosmic-alert.error .cosmic-alert-header { background: linear-gradient(90deg, rgba(240,71,71,0.3) 0%, rgba(240,71,71,0.15) 100%); }
        .cosmic-alert.error .cosmic-alert-timer { background: linear-gradient(90deg, #f04747 0%, rgba(240,71,71,0.2) 100%); }
      </style>
    <script>
// Simple Profile Overlay Logic
(function() {
  const openBtn = document.getElementById('openProfileOverlayBtn');
  const overlay = document.getElementById('profileOverlay');
  const closeBtn = document.getElementById('closeProfileOverlayBtn');
  if (openBtn && overlay && closeBtn) {
    openBtn.addEventListener('click', () => {
      overlay.style.display = 'flex';
    });
    closeBtn.addEventListener('click', () => {
      overlay.style.display = 'none';
    });
    overlay.addEventListener('mousedown', function(e) {
      if (e.target === overlay) overlay.style.display = 'none';
    });
  }
  // Prevent form submission default
  const form = document.getElementById('profileForm');
  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      // You can add your save logic here
      overlay.style.display = 'none';
      showAlert('Profile changes saved!', 'success');
    });
  }
})();
</script>

<!-- settings sidebar template -->
<template id="settingsSidebarTemplate">
  <button id="closeSettingsSidebarBtn" class="settings-close-btn">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M18 6L6 18M6 6L18 18" stroke="#bfc4d1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>
  
  <div class="sidebar-header">
    <h2 class="sidebar-title">Settings</h2>
    <p class="sidebar-subtitle">Customize your experience</p>
  </div>
  
  <div class="sidebar-content">
    <!-- Account Information -->
    <div class="settings-section">
      <h3 class="section-title">Account Information</h3>
      <div class="setting-item">
        <label>Username</label>
        <span id="accountUsername" class="setting-value">Loading...</span>
      </div>
      <div class="setting-item">
        <label>Email</label>
        <div id="emailContainer" style="display: flex; align-items: center; gap: 8px;">
          <span id="accountEmail" class="setting-value">Loading...</span>
          <button id="emailToggle" class="cosmic-btn secondary" style="padding: 4px 8px; font-size: 0.8em; min-width: auto;">👁️ Show</button>
        </div>
      </div>
      <div class="setting-item">
        <label>Account Status</label>
        <span id="accountStatus" class="setting-value status-online">Active</span>
      </div>
    </div>

    <!-- Account Actions -->
    <div class="settings-section">
      <h3 class="section-title">Account Actions</h3>
      <div class="action-buttons">
        <button class="cosmic-btn danger" onclick="showChangePassword()" style="width: 100%; margin-bottom: 12px;">
          Change Password
        </button>
        <button class="cosmic-btn warning" onclick="showDeleteAccount()" style="width: 100%;">
          Delete Account
        </button>
      </div>
    </div>

    <!-- Privacy Settings -->
    <div class="settings-section">
      <h3 class="section-title">Privacy & Safety</h3>
      <div class="setting-toggle">
        <label>Show online status</label>
        <input type="checkbox" id="showOnlineStatus" checked>
        <span class="toggle-slider"></span>
      </div>
      <div class="setting-toggle">
        <label>Allow direct messages from anyone</label>
        <input type="checkbox" id="allowDMs" checked>
        <span class="toggle-slider"></span>
      </div>
      <div class="setting-toggle">
        <label>Show read receipts</label>
        <input type="checkbox" id="showReadReceipts">
        <span class="toggle-slider"></span>
      </div>
      <div class="setting-action">
        <button class="cosmic-btn secondary" onclick="showBlockedUsers()">View Blocked Users</button>
      </div>
    </div>

    <!-- Appearance Settings -->
    <div class="settings-section">
      <h3 class="section-title">Appearance</h3>
      <div class="theme-options">
        <button class="theme-option active" data-theme="default">
          <div class="theme-preview" style="background: linear-gradient(135deg, #0a0a2a 0%, #1a1a40 50%, #2a1a60 100%);"></div>
          <span>Default</span>
        </button>
        <button class="theme-option" data-theme="dark">
          <div class="theme-preview" style="background: #000;"></div>
          <span>Dark</span>
        </button>
        <button class="theme-option" data-theme="light">
          <div class="theme-preview" style="background: #fff;"></div>
          <span>Light</span>
        </button>
      </div>
      <div class="setting-toggle">
        <label>Compact mode</label>
        <input type="checkbox" id="compactMode">
        <span class="toggle-slider"></span>
      </div>
      <div class="setting-toggle">
        <label>Show animations</label>
        <input type="checkbox" id="showAnimations" checked>
        <span class="toggle-slider"></span>
      </div>
    </div>

    <!-- Notification Settings -->
    <div class="settings-section">
      <h3 class="section-title">Notifications</h3>
      <div class="setting-toggle">
        <label>Enable desktop notifications</label>
        <input type="checkbox" id="desktopNotifications" checked>
        <span class="toggle-slider"></span>
      </div>
      <div class="setting-toggle">
        <label>Sound notifications</label>
        <input type="checkbox" id="soundNotifications" checked>
        <span class="toggle-slider"></span>
      </div>
      <div class="setting-toggle">
        <label>Show message previews</label>
        <input type="checkbox" id="messagePreviews" checked>
        <span class="toggle-slider"></span>
      </div>
      <div class="setting-toggle">
        <label>Notify on friend requests</label>
        <input type="checkbox" id="friendRequestNotifications" checked>
        <span class="toggle-slider"></span>
      </div>
    </div>

    <!-- Language Settings -->
    <div class="settings-section">
      <h3 class="section-title">Language</h3>
      <select id="languageSelect" class="cosmic-select" style="width:100%;padding:12px;border-radius:8px;border:1px solid #4a4a6a;background:rgba(255,255,255,0.05);color:#e0e6f3;">
        <option value="en">English</option>
        <option value="es">Español</option>
        <option value="fr">Français</option>
        <option value="de">Deutsch</option>
      </select>
    </div>
  </div>

  <!-- Logout Button -->
  <div class="settings-logout-section">
    <button id="logoutBtn" class="logout-button cosmic-logout-btn">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" style="vertical-align:middle;margin-right:8px;">
        <path d="M16 17l5-5-5-5M21 12H9" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <rect x="3" y="5" width="8" height="14" rx="2.5" stroke="#fff" stroke-width="2"/>
      </svg>
      Log Out
    </button>
  </div>
</template>

<script>
// User Profile Panel logic
function loadProfilePanel() {
  const user = window.currentUserData || {};
  document.getElementById('profileAvatar').src = document.querySelector('.sidebar-footer-inner .user-avatar')?.src || '';
  document.getElementById('profileUsername').textContent = user.username || 'YourUsername';
  document.getElementById('profileEmail').textContent = user.email || '';
  const bioEl = document.getElementById('profileBio');
  if (bioEl) {
    bioEl.value = user.bio || '';
    bioEl.dataset.initial = bioEl.value;
    // Fetch latest bio from server asynchronously and populate if the user hasn't edited yet
    const uname = user.username || (window.currentUserData && window.currentUserData.username) || '';
    if (uname) {
      (async () => {
        try {
          const latest = await fetchUserBio(uname);
          if (typeof latest === 'string' && latest.length >= 0) {
            // Only update the field if it hasn't been changed since load
            if (bioEl && (bioEl.value === (bioEl.dataset.initial || '') || bioEl.value === '')) {
              bioEl.value = latest;
              bioEl.dataset.initial = latest;
            }
            // Update in-memory cache
            window.currentUserData = window.currentUserData || {};
            window.currentUserData.bio = latest;
          }
        } catch (e) {
          // Silently ignore fetch errors
        }
      })();
    }
  }
  document.getElementById('profileSaveStatus').style.display = 'none';
  const dn = document.getElementById('profileDisplayName');
  if (dn) dn.value = user.displayName || user.username || '';
  const bc = document.getElementById('bannerColorInput');
  if (bc) bc.value = user.bannerColor || '#5865f2';
  const bp = document.getElementById('profileBannerPreview');
  if (bp && bc) bp.style.background = bc.value;
}

// Fetch user's bio from GAS (UserProfile.js contract): action=getBio&username
async function fetchUserBio(username) {
  try {
    const endpoint = window.bioHandler || (window.gasModule && window.gasModule.bioHandler) || '';
    if (!endpoint) return '';
    const url = new URL(endpoint);
    url.searchParams.append('action', 'getBio');
    url.searchParams.append('username', username);
    url.searchParams.append('t', Date.now());
    const resp = await fetch(url.toString(), { mode: 'cors' });
    if (!resp.ok) return '';
    const data = await resp.json();
    return data && data.status === 'success' ? (data.bio || '') : '';
  } catch (e) {
    return '';
  }
}

async function saveProfileChanges(e) {
  e.preventDefault();
  const bio = document.getElementById('profileBio').value;
  const uuid = (window.currentUserData && window.currentUserData.uuid) || '';
  if (!uuid) {
    document.getElementById('profileSaveStatus').style.color = '#a00';
    document.getElementById('profileSaveStatus').textContent = 'No UUID!';
    document.getElementById('profileSaveStatus').style.display = '';
    setTimeout(() => {
      document.getElementById('profileSaveStatus').style.display = 'none';
      document.getElementById('profileSaveStatus').style.color = '#0a0';
      document.getElementById('profileSaveStatus').textContent = 'Saved!';
    }, 1800);
    return;
  }
  try {
    const saveBtn = (e && e.submitter) || (document.querySelector('#profileEditForm button[type="submit"]'));
    if (saveBtn) { saveBtn.disabled = true; saveBtn.textContent = 'Saving...'; }
    const endpoint = window.bioHandler || (window.gasModule && window.gasModule.bioHandler) || '';
    if (!endpoint) throw new Error('bioHandler endpoint not set');
    const formData = new URLSearchParams();
    formData.append('action', 'setBio');
    formData.append('uuid', uuid);
    formData.append('bio', bio);
    const resp = await fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: formData,
      mode: 'cors',
      credentials: 'omit'
    });
    if (!resp.ok) throw new Error('Failed to save bio');
    const data = await resp.json();
    if (!data || String(data.status).toLowerCase() !== 'success') throw new Error('Save bio failed');
    window.currentUserData.bio = bio;
    document.getElementById('profileSaveStatus').style.color = '#0a0';
    document.getElementById('profileSaveStatus').textContent = 'Saved!';
    document.getElementById('profileSaveStatus').style.display = '';
    setTimeout(() => {
      document.getElementById('profileSaveStatus').style.display = 'none';
    }, 1600);
  } catch (err) {
    document.getElementById('profileSaveStatus').style.color = '#a00';
    document.getElementById('profileSaveStatus').textContent = 'Error!';
    document.getElementById('profileSaveStatus').style.display = '';
    setTimeout(() => {
      document.getElementById('profileSaveStatus').style.display = 'none';
      document.getElementById('profileSaveStatus').style.color = '#0a0';
      document.getElementById('profileSaveStatus').textContent = 'Saved!';
    }, 1800);
  }
  finally {
    const saveBtn = document.querySelector('#profileEditForm button[type="submit"]');
    if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'Save Changes'; }
  }
}

document.addEventListener('DOMContentLoaded', function() {
  if (typeof window.bioHandler === 'undefined' && typeof bioHandler !== 'undefined') {
    window.bioHandler = bioHandler;
  }
  const observer = new MutationObserver(function() {
    const panel = document.getElementById('panel-profile');
    if (panel && panel.classList.contains('active')) {
      loadProfilePanel();
    }
  });

  const settingsPanelsRoot = document.querySelector('.settings-panels-container');
  if (settingsPanelsRoot) {
    observer.observe(settingsPanelsRoot, {
      subtree: true,
      attributes: true,
      attributeFilter: ['class']
    });
  } else {
    console.warn('[SettingsSidebar] .settings-panels-container not found at init; observer not attached.');
  }

  // Note: profile form is created later when panels are loaded; binding happens in loadSettingsPanels/attachSettingsEventListeners
});

(function() {
  let originalSidebarHTML = null;
  let homeLeaveTimeout = null;
  const sidebar = document.querySelector('.sidebar');
  const settingsTemplate = document.getElementById('settingsSidebarTemplate');

  // Load settings panels into the content area
  function loadSettingsPanels() {
    const panelsContainer = document.querySelector('.settings-panels-container');
    if (!panelsContainer) return;

    panelsContainer.innerHTML = `
      <!-- Account Panel -->
      <div class="settings-panel active" id="panel-account">
        <div class="settings-section">
          <h3>Account Information</h3>
          <div class="setting-item">
            <label>Username</label>
            <span id="accountUsername" class="setting-value">Loading...</span>
          </div>
          <div class="setting-item">
            <label>Email</label>
            <div id="emailContainer" style="display: flex; align-items: center; gap: 8px;">
              <span id="accountEmail" class="setting-value">Loading...</span>
              <button id="emailToggle" class="cosmic-btn secondary" style="padding: 4px 8px; font-size: 0.8em; min-width: auto;">👁️ Show</button>
            </div>
          </div>
          <div class="setting-item">
            <label>Account Status</label>
            <span id="accountStatus" class="setting-value status-online">Active</span>
          </div>
        </div>

        <div class="settings-section">
          <h3>Account Actions</h3>
          <button class="cosmic-btn danger" onclick="showChangePassword()" style="width: 100%; margin-bottom: 12px;">
            Change Password
          </button>
          <button class="cosmic-btn warning" onclick="showDeleteAccount()" style="width: 100%;">
            Delete Account
          </button>
        </div>
      </div>

      <!-- Profile Panel -->
      <div class="settings-panel" id="panel-profile">
        <form id="profileEditForm">
          <div class="settings-section">
            <div style="display:flex;align-items:center;gap:1em;margin-bottom:20px;">
              <img id="profileAvatar" src="" alt="Avatar" style="width:64px;height:64px;border-radius:50%;object-fit:cover;">
              <div style="display:flex;flex-direction:column;">
                <span id="profileUsername" style="font-size:1.2em;font-weight:bold;"></span>
                <span id="profileEmail" style="font-size:0.95em;color:#888;"></span>
              </div>
            </div>
            <div id="profileBannerPreview" style="height:56px;border-radius:10px;border:1px solid rgba(124,191,255,0.2);background:#23235a;margin:0 0 12px 0;"></div>
            <div class="setting-item" style="margin-bottom:12px;">
              <label id="displayNameLabel" style="display:block;margin-bottom:6px;">Display Name</label>
              <input id="profileDisplayName" type="text" placeholder="e.g. Blue" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(124,191,255,0.2);background:rgba(255,255,255,0.05);color:#e5eaff;">
              <div style="color:#888;font-size:0.85em;margin-top:6px;">Not saved yet</div>
            </div>
            <div class="setting-item" style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
              <label style="margin:0;">Banner Color</label>
              <input id="bannerColorInput" type="color" value="#5865f2" style="width:40px;height:28px;border:none;border-radius:6px;background:transparent;padding:0;">
              <div style="color:#888;font-size:0.85em;">Not saved yet</div>
            </div>
            <div class="setting-item" style="display:flex;align-items:center;gap:10px;margin-bottom:14px;">
              <button type="button" id="avatarUploadBtn" class="cosmic-btn secondary">Change Avatar</button>
              <span style="color:#888;font-size:0.9em;">Not saved yet</span>
            </div>
            <label id="aboutMeLabel" style="font-weight:500;">About Me
              <textarea id="profileBio" rows="3" maxlength="250" style="width:100%;resize:vertical;margin-top:8px;"></textarea>
            </label>
            <div style="display:flex;gap:1em;align-items:center;margin-top:16px;">
              <button type="submit" class="cosmic-btn">Save Changes</button>
              <span id="profileSaveStatus" style="color:#0a0;font-size:0.96em;display:none;">Saved!</span>
            </div>
          </div>
        </form>
      </div>

      <!-- Privacy Panel -->
      <div class="settings-panel" id="panel-privacy">
        <div class="settings-section">
          <h3>Privacy Settings</h3>
          <div class="setting-toggle">
            <label>Show online status</label>
            <input type="checkbox" id="showOnlineStatus" checked>
            <span class="toggle-slider"></span>
          </div>
          <div class="setting-toggle">
            <label>Allow direct messages from anyone</label>
            <input type="checkbox" id="allowDMs" checked>
            <span class="toggle-slider"></span>
          </div>
          <div class="setting-toggle">
            <label>Show read receipts</label>
            <input type="checkbox" id="showReadReceipts">
            <span class="toggle-slider"></span>
          </div>
        </div>

        <div class="settings-section">
          <h3>Blocked Users</h3>
          <p style="color:#888;margin-bottom:16px;">Manage users you've blocked</p>
          <button class="cosmic-btn secondary" onclick="showBlockedUsers()">View Blocked Users</button>
        </div>
      </div>

      <!-- Appearance Panel -->
      <div class="settings-panel" id="panel-appearance">
        <div class="settings-section">
          <h3>Theme</h3>
          <div class="theme-options">
            <button class="theme-option active" data-theme="default">
              <div class="theme-preview" style="background: linear-gradient(135deg, #0a0a2a 0%, #1a1a40 50%, #2a1a60 100%);"></div>
              <span>Default</span>
            </button>
            <button class="theme-option" data-theme="dark">
              <div class="theme-preview" style="background: #000;"></div>
              <span>Dark</span>
            </button>
            <button class="theme-option" data-theme="light">
              <div class="theme-preview" style="background: #fff;"></div>
              <span>Light</span>
            </button>
          </div>
        </div>

        <div class="settings-section">
          <h3>Display Settings</h3>
          <div class="setting-toggle">
            <label>Compact mode</label>
            <input type="checkbox" id="compactMode">
            <span class="toggle-slider"></span>
          </div>
          <div class="setting-toggle">
            <label>Show animations</label>
            <input type="checkbox" id="showAnimations" checked>
            <span class="toggle-slider"></span>
          </div>
        </div>
      </div>

      <!-- Notifications Panel -->
      <div class="settings-panel" id="panel-notifications">
        <div class="settings-section">
          <h3>Message Notifications</h3>
          <div class="setting-toggle">
            <label>Enable desktop notifications</label>
            <input type="checkbox" id="desktopNotifications" checked>
            <span class="toggle-slider"></span>
          </div>
          <div class="setting-toggle">
            <label>Sound notifications</label>
            <input type="checkbox" id="soundNotifications" checked>
            <span class="toggle-slider"></span>
          </div>
          <div class="setting-toggle">
            <label>Show message previews</label>
            <input type="checkbox" id="messagePreviews" checked>
            <span class="toggle-slider"></span>
          </div>
        </div>

        <div class="settings-section">
          <h3>Friend Request Notifications</h3>
          <div class="setting-toggle">
            <label>Notify on friend requests</label>
            <input type="checkbox" id="friendRequestNotifications" checked>
            <span class="toggle-slider"></span>
          </div>
        </div>
      </div>

      <!-- Language Panel -->
      <div class="settings-panel" id="panel-language">
        <div class="settings-section">
          <h3>Interface Language</h3>
          <select id="languageSelect" class="cosmic-select">
            <option value="en">English</option>
            <option value="es">Español</option>
            <option value="fr">Français</option>
            <option value="de">Deutsch</option>
          </select>
        </div>
      </div>
    `;
  }

  // Update email display with show/hide functionality
  function updateEmailDisplay(email) {
    const emailContainer = document.getElementById('emailContainer');
    const emailValue = document.getElementById('accountEmail');
    const emailToggle = document.getElementById('emailToggle');

    if (!emailContainer || !emailValue || !emailToggle) return;

    const showEmail = localStorage.getItem('showEmail') === 'true';

    if (showEmail && email !== 'No email set') {
      emailValue.textContent = email;
      emailToggle.textContent = '🙈 Hide';
      emailToggle.title = 'Hide email address';
    } else {
      emailValue.textContent = '••••••••••••••••';
      emailToggle.textContent = '👁️ Show';
      emailToggle.title = 'Show email address';
    }
  }

  // Make updateEmailDisplay globally available
  window.updateEmailDisplay = updateEmailDisplay;

  // Load account information when account panel is active
  function loadAccountInfo() {
    console.log('HTML loadAccountInfo called - currentUserData:', window.currentUserData);
    try {
      const username = window.currentUserData?.username || 'Not logged in';
      const email = window.currentUserData?.email || 'No email set';
      const status = window.currentUserData?.isLoggedIn ? 'Active' : 'Inactive';

      const usernameEl = document.getElementById('accountUsername');
      const statusEl = document.getElementById('accountStatus');

      if (usernameEl) {
        usernameEl.textContent = username;
        console.log('Set username to:', username);
      }
      updateEmailDisplay(email);
      if (statusEl) {
        statusEl.textContent = status;
        statusEl.className = 'setting-value ' + (status === 'Active' ? 'status-online' : '');
      }
    } catch (error) {
      console.error('Error loading account info:', error);
    }
  }

  // Load settings from localStorage
  function loadSettings() {
    try {
      // Privacy settings
      const showOnlineStatus = document.getElementById('showOnlineStatus');
      const allowDMs = document.getElementById('allowDMs');
      const showReadReceipts = document.getElementById('showReadReceipts');

      if (showOnlineStatus) showOnlineStatus.checked = localStorage.getItem('showOnlineStatus') !== 'false';
      if (allowDMs) allowDMs.checked = localStorage.getItem('allowDMs') !== 'false';
      if (showReadReceipts) showReadReceipts.checked = localStorage.getItem('showReadReceipts') === 'true';

      // Appearance settings
      const compactMode = document.getElementById('compactMode');
      const showAnimations = document.getElementById('showAnimations');

      if (compactMode) compactMode.checked = localStorage.getItem('compactMode') === 'true';
      if (showAnimations) showAnimations.checked = localStorage.getItem('showAnimations') !== 'false';

      // Notification settings
      const desktopNotifications = document.getElementById('desktopNotifications');
      const soundNotifications = document.getElementById('soundNotifications');
      const messagePreviews = document.getElementById('messagePreviews');
      const friendRequestNotifications = document.getElementById('friendRequestNotifications');

      if (desktopNotifications) desktopNotifications.checked = localStorage.getItem('desktopNotifications') !== 'false';
      if (soundNotifications) soundNotifications.checked = localStorage.getItem('soundNotifications') !== 'false';
      if (messagePreviews) messagePreviews.checked = localStorage.getItem('messagePreviews') !== 'false';
      if (friendRequestNotifications) friendRequestNotifications.checked = localStorage.getItem('friendRequestNotifications') !== 'false';

      // Language setting
      const languageSelect = document.getElementById('languageSelect');
      if (languageSelect) {
        languageSelect.value = localStorage.getItem('language') || 'en';
        
        // Add event listener for language change
        languageSelect.addEventListener('change', function() {
          const newLang = this.value;
          localStorage.setItem('language', newLang);
          updateLanguage(newLang);
        });
      }

      // Theme setting
      const savedTheme = localStorage.getItem('theme') || 'default';
      document.querySelectorAll('.theme-option').forEach(option => {
        if (option) option.classList.toggle('active', option.dataset.theme === savedTheme);
      });
    } catch (error) {
      console.error('Error loading settings:', error);
    }
  }

  // Attach event listeners for the settings interface
  function attachSettingsEventListeners() {
    try {
      // Email visibility toggle
      const emailToggle = document.getElementById('emailToggle');
      if (emailToggle) {
        emailToggle.addEventListener('click', function() {
          const currentState = localStorage.getItem('showEmail') === 'true';
          const newState = !currentState;
          localStorage.setItem('showEmail', newState.toString());

          const email = window.currentUserData?.email || 'No email set';
          updateEmailDisplay(email);
        });
      }
      // Tab switching
      document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          const panelId = this.dataset.panel;

          // Update active tab
          document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
          this.classList.add('active');

          // Show corresponding panel
          document.querySelectorAll('.settings-panel').forEach(panel => panel.classList.remove('active'));
          const targetPanel = document.getElementById('panel-' + panelId);
          if (targetPanel) targetPanel.classList.add('active');
          if (panelId === 'profile') {
            if (typeof loadProfilePanel === 'function') loadProfilePanel();
            const form = document.getElementById('profileEditForm');
            if (form && !form.dataset.bound) { form.addEventListener('submit', saveProfileChanges); form.dataset.bound = '1'; }
            const avBtn = document.getElementById('avatarUploadBtn');
            if (avBtn && !avBtn.dataset.bound) { avBtn.addEventListener('click', function() { if (typeof showAlert === 'function') showAlert('Avatar uploads are not available yet.', 'info'); }); avBtn.dataset.bound = '1'; }
            const bannerInput = document.getElementById('bannerColorInput');
            if (bannerInput && !bannerInput.dataset.bound) { bannerInput.addEventListener('input', function(){ const prev = document.getElementById('profileBannerPreview'); if (prev) prev.style.background = this.value; }); bannerInput.dataset.bound = '1'; }
          }
        });
      });
      // Done button (closes settings)
      const doneBtn = document.getElementById('settingsDoneBtn');
      if (doneBtn) {
        doneBtn.addEventListener('click', function(e) {
          e.preventDefault();
          hideSettingsSidebar();
        });
      }

      // ESC key handler
      const escHandler = function(e) {
        if (e.key === 'Escape' && document.body.classList.contains('settings-mode')) {
          e.preventDefault();
          hideSettingsSidebar();
          document.removeEventListener('keydown', escHandler);
        }
      };
      document.addEventListener('keydown', escHandler);

      // Store handler for cleanup
      document.body._settingsEscHandler = escHandler;
    } catch (error) {
      console.error('Error attaching settings event listeners:', error);
    }
  }

  function showSettingsSidebar() {
    console.log('Opening integrated settings view');

    // If Friends view is open, close it so we can switch to Settings
    try {
      const fHdr = document.getElementById('friendsHeader');
      const fArea = document.getElementById('friendsContentArea');
      if ((fHdr || fArea) && typeof hideFriendsView === 'function') {
        hideFriendsView();
      }
    } catch (_) {}

    // Prevent duplicate Settings if already present
    const settingsUIOpen = document.getElementById('settingsHeader') || document.getElementById('settingsContentArea');
    if (settingsUIOpen) {
      console.log('Settings already open, ignoring click');
      return;
    }

    // Save current conversation state
    const activeDM = document.querySelector('.dm-user.active');
    if (activeDM) {
      window.lastActiveDM = {
        username: activeDM.dataset.username,
        avatarIndex: activeDM.querySelector('.dm-avatar').src.split('img=')[1]
      };
    } else {
      delete window.lastActiveDM;
    }

    // Enter settings mode
    document.body.classList.add('settings-mode');
    console.log('Added settings-mode class to body');

    const chatContainer = document.getElementById('chatContainer');
    const chatTopbar = chatContainer ? chatContainer.querySelector('.chat-topbar') : null;
    const chatMessages = document.getElementById('chatMessages');
    const chatInputBar = document.querySelector('.chat-input-bar');
    const chatHomeView = document.getElementById('chatHomeView');
    const chatUserInfo = document.getElementById('chatUserInfo');

    if (chatTopbar) {
      chatTopbar.dataset.prevDisplay = chatTopbar.style.display || '';
      chatTopbar.style.display = 'none';
    }
    if (chatHomeView) {
      chatHomeView.dataset.prevDisplay = chatHomeView.style.display || '';
      chatHomeView.style.display = 'none';
    }
    if (chatUserInfo) {
      chatUserInfo.dataset.prevDisplay = chatUserInfo.style.display || '';
      chatUserInfo.style.display = 'none';
    }
    if (chatMessages) {
      chatMessages.dataset.prevDisplay = chatMessages.style.display || '';
      chatMessages.style.display = 'none';
    }
    if (chatInputBar) {
      chatInputBar.dataset.prevDisplay = chatInputBar.style.display || '';
      chatInputBar.style.display = 'none';
    }

    // Create integrated settings layout
    const messagingContainer = document.getElementById('messagingContainer');
    if (messagingContainer) {
      // Remove any existing settings UI before recreating
      const existingHeader = document.getElementById('settingsHeader');
      const existingArea = document.getElementById('settingsContentArea');
      if (existingHeader) existingHeader.remove();
      if (existingArea) existingArea.remove();

      // Create settings header (replaces chat topbar content)
      const settingsHeader = document.createElement('div');
      settingsHeader.id = 'settingsHeader';
      settingsHeader.className = 'settings-header';
      settingsHeader.innerHTML = `
        <div class="settings-header-content">
          <h1 class="settings-title">Settings</h1>
          <p class="settings-subtitle">Customize your experience</p>
        </div>
        <div class="settings-header-actions">
          <button id="settingsDoneBtn" class="cosmic-btn primary">
            <i class="fas fa-check"></i>
            Done
          </button>
        </div>
      `;

      // Create settings content area
      const settingsContentArea = document.createElement('div');
      settingsContentArea.id = 'settingsContentArea';
      settingsContentArea.className = 'settings-content-area';
      settingsContentArea.innerHTML = `
        <div class="settings-tabs-container">
          <div class="settings-tabs">
            <button class="settings-tab active" data-panel="account">
              <i class="fas fa-user"></i>
              <span>Account</span>
            </button>
            <button class="settings-tab" data-panel="profile">
              <i class="fas fa-id-card"></i>
              <span>Profile</span>
            </button>
            <button class="settings-tab" data-panel="privacy">
              <i class="fas fa-shield-alt"></i>
              <span>Privacy</span>
            </button>
            <button class="settings-tab" data-panel="appearance">
              <i class="fas fa-palette"></i>
              <span>Appearance</span>
            </button>
            <button class="settings-tab" data-panel="notifications">
              <i class="fas fa-bell"></i>
              <span>Notifications</span>
            </button>
            <button class="settings-tab" data-panel="language">
              <i class="fas fa-globe"></i>
              <span>Language</span>
            </button>
          </div>
        </div>

        <div class="settings-panels-container">
          <!-- Settings panels will be inserted here -->
        </div>
      `;

      if (chatContainer) {
        if (chatTopbar && chatTopbar.parentNode === chatContainer) {
          chatContainer.insertBefore(settingsHeader, chatTopbar);
        } else {
          chatContainer.insertBefore(settingsHeader, chatContainer.firstChild || null);
        }

        const insertBeforeNode = chatMessages && chatMessages.parentNode === chatContainer
          ? chatMessages
          : (chatInputBar && chatInputBar.parentNode === chatContainer ? chatInputBar : null);

        if (insertBeforeNode) {
          chatContainer.insertBefore(settingsContentArea, insertBeforeNode);
        } else {
          chatContainer.appendChild(settingsContentArea);
        }
      }

      // Load settings panels
      loadSettingsPanels();

      // Restore chat UI on close
      function restoreChatUI() {
        // Remove settings elements
        const settingsHeader = document.getElementById('settingsHeader');
        const settingsContentArea = document.getElementById('settingsContentArea');
        if (settingsHeader) {
          settingsHeader.remove();
        }
        if (settingsContentArea) {
          settingsContentArea.remove();
        }
      }
      // Attach event listeners
      attachSettingsEventListeners();

      // Load initial data
      setTimeout(() => {
        loadAccountInfo();
        loadSettings();
        // Also trigger email update in case it was fetched during login
        if (window.currentUserData?.email) {
          updateEmailDisplay(window.currentUserData.email);
        }
        // Apply saved language
        if (typeof updateLanguage === 'function') {
          const savedLang = localStorage.getItem('language') || 'en';
          updateLanguage(savedLang);
        } else if (typeof updateSettingsLanguage === 'function') {
          const savedLang = localStorage.getItem('language') || 'en';
          currentLanguage = savedLang;
          updateSettingsLanguage();
        }
      }, 100); // Small delay to ensure DOM is ready

      console.log('Integrated settings view opened');
    }
  }

  function hideSettingsSidebar() {
    console.log('Closing integrated settings view');

    // Exit settings mode
    document.body.classList.remove('settings-mode');

    // Remove settings elements
    const settingsHeader = document.getElementById('settingsHeader');
    const settingsContentArea = document.getElementById('settingsContentArea');

    if (settingsHeader) {
      settingsHeader.remove();
    }
    if (settingsContentArea) {
      settingsContentArea.remove();
    }

    // Show original chat elements
    const chatContainer = document.getElementById('chatContainer');
    const chatTopbar = chatContainer ? chatContainer.querySelector('.chat-topbar') : document.querySelector('.chat-topbar');
    const chatHomeView = document.getElementById('chatHomeView');
    const chatUserInfo = document.getElementById('chatUserInfo');
    const chatMessages = document.getElementById('chatMessages');
    const chatInputBar = document.querySelector('.chat-input-bar');

    // Restore displays from stored values
    const restoreDisplay = (el) => {
      if (!el) return;
      const prev = el.dataset ? el.dataset.prevDisplay : undefined;
      el.style.display = typeof prev !== 'undefined' ? prev : '';
      if (el.dataset && Object.prototype.hasOwnProperty.call(el.dataset, 'prevDisplay')) {
        delete el.dataset.prevDisplay;
      }
    };

    // Restore stored display states
    [chatTopbar, chatHomeView, chatUserInfo, chatMessages, chatInputBar].forEach(restoreDisplay);

    // If a DM was active before opening settings, return to it; otherwise show home
    if (window.lastActiveDM) {
      const homeScreen = document.getElementById('homeScreen') || document.querySelector('.home-screen');
      if (homeScreen) homeScreen.style.display = 'none';
      if (chatUserInfo) {
        chatUserInfo.style.display = 'flex';
        chatUserInfo.style.opacity = '1';
      }
      openConversation(window.lastActiveDM.username, window.lastActiveDM.avatarIndex);
      delete window.lastActiveDM;
    } else {
      if (typeof showHomeView === 'function') {
        showHomeView();
      } else {
        const homeScreen = document.getElementById('homeScreen') || document.querySelector('.home-screen');
        if (homeScreen) {
          homeScreen.style.display = '';
          void homeScreen.offsetWidth; // Trigger reflow
          homeScreen.classList.remove('home-leave');
        }
        if (chatHomeView) {
          chatHomeView.style.display = 'flex';
          chatHomeView.style.opacity = '1';
        }
        if (chatUserInfo) {
          chatUserInfo.style.display = 'none';
        }
      }
    }

    // Update the home button state
    updateHomeButtonState();

    // Clean up ESC handler
    if (document.body._settingsEscHandler) {
      document.removeEventListener('keydown', document.body._settingsEscHandler);
      document.body._settingsEscHandler = null;
    }

    console.log('Integrated settings view closed');
  }
  
  // Make hideSettingsSidebar globally accessible
  window.hideSettingsSidebar = hideSettingsSidebar;

  // ===== Integrated Friends View (All / Pending / Add) =====
  function getFriendsList() {
    try {
      if (Array.isArray(window.currentUserData?.friends) && window.currentUserData.friends.length) {
        return window.currentUserData.friends;
      }
      if (Array.isArray(window.currentUserData?.dmUsernames) && window.currentUserData.dmUsernames.length) {
        return window.currentUserData.dmUsernames;
      }
    } catch (_) {}
    return [];
  }

  async function fetchPendingFriendRequests() {
    const myUUID = window.currentUserData?.uuid;
    if (!myUUID || typeof pendingFR === 'undefined') return [];
    try {
      const url = `${pendingFR}?uuid=${encodeURIComponent(myUUID)}`;
      const resp = await fetch(url);
      if (!resp.ok) return [];
      const result = await resp.json();
      if (result && result.status === 'success' && Array.isArray(result.pendingRequests)) return result.pendingRequests.filter(Boolean);
      if (Array.isArray(result)) return result.filter(Boolean);
      if (result && typeof result === 'object') return Object.values(result).filter(v => typeof v === 'string');
      return [];
    } catch (_) { return []; }
  }

  function sendFriendRequestIntegrated(username) {
    const uname = (username || '').trim();
    if (!uname) { showAlert('Please enter a username', 'error'); return; }
    const addBtn = document.getElementById('friendsAddBtn');
    const addInput = document.getElementById('friendsAddInput');
    const myUUID = window.currentUserData?.uuid;
    const myUsername = window.currentUserData?.username;
    if (!myUUID) { showAlert('You must be logged in to send friend requests', 'error'); return; }

    // Prefer app-provided wrapper if available
    if (typeof window.sendFriendRequest === 'function') {
      if (addBtn) { addBtn.disabled = true; addBtn.textContent = 'Sending...'; }
      Promise.resolve(window.sendFriendRequest(uname))
        .then(() => {
          if (addInput) addInput.value = '';
          showAlert(t ? t('friendRequestSent') : 'Friend request sent', 'success');
        })
        .catch(err => showAlert((err && err.message) || 'Failed to send friend request', 'error'))
        .finally(() => { if (addBtn) { addBtn.disabled = false; addBtn.textContent = (typeof t === 'function' ? t('sendRequest') : 'Send Request'); } });
      return;
    }

    // Direct call using addFriReq (robust payload + parsing)
    (async () => {
      let lastErr;
      try {
        if (!window.addFriReq) throw new Error('Missing endpoint');
        const formData = new URLSearchParams();
        // Provide a broad set of common parameter names (server will ignore extras)
        formData.append('action', 'send');
        formData.append('myUUID', myUUID);
        formData.append('uuid', myUUID);
        if (myUsername) formData.append('myUsername', myUsername);
        formData.append('theirUsername', uname);
        formData.append('username', uname);

        if (addBtn) { addBtn.disabled = true; addBtn.textContent = 'Sending...'; }

        const resp = await fetch(window.addFriReq, {
          method: 'POST',
          mode: 'cors',
          credentials: 'omit',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body: formData
        });
        const status = resp.status;
        let text = '';
        let json = null;
        try {
          text = await resp.text();
          try { json = JSON.parse(text); } catch (_) {}
        } catch (_) {}

        if (!resp.ok) throw new Error('HTTP ' + status + (text ? (' ' + text.slice(0, 120)) : ''));

        const ok = (json && (json.status === 'success' || json.ok === true)) || (typeof text === 'string' && /success/i.test(text));
        if (!ok) throw new Error(json?.message || text || 'Unknown response');

        if (addInput) addInput.value = '';
        showAlert(t ? t('friendRequestSent') : 'Friend request sent', 'success');
        // Prefetch pending in background
        try { if (typeof fetchPendingFriendRequests === 'function') fetchPendingFriendRequests(); } catch (_) {}
        return;
      } catch (e) {
        lastErr = e;
      } finally {
        if (addBtn) { addBtn.disabled = false; addBtn.textContent = (typeof t === 'function' ? t('sendRequest') : 'Send Request'); }
      }

      // Fallback: try GET if POST failed (some GAS deployments only parse GET)
      try {
        const url = new URL(window.addFriReq);
        url.searchParams.set('action', 'send');
        url.searchParams.set('myUUID', myUUID);
        url.searchParams.set('uuid', myUUID);
        if (myUsername) url.searchParams.set('myUsername', myUsername);
        url.searchParams.set('theirUsername', uname);
        url.searchParams.set('username', uname);
        const resp2 = await fetch(url.toString(), { method: 'GET', mode: 'cors', cache: 'no-store', credentials: 'omit' });
        const txt2 = await resp2.text();
        let json2 = null; try { json2 = JSON.parse(txt2); } catch (_) {}
        const ok2 = (json2 && (json2.status === 'success' || json2.ok === true)) || /success/i.test(txt2 || '');
        if (!ok2) throw new Error(json2?.message || txt2 || 'Unknown response');
        if (addInput) addInput.value = '';
        showAlert(t ? t('friendRequestSent') : 'Friend request sent', 'success');
        try { if (typeof fetchPendingFriendRequests === 'function') fetchPendingFriendRequests(); } catch (_) {}
      } catch (e2) {
        console.error('[AddFriend] addFriReq failed', { error: e2 });
        // CORS-safe fallbacks for file:// origin
        // 1) Try no-cors POST (opaque success)
        try {
          if (window.addFriReq) {
            const params = new URLSearchParams();
            params.set('action', 'send');
            params.set('myUUID', myUUID);
            params.set('uuid', myUUID);
            if (myUsername) params.set('myUsername', myUsername);
            params.set('theirUsername', uname);
            params.set('username', uname);
            await fetch(window.addFriReq, {
              method: 'POST',
              mode: 'no-cors',
              body: params
            });
            if (addInput) addInput.value = '';
            showAlert(t ? t('friendRequestSent') : 'Friend request sent', 'success');
            setTimeout(() => { try { if (typeof fetchPendingFriendRequests === 'function') fetchPendingFriendRequests(); } catch (_) {} }, 700);
            return;
          }
        } catch (_) {}

        // 2) Try no-cors GET (opaque success)
        try {
          if (window.addFriReq) {
            const urlNC = new URL(window.addFriReq);
            urlNC.searchParams.set('action', 'send');
            urlNC.searchParams.set('myUUID', myUUID);
            urlNC.searchParams.set('uuid', myUUID);
            if (myUsername) urlNC.searchParams.set('myUsername', myUsername);
            urlNC.searchParams.set('theirUsername', uname);
            urlNC.searchParams.set('username', uname);
            await fetch(urlNC.toString(), { method: 'GET', mode: 'no-cors', cache: 'no-store' });
            if (addInput) addInput.value = '';
            showAlert(t ? t('friendRequestSent') : 'Friend request sent', 'success');
            setTimeout(() => { try { if (typeof fetchPendingFriendRequests === 'function') fetchPendingFriendRequests(); } catch (_) {} }, 700);
            return;
          }
        } catch (_) {}

        // 3) sendBeacon fallback
        let succeeded = false;
        try {
          if (navigator.sendBeacon && window.addFriReq) {
            const params = new URLSearchParams();
            params.set('action', 'send');
            params.set('myUUID', myUUID);
            params.set('uuid', myUUID);
            if (myUsername) params.set('myUsername', myUsername);
            params.set('theirUsername', uname);
            params.set('username', uname);
            const beaconBody = new Blob([params.toString()], { type: 'application/x-www-form-urlencoded;charset=UTF-8' });
            succeeded = navigator.sendBeacon(window.addFriReq, beaconBody);
            if (succeeded) {
              if (addInput) addInput.value = '';
              showAlert(t ? t('friendRequestSent') : 'Friend request sent', 'success');
              setTimeout(() => { try { if (typeof fetchPendingFriendRequests === 'function') fetchPendingFriendRequests(); } catch (_) {} }, 700);
              return;
            }
          }
        } catch (_) {}

        if (!succeeded) {
          try {
            const url3 = new URL(window.addFriReq);
            url3.searchParams.set('action', 'send');
            url3.searchParams.set('myUUID', myUUID);
            url3.searchParams.set('uuid', myUUID);
            if (myUsername) url3.searchParams.set('myUsername', myUsername);
            url3.searchParams.set('theirUsername', uname);
            url3.searchParams.set('username', uname);
            const img = new Image();
            img.onload = function() {
              if (addInput) addInput.value = '';
              showAlert(t ? t('friendRequestSent') : 'Friend request sent', 'success');
              setTimeout(() => { try { if (typeof fetchPendingFriendRequests === 'function') fetchPendingFriendRequests(); } catch (_) {} }, 700);
            };
            img.onerror = function() {
              showAlert('Failed to send friend request: CORS blocked. See console/network for details.', 'error');
            };
            img.src = url3.toString();
            return;
          } catch (_) {
            // no-op
          }
        }

        showAlert('Failed to send friend request: ' + (e2 && e2.message ? e2.message : (lastErr && lastErr.message) || 'Unknown error'), 'error');
      }
    })();
  }

  function buildFriendItemHTML(username) {
    const avatarIndex = Math.abs(username.split('').reduce((acc, c) => acc + c.charCodeAt(0), 0) % 10);
    return `
      <div class="friend-item" data-username="${username}" style="display:flex;align-items:center;gap:12px;padding:10px 8px;border-bottom:1px solid rgba(255,255,255,0.06);">
        <img class="dm-avatar" src="https://i.pravatar.cc/150?img=${avatarIndex}" alt="Avatar">
        <div class="friend-meta" style="flex:1;min-width:0;">
          <div class="friend-name" style="font-weight:600;color:#e0e0ff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${username}</div>
        </div>
        <div class="friend-actions" style="display:flex;gap:6px;flex-shrink:0;">
          <button class="cosmic-btn secondary friend-msg-btn" data-username="${username}">💬 ${t ? t('message') : 'Message'}</button>
          <button class="cosmic-btn secondary friend-profile-btn" data-username="${username}">👤 ${t ? t('viewProfile') : 'Profile'}</button>
        </div>
      </div>`;
  }

  function loadFriendsPanels() {
    const container = document.getElementById('friendsPanelsContainer');
    if (!container) return;
    container.innerHTML = `
      <div class="settings-panel active" id="panel-friends-all">
        <div class="settings-section" style="padding:16px;">
          <input id="friendsSearchInput" type="text" placeholder="${t ? t('searchFriends') : 'Search friends...'}" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(124,191,255,0.2);background:rgba(255,255,255,0.05);color:#e5eaff;">
        </div>
        <div class="settings-section">
          <div id="friendsList" class="friends-list"></div>
        </div>
      </div>
      <div class="settings-panel" id="panel-friends-pending">
        <div class="settings-section">
          <div id="friendsPendingList">${t ? t('loading') : 'Loading...'}</div>
        </div>
      </div>
      <div class="settings-panel" id="panel-friends-add">
        <div class="settings-section">
          <label style="display:block;margin-bottom:8px;">${t ? t('enterUsername') : 'Enter username'}</label>
          <div style="display:flex;gap:8px;align-items:center;">
            <input id="friendsAddInput" type="text" placeholder="e.g. bluelol" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(124,191,255,0.2);background:rgba(255,255,255,0.05);color:#e5eaff;">
            <button id="friendsAddBtn" class="cosmic-btn">${t ? t('sendRequest') : 'Send Request'}</button>
          </div>
        </div>
      </div>`;

    // All
    const listEl = document.getElementById('friendsList');
    const friends = getFriendsList();
    if (!friends.length) listEl.innerHTML = `<div class="empty-state">${t ? t('noFriends') : 'No friends yet'}</div>`;
    else listEl.innerHTML = friends.map(buildFriendItemHTML).join('');
    listEl.querySelectorAll('.friend-msg-btn').forEach(btn => btn.addEventListener('click', e => {
      const u = e.currentTarget.getAttribute('data-username');
      if (u) openConversation(u, Math.abs(u.split('').reduce((a,c)=>a+c.charCodeAt(0),0)%10));
      hideFriendsView();
    }));
    listEl.querySelectorAll('.friend-profile-btn').forEach(btn => btn.addEventListener('click', e => {
      const u = e.currentTarget.getAttribute('data-username');
      if (typeof showUserProfileWrapper === 'function' && u) {
        showUserProfileWrapper(u, Math.abs(u.split('').reduce((a,c)=>a+c.charCodeAt(0),0)%10));
      }
    }));
    const searchInput = document.getElementById('friendsSearchInput');
    if (searchInput) {
      searchInput.addEventListener('input', function() {
        const term = this.value.toLowerCase();
        const filtered = getFriendsList().filter(u => u.toLowerCase().includes(term));
        listEl.innerHTML = filtered.length ? filtered.map(buildFriendItemHTML).join('') : `<div class="empty-state">${t ? t('noFriends') : 'No friends yet'}</div>`;
      });
    }

    // Pending
    (async () => {
      const pendingContainer = document.getElementById('friendsPendingList');
      if (!pendingContainer) return;
      const reqs = await fetchPendingFriendRequests();
      if (!reqs.length) { pendingContainer.innerHTML = `<div class="empty-state">${t ? t('noFriendRequests') : 'No pending friend requests'}</div>`; return; }
      pendingContainer.innerHTML = reqs.map(username => `
        <div class="pending-request">
          <img class="request-avatar" src="https://i.pravatar.cc/150?img=${Math.floor(Math.random()*10)}" alt="User Avatar">
          <div class="request-details">
            <span class="username">${username}</span>
            <span class="request-time">${new Date().toLocaleString()}</span>
          </div>
          <div class="request-actions">
            <button class="accept-button" data-username="${username}">${t ? t('accept') : 'Accept'}</button>
            <button class="decline-button" data-username="${username}">${t ? t('decline') : 'Decline'}</button>
          </div>
        </div>`).join('');
      pendingContainer.querySelectorAll('.accept-button').forEach(btn => btn.addEventListener('click', (e) => {
        e.stopPropagation(); const u = btn.getAttribute('data-username'); if (window.acceptFriendRequest) window.acceptFriendRequest(u);
      }));
      pendingContainer.querySelectorAll('.decline-button').forEach(btn => btn.addEventListener('click', (e) => {
        e.stopPropagation(); const u = btn.getAttribute('data-username'); if (window.declineFriendRequest) window.declineFriendRequest(u);
      }));
    })();

    // Add tab
    const addBtn = document.getElementById('friendsAddBtn');
    const addInput = document.getElementById('friendsAddInput');
    if (addBtn && addInput) {
      addBtn.addEventListener('click', () => sendFriendRequestIntegrated(addInput.value));
      addInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); sendFriendRequestIntegrated(addInput.value); } });
    }
  }

  function attachFriendsEventListeners(initialTab) {
    document.querySelectorAll('#friendsTabs .settings-tab').forEach(tab => {
      tab.addEventListener('click', function() {
        document.querySelectorAll('#friendsTabs .settings-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        const panel = this.dataset.panel; // friends-all | friends-pending | friends-add
        document.querySelectorAll('#friendsPanelsContainer .settings-panel').forEach(p => p.classList.remove('active'));
        const target = document.getElementById('panel-' + panel);
        if (target) target.classList.add('active');

        // When switching to Pending tab, refresh the data
        if (panel === 'friends-pending') {
          const pendingContainer = document.getElementById('friendsPendingList');
          if (pendingContainer) {
            pendingContainer.innerHTML = (typeof t === 'function' ? t('loading') : 'Loading...');
            fetchPendingFriendRequests().then(reqs => {
              if (!reqs || !reqs.length) {
                pendingContainer.innerHTML = `<div class="empty-state">${typeof t === 'function' ? t('noFriendRequests') : 'No pending friend requests'}</div>`;
                return;
              }
              pendingContainer.innerHTML = reqs.map(username => `
                <div class="pending-request">
                  <img class="request-avatar" src="https://i.pravatar.cc/150?img=${Math.floor(Math.random()*10)}" alt="User Avatar">
                  <div class="request-details">
                    <span class="username">${username}</span>
                    <span class="request-time">Just now</span>
                  </div>
                  <div class="request-actions">
                    <button class="accept-button" data-username="${username}">${typeof t === 'function' ? t('accept') : 'Accept'}</button>
                    <button class="decline-button" data-username="${username}">${typeof t === 'function' ? t('decline') : 'Decline'}</button>
                  </div>
                </div>`).join('');
              pendingContainer.querySelectorAll('.accept-button').forEach(btn => btn.addEventListener('click', (e) => {
                e.stopPropagation(); const u = btn.getAttribute('data-username'); if (window.acceptFriendRequest) window.acceptFriendRequest(u);
              }));
              pendingContainer.querySelectorAll('.decline-button').forEach(btn => btn.addEventListener('click', (e) => {
                e.stopPropagation(); const u = btn.getAttribute('data-username'); if (window.declineFriendRequest) window.declineFriendRequest(u);
              }));
            }).catch(() => {
              pendingContainer.innerHTML = `<div class="empty-state">${typeof t === 'function' ? t('noFriendRequests') : 'No pending friend requests'}</div>`;
            });
          }
        }
      });
    });
    const initial = initialTab || 'all';
    const initialBtn = document.querySelector(`#friendsTabs .settings-tab[data-panel="friends-${initial}"]`) || document.querySelector('#friendsTabs .settings-tab');
    if (initialBtn) initialBtn.click();
    const doneBtn = document.getElementById('friendsDoneBtn');
    if (doneBtn) doneBtn.addEventListener('click', (e) => { e.preventDefault(); hideFriendsView(); });
  }

  function showFriendsView(initialTab) {
    // ESC closes Friends view
    const friendsEsc = function(e) {
      if (e.key === 'Escape') {
        e.preventDefault();
        if (typeof hideFriendsView === 'function') hideFriendsView();
      }
    };
    try { document.removeEventListener('keydown', document.body._friendsEscHandler); } catch (_) {}
    document.body._friendsEscHandler = friendsEsc;
    document.addEventListener('keydown', friendsEsc);
    // If Settings view is open, close it first to switch to Friends
    try {
      const sHdr = document.getElementById('settingsHeader');
      const sArea = document.getElementById('settingsContentArea');
      if ((sHdr || sArea) && typeof hideSettingsSidebar === 'function') {
        hideSettingsSidebar();
      }
    } catch (_) {}
    document.body.classList.add('settings-mode');
    const chatContainer = document.getElementById('chatContainer');
    const chatTopbar = chatContainer ? chatContainer.querySelector('.chat-topbar') : null;
    const chatMessages = document.getElementById('chatMessages');
    const chatInputBar = document.querySelector('.chat-input-bar');
    const chatHomeView = document.getElementById('chatHomeView');
    const chatUserInfo = document.getElementById('chatUserInfo');
    [chatTopbar, chatHomeView, chatUserInfo, chatMessages, chatInputBar].forEach(el => { if (!el) return; el.dataset.prevDisplay = el.style.display || ''; el.style.display = 'none'; });
    if (!chatContainer) return;
    const existingHeader = document.getElementById('friendsHeader');
    const existingArea = document.getElementById('friendsContentArea');
    if (existingHeader) existingHeader.remove();
    if (existingArea) existingArea.remove();
    const friendsHeader = document.createElement('div');
    friendsHeader.id = 'friendsHeader';
    friendsHeader.className = 'settings-header';
    friendsHeader.innerHTML = `
      <div class="settings-header-content">
        <h1 class="settings-title">${t ? t('friends') : 'Friends'}</h1>
        <p class="settings-subtitle">${t ? t('friendsSubtitle') : 'Manage your friends'}</p>
      </div>
      <div class="settings-header-actions">
        <button id="friendsDoneBtn" class="cosmic-btn primary">${t ? t('done') : 'Done'}</button>
      </div>`;
    const friendsContentArea = document.createElement('div');
    friendsContentArea.id = 'friendsContentArea';
    friendsContentArea.className = 'settings-content-area';
    friendsContentArea.innerHTML = `
      <div class="settings-tabs-container">
        <div class="settings-tabs" id="friendsTabs">
          <button class="settings-tab" data-panel="friends-all"><i class="fas fa-users"></i><span>${t ? t('all') : 'All'}</span></button>
          <button class="settings-tab" data-panel="friends-pending"><i class="fas fa-inbox"></i><span>${t ? t('pending') : 'Pending'}</span></button>
          <button class="settings-tab" data-panel="friends-add"><i class="fas fa-user-plus"></i><span>${t ? t('add') : 'Add'}</span></button>
        </div>
      </div>
      <div class="settings-panels-container" id="friendsPanelsContainer"></div>`;
    const insertBeforeNode = chatMessages && chatMessages.parentNode === chatContainer ? chatMessages : (chatInputBar && chatInputBar.parentNode === chatContainer ? chatInputBar : null);
    if (insertBeforeNode) {
      chatContainer.insertBefore(friendsHeader, insertBeforeNode);
      chatContainer.insertBefore(friendsContentArea, insertBeforeNode);
    } else {
      chatContainer.appendChild(friendsHeader);
      chatContainer.appendChild(friendsContentArea);
    }
    loadFriendsPanels();
    attachFriendsEventListeners(initialTab);
  }

  function hideFriendsView() {
    document.body.classList.remove('settings-mode');
    // Clean up ESC handler
    if (document.body._friendsEscHandler) {
      document.removeEventListener('keydown', document.body._friendsEscHandler);
      document.body._friendsEscHandler = null;
    }
    const friendsHeader = document.getElementById('friendsHeader');
    const friendsContentArea = document.getElementById('friendsContentArea');
    if (friendsHeader) friendsHeader.remove();
    if (friendsContentArea) friendsContentArea.remove();
    const chatContainer = document.getElementById('chatContainer');
    const chatTopbar = chatContainer ? chatContainer.querySelector('.chat-topbar') : document.querySelector('.chat-topbar');
    const chatHomeView = document.getElementById('chatHomeView');
    const chatUserInfo = document.getElementById('chatUserInfo');
    const chatMessages = document.getElementById('chatMessages');
    const chatInputBar = document.querySelector('.chat-input-bar');
    [chatTopbar, chatHomeView, chatUserInfo, chatMessages, chatInputBar].forEach(el => {
      if (!el) return; const prev = el.dataset ? el.dataset.prevDisplay : undefined; el.style.display = typeof prev !== 'undefined' ? prev : ''; if (el.dataset && Object.prototype.hasOwnProperty.call(el.dataset, 'prevDisplay')) delete el.dataset.prevDisplay;
    });
  }
  window.showFriendsView = showFriendsView;
  window.hideFriendsView = hideFriendsView;

  // Handle DM clicks with event delegation
  function handleDMClickWithDelegation(e) {
    const dmUser = e.target.closest('.dm-user');
    if (dmUser && !dmUser.classList.contains('active')) {
      // Call the original DM click handler with the correct context
      if (typeof handleDMClick === 'function') {
        // Pass the event to handleDMClick which will handle both direct and delegated calls
        handleDMClick.call(dmUser, e);
      }
      
      // Update current screen state when clicking a DM
      window.currentScreen = 'dm';
      updateHomeButtonState();
      
      // Ensure proper view state
      const chatHomeView = document.getElementById('chatHomeView');
      const chatUserInfo = document.getElementById('chatUserInfo');
      if (chatHomeView) chatHomeView.style.display = 'none';
      if (chatUserInfo) chatUserInfo.style.display = 'flex';
    }
  }

  function reinitializeSidebar() {
    // Re-attach settings button handler
    const newSettingsBtn = document.getElementById('openUserSettingsBtn');
    if (newSettingsBtn) {
      newSettingsBtn.removeEventListener('click', showSettingsSidebar);
      newSettingsBtn.addEventListener('click', showSettingsSidebar);
    }
    
    // Use event delegation for DM items to handle dynamic content
    const dmList = document.querySelector('.dm-list');
    if (dmList) {
      // Remove any existing delegated handlers to prevent duplicates
      dmList.removeEventListener('click', handleDMClickWithDelegation);
      // Add new delegated handler
      dmList.addEventListener('click', handleDMClickWithDelegation);
    }
    
    // Re-attach sidebar footer click handler
    const sidebarFooter = document.querySelector('.sidebar-footer-clickable');
    if (sidebarFooter) {
      sidebarFooter.removeEventListener('click', openSelfProfile);
      sidebarFooter.addEventListener('click', openSelfProfile);
    }
    
    // Re-initialize search bar functionality
    const searchInput = document.getElementById('dmSearchInput');
    if (searchInput) {
      searchInput.removeEventListener('input', handleSearchInput);
      searchInput.addEventListener('input', handleSearchInput);
    }
    
    // Re-attach home button handler
    const homeButton = document.getElementById('homeButton');
    if (homeButton) {
      // Remove any existing event listeners
      homeButton.replaceWith(homeButton.cloneNode(true));
      const newHomeButton = document.getElementById('homeButton');
      
      // Initialize required functions if not defined
      if (typeof handleDMClick !== 'function') {
        console.warn('handleDMClick function not found - DM functionality may be limited');
        window.handleDMClick = function() {};
      }

      if (typeof updateHomeButtonState !== 'function') {
        console.warn('updateHomeButtonState function not found - UI state may be inconsistent');
        console.log('Attempting to fix...');
        setTimeout(() => {
          console.log('Fixed!');
        }, 1000);
        window.updateHomeButtonState = function() {
          const homeButton = document.getElementById('homeButton');
          if (homeButton) {
            homeButton.disabled = window.currentScreen === 'home';
          }
        };
      }

      // Initialize current user data if not already set
      updateHomeButtonState();
      
      newHomeButton.addEventListener('click', function() {
        if (window.currentScreen === 'home') return;
        window.currentScreen = 'home';
        updateHomeButtonState();
        showHomeView();
        // Only fetch pending count if logged in and uuid is available
        if (window.currentUserData && window.currentUserData.isLoggedIn && window.currentUserData.uuid) {
          if (typeof fetchAndUpdatePendingCount === 'function') {
            fetchAndUpdatePendingCount(window.currentUserData.uuid);
          } else if (typeof updatePendingCount === 'function') {
            updatePendingCount(0);
          }
        } else {
          console.warn('[HomeButton] Not logged in or missing UUID, not fetching pending requests.');
        }
      });
      
      // Initial state
      updateHomeButtonState();
    }
    
    // Re-initialize any other sidebar functionality
    if (typeof attachDMUserMenus === 'function') {
      attachDMUserMenus();
    }
    
    // Re-attach any other global event listeners
    document.dispatchEvent(new Event('sidebarReinitialized'));
  }
  
  // Search input handler
function handleSearchInput(e) {
  const searchTerm = e.target.value.toLowerCase();
  const dmItems = document.querySelectorAll('.dm-user');
    
  dmItems.forEach(item => {
    const username = item.getAttribute('data-username') || '';
    if (username.toLowerCase().includes(searchTerm)) {
      item.style.display = 'flex';
    } else {
      item.style.display = 'none';
    }
  });
}
  
  // Helper function to handle DM clicks
function handleDMClick(e) {
  // If called directly (not as event handler), get the element from the event
  const target = e && e.target ? e.target.closest('.dm-user') : this;
  const username = target.getAttribute('data-username');
  const avatarIndex = target.getAttribute('data-avatar-index');
  if (username) {
    openConversation(username, avatarIndex);
  }
}

const settingsBtn = document.getElementById('openUserSettingsBtn');

if (settingsBtn) {
  settingsBtn.addEventListener('click', function(e) {
    e.preventDefault();
    showSettingsSidebar();
  });
}

// Language translations
const translations = {
  en: {
    // Main Navigation & Interface
    home: 'Home',
    directMessages: 'Direct Messages',
    friendRequests: 'Friend Requests',
    addFriend: 'Add Friend',
    pending: 'Pending',
    
    // Home View
    welcomeMessage: 'Welcome to TFG Messenger',
    selectConversation: 'Select a conversation to start messaging',
    noMessages: 'No messages yet',
    
    // Chat Interface
    searchPlaceholder: 'Search for or start a conversation',
    typeMessage: 'Type a message...',
    send: 'Send',
    
    // Friend System
    friends: 'Friends',
    friendsSubtitle: 'Manage your friends',
    all: 'All',
    searchFriends: 'Search friends...',
    sendRequest: 'Send Request',
    message: 'Message',
    viewProfile: 'View Profile',
    noFriends: 'No friends yet',
    addFriendTitle: 'Add Friend',
    enterUsername: 'Enter username',
    cancel: 'Cancel',
    add: 'Add',
    accept: 'Accept',
    decline: 'Decline',
    friendRequestSent: 'Friend request sent',
    friendRequestReceived: 'Friend request from',
    noFriendRequests: 'No pending friend requests',
    
    // Settings
    settings: 'Settings',
    settingsSubtitle: 'Customize your experience',
    done: 'Done',
    
    // Account Tab
    account: 'Account',
    accountInfo: 'Account Information',
    username: 'Username',
    email: 'Email',
    accountStatus: 'Account Status',
    active: 'Active',
    inactive: 'Inactive',
    accountActions: 'Account Actions',
    changePassword: 'Change Password',
    deleteAccount: 'Delete Account',
    
    // Profile Tab
    profile: 'Profile',
    bio: 'Bio',
    saveChanges: 'Save Changes',
    saved: 'Saved!',
    
    // Privacy Tab
    privacy: 'Privacy',
    privacySettings: 'Privacy Settings',
    showOnlineStatus: 'Show online status',
    allowDMs: 'Allow direct messages from anyone',
    showReadReceipts: 'Show read receipts',
    blockedUsers: 'Blocked Users',
    manageBlocked: 'Manage users you\'ve blocked',
    viewBlockedUsers: 'View Blocked Users',
    
    // Appearance Tab
    appearance: 'Appearance',
    theme: 'Theme',
    themeDefault: 'Default',
    themeDark: 'Dark',
    themeLight: 'Light',
    displaySettings: 'Display Settings',
    compactMode: 'Compact mode',
    showAnimations: 'Show animations',
    
    // Notifications Tab
    notifications: 'Notifications',
    messageNotifications: 'Message Notifications',
    enableDesktopNotifications: 'Enable desktop notifications',
    soundNotifications: 'Sound notifications',
    showMessagePreviews: 'Show message previews',
    friendRequestNotifications: 'Friend Request Notifications',
    notifyFriendRequests: 'Notify on friend requests',
    
    // Language Tab
    language: 'Language',
    interfaceLanguage: 'Interface Language',
    
    // Login/Register
    login: 'Log In',
    register: 'Register',
    logout: 'Log Out',
    
    // Common
    loading: 'Loading...',
    notLoggedIn: 'Not logged in',
    noEmailSet: 'No email set',
    show: 'Show',
    hide: 'Hide',
    close: 'Close',
    confirm: 'Confirm',
    error: 'Error',
    success: 'Success'
  },
  es: {
    // Main Navigation & Interface
    home: 'Inicio',
    directMessages: 'Mensajes Directos',
    friendRequests: 'Solicitudes de Amistad',
    addFriend: 'Añadir Amigo',
    pending: 'Pendiente',
    
    // Home View
    welcomeMessage: 'Bienvenido a TFG Messenger',
    selectConversation: 'Selecciona una conversación para empezar a chatear',
    noMessages: 'Sin mensajes aún',
    
    // Chat Interface
    searchPlaceholder: 'Buscar o iniciar una conversación',
    typeMessage: 'Escribe un mensaje...',
    send: 'Enviar',
    
    // Friend System
    friends: 'Amigos',
    friendsSubtitle: 'Administra tus amigos',
    all: 'Todos',
    searchFriends: 'Buscar amigos...',
    sendRequest: 'Enviar solicitud',
    message: 'Mensaje',
    viewProfile: 'Ver perfil',
    noFriends: 'Aún no tienes amigos',
    addFriendTitle: 'Añadir Amigo',
    enterUsername: 'Ingresa nombre de usuario',
    cancel: 'Cancelar',
    add: 'Añadir',
    accept: 'Aceptar',
    decline: 'Rechazar',
    friendRequestSent: 'Solicitud de amistad enviada',
    friendRequestReceived: 'Solicitud de amistad de',
    noFriendRequests: 'No hay solicitudes pendientes',
    
    // Settings
    settings: 'Configuración',
    settingsSubtitle: 'Personaliza tu experiencia',
    done: 'Listo',
    
    // Account Tab
    account: 'Cuenta',
    accountInfo: 'Información de la Cuenta',
    username: 'Nombre de Usuario',
    email: 'Correo Electrónico',
    accountStatus: 'Estado de la Cuenta',
    active: 'Activo',
    inactive: 'Inactivo',
    accountActions: 'Acciones de Cuenta',
    changePassword: 'Cambiar Contraseña',
    deleteAccount: 'Eliminar Cuenta',
    
    // Profile Tab
    profile: 'Perfil',
    bio: 'Biografía',
    saveChanges: 'Guardar Cambios',
    saved: '¡Guardado!',
    
    // Privacy Tab
    privacy: 'Privacidad',
    privacySettings: 'Configuración de Privacidad',
    showOnlineStatus: 'Mostrar estado en línea',
    allowDMs: 'Permitir mensajes directos de cualquiera',
    showReadReceipts: 'Mostrar confirmaciones de lectura',
    blockedUsers: 'Usuarios Bloqueados',
    manageBlocked: 'Administrar usuarios bloqueados',
    viewBlockedUsers: 'Ver Usuarios Bloqueados',
    
    // Appearance Tab
    appearance: 'Apariencia',
    theme: 'Tema',
    themeDefault: 'Predeterminado',
    themeDark: 'Oscuro',
    themeLight: 'Claro',
    displaySettings: 'Configuración de Pantalla',
    compactMode: 'Modo compacto',
    showAnimations: 'Mostrar animaciones',
    
    // Notifications Tab
    notifications: 'Notificaciones',
    messageNotifications: 'Notificaciones de Mensajes',
    enableDesktopNotifications: 'Habilitar notificaciones de escritorio',
    soundNotifications: 'Notificaciones de sonido',
    showMessagePreviews: 'Mostrar vistas previas de mensajes',
    friendRequestNotifications: 'Notificaciones de Solicitudes de Amistad',
    notifyFriendRequests: 'Notificar sobre solicitudes de amistad',
    
    // Language Tab
    language: 'Idioma',
    interfaceLanguage: 'Idioma de la Interfaz',
    
    // Login/Register
    login: 'Iniciar Sesión',
    register: 'Registrarse',
    logout: 'Cerrar Sesión',
    
    // Common
    loading: 'Cargando...',
    notLoggedIn: 'No conectado',
    noEmailSet: 'Sin correo',
    show: 'Mostrar',
    hide: 'Ocultar',
    close: 'Cerrar',
    confirm: 'Confirmar',
    error: 'Error',
    success: 'Éxito'
  },
  fr: {
    // Main Navigation & Interface
    home: 'Accueil',
    directMessages: 'Messages Directs',
    friendRequests: 'Demandes d\'Ami',
    addFriend: 'Ajouter un Ami',
    pending: 'En attente',
    
    // Home View
    welcomeMessage: 'Bienvenue sur TFG Messenger',
    selectConversation: 'Sélectionnez une conversation pour commencer',
    noMessages: 'Pas encore de messages',
    
    // Chat Interface
    searchPlaceholder: 'Rechercher ou démarrer une conversation',
    typeMessage: 'Tapez un message...',
    send: 'Envoyer',
    
    // Friend System
    friends: 'Amis',
    friendsSubtitle: 'Gérez vos amis',
    all: 'Tous',
    searchFriends: 'Rechercher des amis...',
    sendRequest: 'Envoyer la demande',
    message: 'Message',
    viewProfile: 'Voir le profil',
    noFriends: 'Pas encore d\'amis',
    addFriendTitle: 'Ajouter un Ami',
    enterUsername: 'Entrez le nom d\'utilisateur',
    cancel: 'Annuler',
    add: 'Ajouter',
    accept: 'Accepter',
    decline: 'Refuser',
    friendRequestSent: 'Demande d\'ami envoyée',
    friendRequestReceived: 'Demande d\'ami de',
    noFriendRequests: 'Aucune demande en attente',
    
    // Settings
    settings: 'Paramètres',
    settingsSubtitle: 'Personnalisez votre expérience',
    done: 'Terminé',
    
    // Account Tab
    account: 'Compte',
    accountInfo: 'Informations du Compte',
    username: 'Nom d\'utilisateur',
    email: 'Email',
    accountStatus: 'Statut du Compte',
    active: 'Actif',
    inactive: 'Inactif',
    accountActions: 'Actions du Compte',
    changePassword: 'Changer le Mot de Passe',
    deleteAccount: 'Supprimer le Compte',
    
    // Profile Tab
    profile: 'Profil',
    bio: 'Biographie',
    saveChanges: 'Sauvegarder',
    saved: 'Sauvegardé!',
    
    // Privacy Tab
    privacy: 'Confidentialité',
    privacySettings: 'Paramètres de Confidentialité',
    showOnlineStatus: 'Afficher le statut en ligne',
    allowDMs: 'Autoriser les messages directs de tout le monde',
    showReadReceipts: 'Afficher les accusés de lecture',
    blockedUsers: 'Utilisateurs Bloqués',
    manageBlocked: 'Gérer les utilisateurs bloqués',
    viewBlockedUsers: 'Voir les Utilisateurs Bloqués',
    
    // Appearance Tab
    appearance: 'Apparence',
    theme: 'Thème',
    themeDefault: 'Par défaut',
    themeDark: 'Sombre',
    themeLight: 'Clair',
    displaySettings: 'Paramètres d\'Affichage',
    compactMode: 'Mode compact',
    showAnimations: 'Afficher les animations',
    
    // Notifications Tab
    notifications: 'Notifications',
    messageNotifications: 'Notifications de Messages',
    enableDesktopNotifications: 'Activer les notifications de bureau',
    soundNotifications: 'Notifications sonores',
    showMessagePreviews: 'Afficher les aperçus de messages',
    friendRequestNotifications: 'Notifications de Demandes d\'Ami',
    notifyFriendRequests: 'Notifier les demandes d\'ami',
    
    // Language Tab
    language: 'Langue',
    interfaceLanguage: 'Langue de l\'Interface',
    
    // Login/Register
    login: 'Se Connecter',
    register: 'S\'inscrire',
    logout: 'Se Déconnecter',
    
    // Common
    loading: 'Chargement...',
    notLoggedIn: 'Non connecté',
    noEmailSet: 'Pas d\'email',
    show: 'Afficher',
    hide: 'Masquer',
    close: 'Fermer',
    confirm: 'Confirmer',
    error: 'Erreur',
    success: 'Succès'
  },
  de: {
    // Main Navigation & Interface
    home: 'Startseite',
    directMessages: 'Direktnachrichten',
    friendRequests: 'Freundschaftsanfragen',
    addFriend: 'Freund Hinzufügen',
    pending: 'Ausstehend',
    
    // Home View
    welcomeMessage: 'Willkommen bei TFG Messenger',
    selectConversation: 'Wählen Sie eine Konversation aus, um zu beginnen',
    noMessages: 'Noch keine Nachrichten',
    
    // Chat Interface
    searchPlaceholder: 'Suchen oder Konversation starten',
    typeMessage: 'Nachricht eingeben...',
    send: 'Senden',
    
    // Friend System
    friends: 'Freunde',
    friendsSubtitle: 'Verwalte deine Freunde',
    all: 'Alle',
    searchFriends: 'Freunde suchen...',
    sendRequest: 'Anfrage senden',
    message: 'Nachricht',
    viewProfile: 'Profil anzeigen',
    noFriends: 'Noch keine Freunde',
    addFriendTitle: 'Freund Hinzufügen',
    enterUsername: 'Benutzername eingeben',
    cancel: 'Abbrechen',
    add: 'Hinzufügen',
    accept: 'Akzeptieren',
    decline: 'Ablehnen',
    friendRequestSent: 'Freundschaftsanfrage gesendet',
    friendRequestReceived: 'Freundschaftsanfrage von',
    noFriendRequests: 'Keine ausstehenden Anfragen',
    
    // Settings
    settings: 'Einstellungen',
    settingsSubtitle: 'Passen Sie Ihre Erfahrung an',
    done: 'Fertig',
    
    // Account Tab
    account: 'Konto',
    accountInfo: 'Kontoinformationen',
    username: 'Benutzername',
    email: 'E-Mail',
    accountStatus: 'Kontostatus',
    active: 'Aktiv',
    inactive: 'Inaktiv',
    accountActions: 'Kontoaktionen',
    changePassword: 'Passwort Ändern',
    deleteAccount: 'Konto Löschen',
    
    // Profile Tab
    profile: 'Profil',
    bio: 'Biografie',
    saveChanges: 'Änderungen Speichern',
    saved: 'Gespeichert!',
    
    // Privacy Tab
    privacy: 'Privatsphäre',
    privacySettings: 'Privatsphäre-Einstellungen',
    showOnlineStatus: 'Online-Status anzeigen',
    allowDMs: 'Direktnachrichten von jedem zulassen',
    showReadReceipts: 'Lesebestätigungen anzeigen',
    blockedUsers: 'Blockierte Benutzer',
    manageBlocked: 'Blockierte Benutzer verwalten',
    viewBlockedUsers: 'Blockierte Benutzer Anzeigen',
    
    // Appearance Tab
    appearance: 'Aussehen',
    theme: 'Thema',
    themeDefault: 'Standard',
    themeDark: 'Dunkel',
    themeLight: 'Hell',
    displaySettings: 'Anzeigeeinstellungen',
    compactMode: 'Kompaktmodus',
    showAnimations: 'Animationen anzeigen',
    
    // Notifications Tab
    notifications: 'Benachrichtigungen',
    messageNotifications: 'Nachrichtenbenachrichtigungen',
    enableDesktopNotifications: 'Desktop-Benachrichtigungen aktivieren',
    soundNotifications: 'Ton-Benachrichtigungen',
    showMessagePreviews: 'Nachrichtenvorschauen anzeigen',
    friendRequestNotifications: 'Freundschaftsanfragen-Benachrichtigungen',
    notifyFriendRequests: 'Über Freundschaftsanfragen benachrichtigen',
    
    // Language Tab
    language: 'Sprache',
    interfaceLanguage: 'Sprache der Benutzeroberfläche',
    
    // Login/Register
    login: 'Anmelden',
    register: 'Registrieren',
    logout: 'Abmelden',
    
    // Common
    loading: 'Wird geladen...',
    notLoggedIn: 'Nicht angemeldet',
    noEmailSet: 'Keine E-Mail',
    show: 'Anzeigen',
    hide: 'Verstecken',
    close: 'Schließen',
    confirm: 'Bestätigen',
    error: 'Fehler',
    success: 'Erfolg'
  }
};

// Current language
let currentLanguage = localStorage.getItem('language') || 'en';

// Function to get translated text
function t(key) {
  return translations[currentLanguage]?.[key] || translations['en'][key] || key;
}

// Function to update all translatable elements
function updateLanguage(langCode) {
  currentLanguage = langCode;
  localStorage.setItem('language', langCode);
  
  // Update main interface elements
  updateMainInterfaceLanguage();
  
  // Update settings panel if open
  if (document.body.classList.contains('settings-mode')) {
    updateSettingsLanguage();
  }
  
  console.log('Language updated to:', langCode);
}

// Update main interface (sidebar, buttons, placeholders, etc.)
function updateMainInterfaceLanguage() {
  // Update search placeholder
  const searchInput = document.getElementById('dmSearchInput');
  if (searchInput) {
    searchInput.placeholder = t('searchPlaceholder');
  }
  
  // Update home button (if it has text)
  const homeButton = document.getElementById('homeButton');
  if (homeButton && homeButton.title) {
    homeButton.title = t('home');
  }
  
  // Update chat input placeholder
  const chatInput = document.getElementById('chatInput');
  if (chatInput) {
    chatInput.placeholder = t('typeMessage');
  }
  
  // Update home view message
  const homeTitle = document.querySelector('#chatHomeView h2');
  if (homeTitle && homeTitle.textContent.includes('Welcome')) {
    homeTitle.textContent = t('welcomeMessage');
  }
  
  const homeSubtitle = document.querySelector('#chatHomeView p');
  if (homeSubtitle && homeSubtitle.textContent.includes('Select a conversation')) {
    homeSubtitle.textContent = t('selectConversation');
  }
}

// Update settings panel language
function updateSettingsLanguage() {
  // Update settings header
  const settingsTitle = document.querySelector('.settings-title');
  const settingsSubtitle = document.querySelector('.settings-subtitle');
  if (settingsTitle) settingsTitle.textContent = t('settings');
  if (settingsSubtitle) settingsSubtitle.textContent = t('settingsSubtitle');
  
  // Update Done button
  const doneBtn = document.getElementById('settingsDoneBtn');
  if (doneBtn) {
    const btnText = doneBtn.querySelector('span') || doneBtn.childNodes[doneBtn.childNodes.length - 1];
    if (btnText && btnText.nodeType === 3) {
      btnText.textContent = t('done');
    }
  }
  
  // Update tab labels
  document.querySelectorAll('.settings-tab').forEach(tab => {
    const span = tab.querySelector('span');
    if (span) {
      const panelId = tab.dataset.panel;
      span.textContent = t(panelId);
    }
  });
  
  // Update all panel content
  updateAccountPanelLanguage();
  updateProfilePanelLanguage();
  updatePrivacyPanelLanguage();
  updateAppearancePanelLanguage();
  updateNotificationsPanelLanguage();
  updateLanguagePanelLanguage();
}

function updateAccountPanelLanguage() {
  const panel = document.getElementById('panel-account');
  if (!panel) return;
  
  // Update section titles and labels
  const headers = panel.querySelectorAll('h3');
  if (headers[0]) headers[0].textContent = t('accountInfo');
  if (headers[1]) headers[1].textContent = t('accountActions');
  
  // Update labels
  const labels = panel.querySelectorAll('.setting-item label');
  if (labels[0]) labels[0].textContent = t('username');
  if (labels[1]) labels[1].textContent = t('email');
  if (labels[2]) labels[2].textContent = t('accountStatus');
  
  // Update buttons
  const changePassBtn = panel.querySelector('.cosmic-btn.danger');
  const deleteAccBtn = panel.querySelector('.cosmic-btn.warning');
  if (changePassBtn) changePassBtn.textContent = t('changePassword');
  if (deleteAccBtn) deleteAccBtn.textContent = t('deleteAccount');
}

function updateProfilePanelLanguage() {
  const panel = document.getElementById('panel-profile');
  if (!panel) return;
  
  const dnLabel = panel.querySelector('#displayNameLabel');
  if (dnLabel) dnLabel.textContent = t ? t('displayName') : 'Display Name';
  const aboutLabel = panel.querySelector('#aboutMeLabel');
  if (aboutLabel) {
    const labelText = aboutLabel.childNodes[0];
    if (labelText && labelText.nodeType === 3) {
      labelText.textContent = t ? t('aboutMe') : 'About Me';
    }
  }
  
  const saveBtn = panel.querySelector('button[type="submit"]');
  if (saveBtn) saveBtn.textContent = t('saveChanges');
}

function updatePrivacyPanelLanguage() {
  const panel = document.getElementById('panel-privacy');
  if (!panel) return;
  
  const headers = panel.querySelectorAll('h3');
  if (headers[0]) headers[0].textContent = t('privacySettings');
  if (headers[1]) headers[1].textContent = t('blockedUsers');
  
  const labels = panel.querySelectorAll('.setting-toggle label');
  if (labels[0]) labels[0].textContent = t('showOnlineStatus');
  if (labels[1]) labels[1].textContent = t('allowDMs');
  if (labels[2]) labels[2].textContent = t('showReadReceipts');
  
  const paragraph = panel.querySelector('p');
  if (paragraph) paragraph.textContent = t('manageBlocked');
  
  const viewBtn = panel.querySelector('.cosmic-btn.secondary');
  if (viewBtn) viewBtn.textContent = t('viewBlockedUsers');
}

function updateAppearancePanelLanguage() {
  const panel = document.getElementById('panel-appearance');
  if (!panel) return;
  
  const headers = panel.querySelectorAll('h3');
  if (headers[0]) headers[0].textContent = t('theme');
  if (headers[1]) headers[1].textContent = t('displaySettings');
  
  const themeOptions = panel.querySelectorAll('.theme-option span');
  if (themeOptions[0]) themeOptions[0].textContent = t('themeDefault');
  if (themeOptions[1]) themeOptions[1].textContent = t('themeDark');
  if (themeOptions[2]) themeOptions[2].textContent = t('themeLight');
  
  const labels = panel.querySelectorAll('.setting-toggle label');
  if (labels[0]) labels[0].textContent = t('compactMode');
  if (labels[1]) labels[1].textContent = t('showAnimations');
}

function updateNotificationsPanelLanguage() {
  const panel = document.getElementById('panel-notifications');
  if (!panel) return;
  
  const headers = panel.querySelectorAll('h3');
  if (headers[0]) headers[0].textContent = t('messageNotifications');
  if (headers[1]) headers[1].textContent = t('friendRequestNotifications');
  
  const labels = panel.querySelectorAll('.setting-toggle label');
  if (labels[0]) labels[0].textContent = t('enableDesktopNotifications');
  if (labels[1]) labels[1].textContent = t('soundNotifications');
  if (labels[2]) labels[2].textContent = t('showMessagePreviews');
  if (labels[3]) labels[3].textContent = t('notifyFriendRequests');
}

function updateLanguagePanelLanguage() {
  const panel = document.getElementById('panel-language');
  if (!panel) return;
  
  const header = panel.querySelector('h3');
  if (header) header.textContent = t('interfaceLanguage');
}

// Make functions globally available
window.updateLanguage = updateLanguage;
window.updateMainInterfaceLanguage = updateMainInterfaceLanguage;
window.t = t;

})();

// Show logout alert and login screen if user just logged out
window.onload = function() {
  if (localStorage.getItem('justLoggedOut') === '1') {
    localStorage.removeItem('justLoggedOut');
    if (typeof showLogin === 'function') showLogin();
    if (typeof showAlert === 'function') showAlert("You have been logged out.", 'success');
  }
  
  // Apply saved language on page load
  const savedLang = localStorage.getItem('language') || 'en';
  currentLanguage = savedLang;
  
  // Wait a bit for DOM elements to be ready
  setTimeout(() => {
    updateMainInterfaceLanguage();
  }, 500);
};

    // Enhanced branding visibility manager
    (function() {
      'use strict';
      
      const BRANDING_SELECTOR = '.company-logo';
      const CHECK_INTERVAL = 1000;
      let brandingObserver = null;
      let domObserver = null;
      let checkInterval = null;
      
      // Function to ensure branding is visible and styled correctly
      function ensureBrandingVisible() {
        const branding = document.querySelector(BRANDING_SELECTOR);
        if (!branding) return false;
        
        // Only proceed if the branding is not already visible
        const isVisible = window.getComputedStyle(branding).display !== 'none' &&
                        window.getComputedStyle(branding).visibility !== 'hidden' &&
                        parseFloat(window.getComputedStyle(branding).opacity) > 0;
        
        if (!isVisible) {
          branding.style.display = 'flex';
          branding.style.visibility = 'visible';
          branding.style.opacity = '1';
        }
        
        // Ensure no outline on logo image
        const logoImg = branding.querySelector('img');
        if (logoImg) {
          logoImg.style.outline = 'none';
          logoImg.style.border = 'none';
          logoImg.style.boxShadow = 'none';
        }
        
        return true;
      }
      
      // Set up mutation observer to watch for changes to the branding element
      function setupBrandingObserver() {
        if (brandingObserver) brandingObserver.disconnect();
        
        const branding = document.querySelector(BRANDING_SELECTOR);
        if (!branding) return;
        
        brandingObserver = new MutationObserver(function(mutations) {
          const shouldUpdate = mutations.some(mutation => 
            mutation.type === 'attributes' && 
            ['style', 'class', 'id'].includes(mutation.attributeName)
          );
          
          if (shouldUpdate) {
            requestAnimationFrame(ensureBrandingVisible);
          }
        });
        
        brandingObserver.observe(branding, {
          attributes: true,
          attributeFilter: ['style', 'class', 'id'],
          childList: false,
          subtree: true
        });
      }
      
      // Set up DOM observer to watch for when the branding element is added
      function setupDOMObserver() {
        if (domObserver) domObserver.disconnect();
        
        domObserver = new MutationObserver(function(mutations) {
          for (const mutation of mutations) {
            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
              const hasBranding = Array.from(mutation.addedNodes).some(node => 
                node.matches && (node.matches(BRANDING_SELECTOR) || node.querySelector(BRANDING_SELECTOR))
              );
              
              if (hasBranding) {
                setupBrandingObserver();
                ensureBrandingVisible();
                break;
              }
            }
          }
        });
        
        // Start observing the document with the configured parameters
        domObserver.observe(document.body, {
          childList: true,
          subtree: true
        });
      }
      
      // Initialize everything when DOM is ready
      function init() {
        // Initial check
        const brandingExists = ensureBrandingVisible();
        
        // Set up observers
        if (brandingExists) {
          setupBrandingObserver();
        }
        setupDOMObserver();
        
        // Periodic check as fallback
        if (checkInterval) clearInterval(checkInterval);
        checkInterval = setInterval(ensureBrandingVisible, CHECK_INTERVAL);
      }
      
      // Start when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
      
      // Cleanup
      window.addEventListener('beforeunload', function() {
        if (brandingObserver) brandingObserver.disconnect();
        if (domObserver) domObserver.disconnect();
        if (checkInterval) clearInterval(checkInterval);
      });
    })();

    // Ensure info popup is properly hidden on page load
    document.addEventListener('DOMContentLoaded', function() {
      const infoOverlay = document.getElementById('infoPopupOverlay');
      if (infoOverlay) {
        infoOverlay.style.display = 'none';
        infoOverlay.style.pointerEvents = 'none';
        infoOverlay.setAttribute('aria-hidden', 'true');
        infoOverlay.style.zIndex = '-1';
      }
    });

    // Function to check if CosmicParticles is loaded
    function isCosmicParticlesLoaded() {
      const isLoaded = typeof window.CosmicParticles === 'function';
      console.log('[TFG] CosmicParticles loaded:', isLoaded);
      return isLoaded;
    }
    
    // Function to initialize cosmic particles with retry logic
    function initCosmicParticles(attempt = 0) {
      const MAX_ATTEMPTS = 5;
      const RETRY_DELAY = 500; // ms
      
      console.log(`[TFG] Attempting to initialize particle system (attempt ${attempt + 1}/${MAX_ATTEMPTS})...`);
      
      // Make sure the container exists
      let container = document.getElementById('cosmicParticles');
      if (!container) {
        container = document.createElement('div');
        container.id = 'cosmicParticles';
        container.className = 'cosmic-particles';
        container.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          pointer-events: none;
          z-index: 1;
          opacity: 0;
          display: block;
          transition: opacity 1s ease-in-out;
        `;
        document.body.insertBefore(container, document.body.firstChild);
      }
      
      // Check if CosmicParticles is available
      if (isCosmicParticlesLoaded()) {
        try {
          // Destroy existing instance if it exists
          if (window.cosmicParticles && typeof window.cosmicParticles.destroy === 'function') {
            window.cosmicParticles.destroy();
          }
          
          // Create new instance
          window.cosmicParticles = new window.CosmicParticles('cosmicParticles', {
            particleCount: 150,
            minSize: 1,
            maxSize: 3,
            baseSpeed: 0.08,
            colors: [
              'rgba(138, 79, 255, 0.8)',
              'rgba(0, 191, 255, 0.8)',
              'rgba(255, 107, 255, 0.8)',
              'rgba(0, 255, 204, 0.8)',
              'rgba(255, 255, 255, 0.9)'
            ]
          });
          
          // Fade in the particles
          setTimeout(() => {
            container.style.opacity = '0.9';
          }, 100);
          
          return true;
          
        } catch (error) {
          console.error('[TFG] Error initializing particles:', error);
          if (attempt < MAX_ATTEMPTS - 1) {
            console.log(`[TFG] Retrying in ${RETRY_DELAY}ms...`);
            setTimeout(() => initCosmicParticles(attempt + 1), RETRY_DELAY);
          } else {
            console.error('[TFG] Max retry attempts reached, giving up');
          }
          return false;
        }
      } else if (attempt < MAX_ATTEMPTS - 1) {
        console.log(`[TFG] CosmicParticles not loaded yet, retrying in ${RETRY_DELAY}ms...`);
        setTimeout(() => initCosmicParticles(attempt + 1), RETRY_DELAY);
        return false;
      } else {
        console.error('[TFG] Failed to load CosmicParticles after max attempts');
        // Try one last time after a short delay
        if (attempt < MAX_ATTEMPTS + 2) {
          console.log('[TFG] Making one final attempt... if it fails, I give up man :(');
          setTimeout(initCosmicParticles, 1000);
        }
        return false;
      }
    }
    
    // Wait for the DOM to be fully loaded and scripts to be ready
    function initializeWhenReady() {
      if (isCosmicParticlesLoaded()) {
        initCosmicParticles();
      } else {
        setTimeout(initializeWhenReady, 100);
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(initializeWhenReady, 100);
      });
    } else {
      setTimeout(initializeWhenReady, 100);
    }
 

</script>
<script src="./lib/interface/Banned%20Screen/bannedScreen.js?v=1.1"></script>
<script src="./lib/interface/Banned%20Screen/banGuard.js?v=1.1"></script>
<script src="./lib/ww/background.js?v=1.1"></script>
<script src="./lib/ww/dom.js?v=1.1"></script>
<script src="./lib/ww/gas.js?v=1.1"></script>
<script src="./lib/ww/wl.js?v=1.1"></script>
<script src="./lib/ww/formTransitions.js?v=1.1"></script>
<script src="./lib/ww/input-animations.js?v=1.1"></script>
<script src="./lib/interface/Global%20Alerts/globalAlerts.js?v=1.1"></script>
<script src="./lib/ww/log.js?v=1.1"></script>
<script src="./lib/reg/A.A.C.A.R/A.A.C.A.R-UC.js?v=1.1"></script>
<script src="./lib/reg/A.A.C.A.R/A.A.C.A.R-GC.js?v=1.1"></script>
<script src="./lib/reg/A.A.C.A.R/A.A.C.A.R-VC.js?v=1.1"></script>
<script src="./lib/ww/validator.js?v=1.1"></script>
<script src="./lib/reg/A.A.C.A.R/A.A.C.A.R-AR.js?v=1.1"></script>
<script src="./lib/reg/A.A.C.A.R/A.A.C.A.R-PC.js?v=1.1"></script>
<script src="./lib/reg/loading-ani.js?v=1.1"></script>
<script src="./lib/reg/form-validations.js?v=1.1"></script>
<script src="./lib/log-in/Login-ani.js?v=1.1"></script>
<script src="./lib/reg/verification-handler.js?v=1.1"></script>
<script src="./lib/reg/A.A.C.A.R/A.A.C.A.R-VC.js?v=1.1"></script>
<script src="./lib/log-in/L.D.A-PC.js?v=1.1"></script>
<script src="./lib/interface/Context%20Menu/CustomContextMenu.js?v=1.1"></script>
<script src="./lib/interface/User%20Profiles/UserProfile.js?v=1.1"></script>
<script src="./lib/interface/Home%20Screen/HomeScreen.js?v=1.1"></script>
<script src="./lib/ww/cosmicParticles.js?v=1.1"></script>
<script src="./lib/ww/background.js?v=1.1"></script>
<script src="./lib/log-in/LoginAnimator.js?v=1.1"></script>
  </body>
</html>